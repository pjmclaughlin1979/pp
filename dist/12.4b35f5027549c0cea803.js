(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/3d/layers/SceneLayerWorker":1472,"esri/views/3d/webgl-engine/lib/HighlightSet":1551,"esri/views/3d/layers/support/attributeUtils":1596,"esri/views/3d/layers/i3s/I3SGeometryUtil":1651,"esri/views/3d/layers/i3s/I3SProjectionUtil":1652,"esri/views/3d/layers/I3SMeshView3D":1705,"esri/layers/graphics/controllers/I3SOnDemandController":1706,"esri/views/3d/layers/i3s/I3SFrameTask":1707,"esri/views/3d/layers/i3s/I3SIndex":1708,"esri/views/3d/layers/i3s/I3SLodHandling":1709,"esri/views/3d/layers/i3s/I3SNodeLoader":1710,"esri/views/3d/layers/i3s/I3SViewportQueries":1711,"esri/views/3d/webgl-engine/materials/component/Parameters":1793,"esri/views/3d/webgl-engine/materials/component/VertexBufferLayout":1794,"esri/views/3d/layers/i3s/Highlights":2242,"esri/views/3d/layers/i3s/I3SElevationProvider":2243,"esri/views/3d/layers/i3s/IDBCache":2244,"esri/views/3d/webgl-engine/materials/component/index":2245,"esri/views/3d/webgl-engine/materials/component/ComponentMaterial":2246,"esri/views/3d/webgl-engine/materials/component/ComponentGLMaterial":2247,"esri/views/3d/webgl-engine/materials/internal/TextureBinding":2248,"esri/views/3d/webgl-engine/materials/renderers/PreinterleavedRenderer":2249})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{1472:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(9),r(18),r(15),r(362),r(1543),r(4),r(3),r(34),r(374),r(1651),r(1652),r(1523),r(51),r(578),r(16)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h,p,f,m,g){var y=function(){function e(){}return e.prototype.process=function(e){var t=[e.geometryBuffer],i=this.transform(e,t);return r.resolve({result:i,transferList:t})},e.prototype.transform=function(e,t){var r=d.fromJSON(e.indexSR),n=d.fromJSON(e.vertexSR),a=d.fromJSON(e.renderSR),o=e.geometryBuffer,l=h.computeGlobalTransformation(e.mbs,e.elevationOffset,r,a);i.mat4.invert(v,l);var y=e.obb?null:p.create([0,0,0],[-1,-1,-1],[0,0,0,1]);s.vec3.copy(_,e.mbs),_[2]+=e.elevationOffset,s.vec3.copy(b,_);for(var x=!1,w=0,C=[],I=0,S=e.geometryData;I<S.length;I++)for(var D=S[I],M=D.geometries,O=D.componentOffsets,N=0,E=M;N<E.length;N++){var P=E[N],T=e.layouts[w];++w;var L=[{name:g.VertexAttrConstants.COLOR,byteValue:255}],A=[g.VertexAttrConstants.NORMAL,g.VertexAttrConstants.NORMALCOMPRESSED,g.VertexAttrConstants.SYMBOLCOLOR,g.VertexAttrConstants.COMPONENTINDEX],V=c.interleaveGeometryBuffer(P,o,T,L,A),R=new m(new Float32Array(V),T),j=R.getAttribute(g.VertexAttrConstants.POSITION),B=e.mbs,F=e.elevationOffset;if(h.reprojectPoints(j,B,v,F,r,n,a),y&&this._updateObb(y,j,l),e.needNormals){var G={normals:R.getAttribute(g.VertexAttrConstants.NORMALCOMPRESSED),positions:j,normalInd:R.getIndices(g.VertexAttrConstants.NORMALCOMPRESSED),positionInd:R.getIndices(g.VertexAttrConstants.POSITION)},U=e.normalReferenceFrame;c.processAndInterleaveNormals(U,P,o,l,G)}var k=R.getAttribute(g.VertexAttrConstants.COMPONENTINDEX);k&&this._createComponentNumbers(k,O);var q=R.getAttribute(g.VertexAttrConstants.COLOR);q&&!x&&(x=this._hasColors(q));var z={globalTrafo:l},H=T[0].stride,Q=1-.8*H/(H+4),Y=u.default(V,H/4,null,Q);if(null!=Y){var W=Y.uniqueCount<65536?new Uint16Array(Y.indices):Y.indices,K=c.extractPositionData(Y.buffer,T,W);C.push({layout:T,interleavedVertexData:Y.buffer,indices:W,corMatrices:z,hasColors:x,positionData:K}),t&&(t.push(Y.buffer),t.push(W.buffer),t.push(K.data.buffer),t.push(K.indices.buffer))}else{K=c.extractPositionData(V,T);C.push({layout:T,interleavedVertexData:V,corMatrices:z,hasColors:x,positionData:K}),t&&(t.push(V),t.push(K.data.buffer),t.push(K.indices.buffer))}}return y&&(s.vec3.transformMat4(y.center,y.center,l),f.vectorToVector(y.center,a,y.center,r),y.center[2]-=e.elevationOffset),{geometryBuffer:o,transformedGeometries:C,obb:y}},e.prototype._hasColors=function(e){for(var t=e.data,r=e.size,i=e.offsetIdx,n=e.strideIdx,a=i;a<t.length;a+=n)for(var o=0;o<r;o++)if(255!==t[a+o])return!0;return!1},e.prototype._createComponentNumbers=function(e,t){for(var r=e.data,i=e.offsetIdx,n=e.strideIdx,a=r.length/n,o=0,s=i,l=0;l<a;l++)l>=t[o+1]&&o++,r[s]=o,s+=n},e.prototype._updateObb=function(e,t,r){if(e.halfSize[0]>0){s.vec3.subtract(_,e.center,e.halfSize),s.vec3.add(b,e.center,e.halfSize);for(var i=t.offsetIdx;i<t.data.length;i+=t.strideIdx)_[0]=Math.min(_[0],t.data[i]),_[1]=Math.min(_[1],t.data[i+1]),_[2]=Math.min(_[2],t.data[i+2]),b[0]=Math.max(b[0],t.data[i]),b[1]=Math.max(b[1],t.data[i+1]),b[2]=Math.max(b[2],t.data[i+2]);s.vec3.subtract(e.halfSize,b,_),s.vec3.scale(e.halfSize,e.halfSize,.5),s.vec3.add(e.center,_,b),s.vec3.scale(e.center,e.center,.5)}else{p.compute(t,e);var n=2*Math.sqrt(1+r[0]+r[5]+r[10]);x[0]=(r[9]-r[6])/n,x[1]=(r[2]-r[8])/n,x[2]=(r[4]-r[1])/n,x[3]=.25*n,a.quat.conjugate(x,x),a.quat.multiply(e.quaternion,x,e.quaternion)}},e}(),v=n.mat4f64.create(),_=l.vec3f64.create(),b=l.vec3f64.create(),x=o.quatf32.create();return y}.apply(null,i))||(e.exports=n)},1551:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){return function(){function e(){this.items=[]}return e.prototype.addObject=function(e,t){this.items.push({type:"object",highlightId:t,object:e})},e.prototype.addRenderGeometry=function(e,t,r){this.items.push({type:"renderGeometry",highlightId:t,renderGeometry:e,owner:r})},e.prototype.addExternal=function(e,t){this.items.push({type:"external",highlightId:t,remove:e})},e.prototype.remove=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];r.highlightId===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeObject=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"object"===r.type&&r.object===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeRenderGeometry=function(e){for(var t=this.items.length-1;t>=0;--t){var r=this.items[t];"renderGeometry"===r.type&&r.renderGeometry===e&&(this.removeHighlight(r),this.items.splice(t,1))}},e.prototype.removeAll=function(){var e=this;this.items.forEach(function(t){e.removeHighlight(t)}),this.items=[]},e.prototype.removeHighlight=function(e){switch(e.type){case"object":e.object.removeHighlights(e.highlightId);break;case"renderGeometry":e.owner.removeRenderGeometryHighlight(e.renderGeometry,e.highlightId);break;case"external":e.remove(e.highlightId)}},e}()}.apply(null,i))||(e.exports=n)},1596:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var a=n[i];if(a.toLowerCase()===r)return e[a]}return null}}.apply(null,i))||(e.exports=n)},1651:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(9),r(212),r(4),r(262),r(45),r(374),r(1530),r(51),r(16)],void 0===(n=function(e,t,i,n,a,o,s,l,d,u,c){function h(e,t,r,i,n,a,o){switch(r){case 1:for(var s=0;s<o;s++)i[n]=e[t],t+=1,n+=a;break;case 2:for(s=0;s<o;s++)i[n]=e[t],i[n+1]=e[t+1],t+=2,n+=a;break;case 3:for(s=0;s<o;s++)i[n]=e[t],i[n+1]=e[t+1],i[n+2]=e[t+2],t+=3,n+=a;break;case 4:for(s=0;s<o;s++)i[n]=e[t],i[n+1]=e[t+1],i[n+2]=e[t+2],i[n+3]=e[t+3],t+=4,n+=a;break;default:throw v("Unhandled stride size "+r)}}function p(e,t,r,i,n,a){switch(t){case 1:for(var o=0;o<a;o++)r[i]=e,i+=n;break;case 2:for(o=0;o<a;o++)r[i]=e,r[i+1]=e,i+=n;break;case 3:for(o=0;o<a;o++)r[i]=e,r[i+1]=e,r[i+2]=e,i+=n;break;case 4:for(o=0;o<a;o++)r[i]=e,r[i+1]=e,r[i+2]=e,r[i+3]=e,i+=n;break;default:throw v("Unhandled stride size "+t)}}function f(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function m(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function g(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function y(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function v(e){return new Error("I3SGeometryUtil processing failed: "+e)}function _(e){var t=e.normals,r=e.positions,i=e.normalInd,s=e.positionInd;c.assert(e.normalInd.length===e.positionInd.length);for(var l=o.vec3f32.create(),d=o.vec3f32.create(),u=n.vec2f32.create(),h=r.data,p=r.offsetIdx,f=r.strideIdx,m=t.data,g=t.offsetIdx,y=t.strideIdx,v=0;v<s.length;v+=3){var _=s[v],b=p+f*_,x=h[b],w=h[b+1],C=h[b+2];b=p+f*(_=s[v+1]),l[0]=h[b]-x,l[1]=h[b+1]-w,l[2]=h[b+2]-C,b=p+f*(_=s[v+2]),d[0]=h[b]-x,d[1]=h[b+1]-w,d[2]=h[b+2]-C,a.vec3.cross(l,l,d),c.encodeNormal(l,u);for(var I=0;I<3;I++){var S=g+y*i[v+I];m[S]=c.encodeInt16(u[0]),m[S+1]=c.encodeInt16(u[1])}}}function b(e,t){switch(t){case 0:switch(e.type){case"intersects":case"contains":case"crosses":case"envelope-intersects":case"overlaps":case"touches":case"within":return 1;case"disjoint":return 0}break;case 2:switch(e.type){case"intersects":case"contains":case"envelope-intersects":case"within":return 0;case"disjoint":case"crosses":case"overlaps":case"touches":return 1}break;case 1:switch(e.type){case"envelope-intersects":return 0}}return 2}function x(e,t){return C.contains(e.mask,t)?2:C.intersects(e.mask,t)?1:0}Object.defineProperty(t,"__esModule",{value:!0});var w=new Uint8Array(64);t.interleaveGeometryBuffer=function(e,t,r,i,n){void 0===i&&(i=[]),void 0===n&&(n=[]);var a=e.params.vertexAttributes,o=a.position.count;if(!y(r[0].stride))throw v("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");for(var s=r[0].stride/Uint32Array.BYTES_PER_ELEMENT,l=new Uint32Array(s*o),d=0,u=r=r.slice(0).sort(function(e,t){return e.offset-t.offset});d<u.length;d++)!function(e){if(-1!==n.indexOf(e.name))return"continue";var r=a[e.name],s=f(e.type),d=void 0,u=!1;if(null==r){var c=i.filter(function(t){return t.name===e.name})[0];if(!c)throw v("Geometry definition is missing attribute");r={valueType:m(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var _=0;_<w.length;_++)w[_]=c.byteValue;d=w.buffer,u=!0}else d=t;if(m(e.type)!==r.valueType)throw v("Geometry definition type must match attribute type");if(!g(r.byteOffset)||!g(e.offset))throw v(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!y(r.valuesPerElement*s.BYTES_PER_ELEMENT)||!y(e.count*s.BYTES_PER_ELEMENT))throw v(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var b=new Uint32Array(d),x=r.byteOffset/Uint32Array.BYTES_PER_ELEMENT,C=r.valuesPerElement*s.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,I=e.offset/Uint32Array.BYTES_PER_ELEMENT,S=e.stride/Uint32Array.BYTES_PER_ELEMENT;u?p(b[0],C,l,I,S,o):h(b,x,C,l,I,S,o)}(u[d]);return l.buffer},t.processAndInterleaveNormals=function(e,t,r,i,n){if("none"===e)_(n);else{var a=d.createTypedView(r,t.params.vertexAttributes.normal),o="earth-centered"===e?i:null;!function(e,t,r){var i=e.length/3,n=t.data,a=t.offsetIdx,o=t.strideIdx;if(null!=r)for(var s=r,l=s[0],d=s[1],u=s[2],h=s[4],p=s[5],f=s[6],m=s[8],g=s[9],y=s[10],v=0;v<i;v++){var _=e[3*v],b=e[3*v+1],x=e[3*v+2];M[0]=l*_+d*b+u*x,M[1]=h*_+p*b+f*x,M[2]=m*_+g*b+y*x,c.encodeNormal(M,O),n[a+v*o]=c.encodeInt16(O[0]),n[a+v*o+1]=c.encodeInt16(O[1])}else for(var v=0;v<i;v++)M[0]=e[3*v],M[1]=e[3*v+1],M[2]=e[3*v+2],c.encodeNormal(M,O),n[a+v*o]=c.encodeInt16(O[0]),n[a+v*o+1]=c.encodeInt16(O[1])}(a,n.normals,o)}};var C,I=65536;t.extractPositionData=function(e,t,r){var i=t[0];if(null==i||"position"!==i.name||5126!==i.type)return null;for(var n=new Float32Array(e),a=i.stride/4,o=i.offset/4,s=3*n.length/a,d=new Float32Array(s),u=0;u<s/3;u++)d[3*u]=n[u*a+o],d[3*u+1]=n[u*a+o+1],d[3*u+2]=n[u*a+o+2];var c=l.default(d.buffer,3,r);return c.uniqueCount<I?{data:new Float32Array(c.buffer),indices:new Uint16Array(c.indices)}:{data:new Float32Array(c.buffer),indices:c.indices}},t.loadGeometryEngine=function(){return null!=C?i.resolve():i.create(function(e,t){return Promise.resolve().then(function(){var t=[r(176)];e.apply(null,t)}.bind(this)).catch(r.oe)}).then(function(e){return C=e})},t.acquireMaskFilterContext=function(e,t,r,i){var n=r.spatialReference||t.spatialReference,a=t.renderSpatialReference,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:n};o.rings[0][4]=o.rings[0][0];var s=i.objectTransformation,l=i.getGeometryRecords()[0].geometry,d={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:n};d.rings[0][3]=d.rings[0][0];var u=C[e];return u||(console.error("Spatial relationship",e,"not supported"),u=function(){return!0}),{type:e,mask:r,maskSR:n,renderSR:a,aabb:o,transform:s,geometry:l,triangle:d,testFunction:u}},t.getIntersectRelation=b,t.intersectMaskWithMbs=function(e,t){var r={x:t[0],y:t[1],hasZ:!1,hasM:!1,type:"point",spatialReference:e.maskSR};return x(e,C.buffer(r,t[3],1,!0))};var S=Math.pow(2,-32);t.filterMask=function(e,t){var r=t.type,i=t.mask,n=t.transform,o=t.renderSR,s=t.maskSR,l=t.geometry,d=t.triangle,h=t.testFunction,p=t.aabb;l.getComponentAABB(e,D);var f=[p.rings[0][0],p.rings[0][1],p.rings[0][2],p.rings[0][3]];a.vec3.set(f[0],D[0],D[1],0),a.vec3.set(f[1],D[0],D[4],0),a.vec3.set(f[2],D[3],D[4],0),a.vec3.set(f[3],D[3],D[1],0);for(var m=0;m<4;++m)a.vec3.transformMat4(f[m],f[m],n),u.vectorToVector(f[m],o,f[m],s);switch(delete p._geVersion,b(t,x(t,p))){case 1:return!1;case 0:return!0}var g,y=d.rings[0][0],v=d.rings[0][1],_=d.rings[0][2],w=l.data.getIndices(c.VertexAttrConstants.POSITION),C=l.data.componentOffsets,I=l.data.getAttribute(c.VertexAttrConstants.POSITION),M=I.data,O=I.offsetIdx,N=I.strideIdx,E=C.length?C[e]:0,P=C.length?C[e+1]:w.length;switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":g=function(){return h(i,d)?0:2};break;case"contains":case"disjoint":case"within":default:g=function(){return h(i,d)?2:1}}for(m=E;m<P;m+=3){var T=O+N*w[m+0],L=O+N*w[m+1],A=O+N*w[m+2];a.vec3.set(y,M[T+0],M[T+1],M[T+2]),a.vec3.set(v,M[L+0],M[L+1],M[L+2]),a.vec3.set(_,M[A+0],M[A+1],M[A+2]),a.vec3.transformMat4(y,y,n),a.vec3.transformMat4(v,v,n),a.vec3.transformMat4(_,_,n),u.vectorToVector(y,o,y,s),u.vectorToVector(v,o,v,s),u.vectorToVector(_,o,_,s);var V=v[0]-y[0],R=v[1]-y[1],j=_[0]-y[0],B=_[1]-y[1];if(!(Math.abs(V*B-R*j)<S))switch(delete d._geVersion,g()){case 1:return!1;case 0:return!0}}switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":return!1;case"contains":case"disjoint":case"within":default:return!0}};var D=s.create(),M=o.vec3f32.create(),O=n.vec2f32.create()}.apply(null,i))||(e.exports=n)},1652:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(15),r(4),r(3),r(49),r(51),r(276)],void 0===(n=function(e,t,r,i,n,a,o,s){function l(e,t,r){var i,o,s,l=n.vec3f64.create(),d=e[3],u=Math.ceil(Math.log(d)*Math.LOG2E/p),c=Math.pow(2,u*p+h);if(r.isGeographic){var f=c/a.earthRadius*180/Math.PI;o=Math.round(e[1]/f);var m=Math.max(-90,Math.min(90,o*f)),g=f/Math.cos((Math.abs(m)-f/2)/180*Math.PI),y=(i=Math.round(e[0]/g))*g;l[0]=y,l[1]=m}else i=Math.round(e[0]/c),o=Math.round(e[1]/c),l[0]=i*c,l[1]=o*c;var v=e[2]+t;return s=Math.round(v/c),l[2]=s*c,{center:l,id:u+"_"+i+"_"+o+"_"+s}}Object.defineProperty(t,"__esModule",{value:!0});var d=1e3,u=new Float64Array(3*d),c=n.vec3f64.create();t.computeGlobalTransformation=function(e,t,i,n){var a=l(e,t,i).center,s=r.mat4f64.create();return o.computeLinearTransformation(i,a,s,n),s},t.reprojectPoints=function(e,t,r,n,a,s,l){var h=e.data,p=e.offsetIdx,f=e.strideIdx;i.vec3.copy(c,t),c[2]+=n;var m=[0,0,0],g=h.length/f;o.vectorToVector(c,a,m,s);for(var y=0;y<g;y+=d){for(var v=Math.min(d,g-y),_=0;_<v;_++){var b=p+f*(y+_);u[3*_+0]=h[b+0]+m[0],u[3*_+1]=h[b+1]+m[1],u[3*_+2]=h[b+2]+m[2]}for(o.bufferToBuffer(u,s,0,u,l,0,v),_=0;_<v;_++){var x=u[3*_+0],w=u[3*_+1],C=u[3*_+2],I=p+f*(y+_);h[I+0]=r[0]*x+r[4]*w+r[8]*C+r[12],h[I+1]=r[1]*x+r[5]*w+r[9]*C+r[13],h[I+2]=r[2]*x+r[6]*w+r[10]*C+r[14]}}},t.createOrigin=function(e,t,r,i){var n=l(e,t,r),a=n.center,d=n.id;return o.vectorToVector(a,r,a,i),s.fromVector(a,d)};var h=1,p=5-h}.apply(null,i))||(e.exports=n)},1705:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11),r(2),r(1),r(22),r(25),r(99),r(20),r(79),r(52),r(97),r(26),r(48),r(1503),r(19),r(179),r(7),r(10),r(32),r(209),r(9),r(356),r(57),r(108),r(82),r(21),r(355),r(0),r(15),r(4),r(3),r(45),r(1706),r(142),r(379),r(1472),r(72),r(2242),r(2243),r(1652),r(1516),r(2244),r(1596),r(405),r(1514),r(607),r(12),r(1523),r(51),r(101),r(85),r(86),r(368),r(120),r(578),r(136),r(16),r(603),r(2245),r.dj.m(e)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h,p,f,m,g,y,v,_,b,x,w,C,I,S,D,M,O,N,E,P,T,L,A,V,R,j,B,F,G,U,k,q,z,H,Q,Y,W,K,J,X,Z,$,ee,te,re,ie,ne,ae,oe){function se(e){return I.isArrayBuffer(e.data)}function le(e,t){for(var r=1024,i=0,n=e;i<n.length;i++){var a=n[i];r+=a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0),r+=a.positionData.data.byteLength+a.positionData.indices.byteLength}for(var o=0,s=t;o<s.length;o++){var l=s[o];I.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function de(e,t){return!(t.byteSize>ye&&(he.warn("Node is too big to store in IndexedDB cache: "+e.baseUrl+" ("+t.byteSize+" bytes)"),1))}function ue(e,t){return(0|e)+(0|t)|0}Object.defineProperty(t,"__esModule",{value:!0});var ce=X.ModelContentType,he=v.getLogger("esri.views.3d.layers.SceneLayerView3D"),pe=[1,1,1,1],fe=[.8,.8,.8],me=function(){return function(){}}(),ge=11,ye=104857600,ve=function(t){function l(){var e=null!==t&&t.apply(this,arguments)||this;return e._layerUid="",e._highlights=new B(e),e._elevationProvider=null,e._worker=new R,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new k.IDBCache("esri-scenelayer-cache","geometries",ge),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._cacheKeySuffix=null,e._tmpAttributeOnlyGraphic=new d(null,null,{}),e}return i(l,t),Object.defineProperty(l.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"rendererNeedsTextures",{get:function(){return U.rendererNeedsTextures(this._currentRenderer)},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=S.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=V.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!m("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),l.prototype.initialize=function(){var t=this;if(M.open(w.getAbsMid("./SceneLayerWorker",e,oe)).then(function(e){t.destroyed?e.close():t._workerThread=e}),U.checkSceneLayerValid(this.layer),U.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUid=this.layer.uid,this._controller=new L({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.view.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new F({layerView:this,stageLayer:this._stageLayer}),this.handles.add([D.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),D.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),D.watch(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),D.watch(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),D.init(this,"filter",function(){return t._filterChange()}),D.watch(this,["rendererNeedsTextures","uncompressedTextureDownsamplingEnabled"],function(){t._reloadAll(),t._memCache.clear()}),D.init(this,"suspended",function(e){return t._suspendedChange(e)})],"sceneLayerHandles"),m("disable-feature:single-idb-cache")&&(this._idbCache=new k.IDBCache("esri-scenelayer-cache-v"+ge,"geometries",ge)),this._idbCache.init().catch(function(e){he.warn("Failed to initialize IndexedDB cache: "+e)}),this._cacheKeySuffix=U.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._componentColorManager=this._hasSymbolColors?new ne.BufferManager(this._stage.view.renderingContext):null},l.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},l.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},l.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},l.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},l.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},l.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e.id)},l.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},l.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},l.prototype.ignoresMemoryFactor=function(){return!1},l.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)},l.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},l.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;var i=""+this.layer.uid,n=new $(i,{},i);this._stageLayer=n,e.add(ce.LAYER,n),this._stage.addToViewContent([n.id])},l.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;this._removeAllNodeDataFromStage(),ie.verify(0===this._nodeId2Meta.size),e.remove(ce.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},l.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e.id);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},l.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e.id);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},l.prototype.setAttributeData=function(e,t){var r=this._nodeId2Meta.get(e.id);r&&(r.attributeInfo=t,r.cachedRendererVersion=this._getInvalidRendererVersion(),r.filteredIds=null,this._updateEngineObject(r))},l.prototype.getLoadedNodeIDs=function(){return u.keysOfMap(this._nodeId2Meta)},l.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){if(this._isIntegratedMesh)return{forceTransparency:!1};var i=this.fullOpacity,n=1-Y.clamp(ie.fallbackIfUndefined(t.transparency,0),0,1);return{baseColorOpacity:n,layerOpacity:i,forceTransparency:!!(n<1||i<1||e&&y.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r)}},l.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},l.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},l.prototype._getMaterialParameters=function(e,t,i){var n=t.params,a=ie.fallbackIfUndefined(n.diffuse,fe);"standard"!==t.type&&he.warn("Unknown material type '"+t.type+"', must be 'standard'");var o=this._isIntegratedMesh,s=this._calcEngineMaterialTransparencyParams(e,n);return r({baseColor:a,baseColorTexture:i,doubleSidedShading:this._calcEngineMaterialDoubleSidedParams(n),cullFace:this._calcEngineMaterialCullFaceParams(n),writeStencil:o,receiveSSAO:!o,normals:o?"ground":"vertex"},s)},l.prototype._getGeometryParameters=function(e,t){return{textureCoordinates:null!=e,textureCoordinateRegions:t.params.vertexRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":"compressed"}},l.prototype._createTexture=function(e,t,r,i,n){if(null==t)return null;var a=function(e,t){for(var r=0,i=e;r<i.length;r++){var n=i[r];if(n.i3sTexId===t)return n.data}return null}(i,r);if(null==a)return null;var o,s=null==t?null:this._getI3STexEncoding(t),l="none"!==t.wrap[0]||"none"!==t.wrap[1],d="rgba"===t.channels,u=!0;if(s===U.DDS_ENCODING_STRING)o=re.DDS_ENCODING;else{var c=a;u=Y.isPowerOfTwo(c.width)&&Y.isPowerOfTwo(c.height)}var h=n||!0===t.atlas,p=(h?this._enableAtlasMipMaps:this._enableMipMaps)&&u,f=h||!l,m=h&&p&&this._disableAtlasAnisotropy,g=new re(a,r,{mipmap:p,wrap:f?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:m,encoding:o,noUnpackFlip:!0,components:d?4:3});return this._stage.add(ce.TEXTURE,g),e.memory+=this.memEstimateTextureAdded(g),g},l.prototype._createEngineMaterial=function(e,t,r,i,n,a){var o=i.params.vertexRegions,s=null!=t?this._createTexture(e,t,r,a,o):null,l=this._getMaterialParameters(t,i,s&&s.id),d=this._getGeometryParameters(t,i),u=ae.ComponentMaterial.create(l,d,n);return u.metadata={i3sTex:t,i3sMatParams:i.params,engineTex:s},u},l.prototype._getI3STexEncoding=function(e){var t=U.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures);return t>-1?e.encoding[t]:e.encoding},l.prototype._getVertexBufferLayout=function(e,t){var r=e.params.materialID,i=t.materialDefinitions[r];ie.assert(void 0!==i,"geometry wants unknown material "+r);var n,a=e.params.textureID||"none";return"none"!==a&&(null!=t.textureDefinitions&&null!=t.textureDefinitions[a]||he.warn("textureDefinitions missing in shared resource"),n=t.textureDefinitions[a]),J.glLayout(ae.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(n,i)))},l.prototype._createEngineMat=function(e,t,r,i){var n=t.params.materialID,a=r.materialDefinitions[n];ie.assert(void 0!==a,"geometry wants unknown material "+n);var o,s=t.params.textureID||"none";return"none"!==s&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[s]||he.warn("textureDefinitions missing in shared resource"),o=r.textureDefinitions[s]),this._createEngineMaterial(e,o,s,a,n,i)},l.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},l.prototype._findGraphicNodeAndIndex=function(e){var t=q.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return g.everyMap(this._nodeId2Meta,function(e,i){var n=e.featureIds.indexOf(t);return-1===n||(r={node:e.node,index:n},!1)}),r},l.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.id);if(!r)return[];for(var i=[],n=this._getObjectIdField(),a=0,o=t;a<o.length;a++){var s=o[a],l=q.attributeLookup(s.attributes,n),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},l.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return x.reject();var r=this._nodeId2Meta.get(t.node.id).engineObject,i=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(K.bufferToBuffer(i,this.view.renderSpatialReference,0,i,this.view.spatialReference,0,8)){var n=T.empty();return T.expandWithBuffer(n,i,0,8),x.resolve({boundingBox:n,screenSpaceObjects:[]})}},l.prototype.whenGraphicAttributes=function(e,t){var r=this;return U.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,function(e){for(var t=new Map,i=[],n=0,a=e;n<a.length;n++){var o=a[n],s=r._findGraphicNodeAndIndex(o),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l)),l.indices.push(s.index),l.graphics.push(o)}return i},{ignoreUnavailableFields:!0,populateObjectId:!0})},l.prototype.getGraphicFromStageObject=function(e,t){if(this._isIntegratedMesh)return null;var r=this._getMetadata(e),i=e.getComponentFromTriangleNr(0,t);return null!=i&&null!=r.featureIds&&i<r.featureIds.length?this._createGraphic(i,r):null},l.prototype.hasStageObject=function(e){var t=e.getMetadata(),r=this._nodeId2Meta.get(t.i3sNode);return r&&r.engineObject===e},l.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.i3sNode)},l.prototype._getCacheKey=function(e){return e.baseUrl+this._cacheKeySuffix},l.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},l.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},l.prototype.additionalCancelNodeLoadingHandler=function(){this._cancelCount=ue(this._cancelCount,1)},l.prototype._handleCancelled=function(e){if(ue(this._cancelCount,-e)>0)throw new s},l.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.id))},l.prototype.loadCachedNodeData=function(e,t){var r=this,i=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(n){if(null==n)return null;if(r._handleCancelled(i),n.nodeVersion!==e.version)return r._idbCache.remove(r._getCacheKey(e)),null;e.obb||(e.obb=W.clone(n.nodeObb),r._controller.updateVisibility(e.id));return r.rendererNeedsTextures&&n.textureData.some(function(e){if(null==e.data)return!0;var t=n.sharedResource.textureDefinitions[e.i3sTexId],i=r._getI3STexEncoding(t);return e.encoding!==i})?t(n.allGeometryData,n.sharedResource).then(function(t){return n.textureData=t,n.byteSize=le(n.transformedGeometries,n.textureData),t.every(se)&&de(e,n)&&r._idbCache.put(r._getCacheKey(e),n).catch(function(t){t&&"indexedb:not-initialized"===t.name||he.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(i),n}):n}):x.resolve(null)},l.prototype.addNodeData=function(e,t){var i=this;return this._addData(e,t.attributeDataInfo,function(){return i._transformBundle(e,t).then(function(t){return i._controller.reschedule(e.id,t)}).then(function(n){e.obb||(e.obb=n.obb,i._controller.updateVisibility(e.id));var a={allGeometryData:t.allGeometryData,transformedGeometries:n.transformedGeometries,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:i._cachingEnabled()?le(n.transformedGeometries,t.textureData):0};if(de(e,a)&&a.byteSize>0){var o=a.textureData.map(function(e){return se(e)?e:{i3sTexId:e.i3sTexId,encoding:e.encoding,data:null}});i._idbCache.put(i._getCacheKey(e),r({},a,{textureData:o})).catch(function(t){return he.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return i._addCachedNodeData(e,a)})})},l.prototype._transformBundle=function(e,t){for(var r=this,i=[],n=[t.geometryBuffer],a=0,o=t.allGeometryData;a<o.length;a++)for(var s=0,l=o[a].geometries;s<l.length;s++){var d=l[s];i.push(this._getVertexBufferLayout(d,t.sharedResource))}var u={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData,layouts:i,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",u,{transferList:n}):this._controller.reschedule(e.id,u).then(function(e){return r._worker.transform(e)})},l.prototype.addCachedGPUData=function(e,t){if(this._controller.isGeometryVisible(e)){this._nodeId2Meta.set(e.id,t),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1);for(var r=0,i=t.engineObject.getGeometryRecords();r<i.length;r++)i[r].material.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled});this._updateEngineObject(t),this._highlights.objectCreated(t.engineObject)}else this._memCache.put(this._getMemCacheKey(e.id),t,e.memory)},l.prototype.addCachedNodeData=function(e,t,r){var i=this;return this._addData(e,r,function(){return i._addCachedNodeData(e,t)})},l.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return x.resolve();var i=t.allGeometryData,n=t.transformedGeometries,a=t.textureData,o=t.sharedResource;if(0===i.length)return x.resolve();if(1!==i.length&&console.warn("Node with",i.length,"geometries is unsupported"),!this.rendererNeedsTextures)for(var s=0,l=a;s<l.length;s++){l[s].data=null}var d={};d[ce.OBJECT]={},d[ce.GEOMETRY]={},d[ce.MATERIAL]={};var u=0,c=!1;e.memory=0;var h=i[0],p=h.componentOffsets,f=h.geometries,m=h.featureIds,g=null,y=null;if(this._hasSymbolColors){g=this._componentColorManager.getBuffer(m.length),y=new Uint16Array(m.length);for(var v=0;v<m.length;v++)y[v]=g.aquireIndex()}for(var _,b=e.id+"|"+m[0],w=[],C=[],I=[],S=new Array,D=this.view,M=0,O=f;M<O.length;M++){var E=O[M],P=this._createEngineMat(e,E,o,a),T=n[u++];_=T.corMatrices.globalTrafo,c=c||T.hasColors;var L=new te(new Float32Array(T.interleavedVertexData),T.layout,T.positionData,p||te.DefaultOffsets,T.indices||te.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(L,y);var A=null!=E.transformation?N.mat4f64.clone(E.transformation):_e,V=w.length,R=new Z(L,b+(V>0?"_"+V:"")),j=D.renderSpatialReference;w.push(R),I.push(A),S.push(P);var B=G.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,j);C.push(B),e.memory+=this.memEstimateGeometryAdded(R.data),d[ce.MATERIAL][P.id]=P,d[ce.GEOMETRY][R.id]=R}var F={i3sNode:e.id,layerUid:this._layerUid},U=new ee({idHint:e.id,name:b,geometries:w,materials:S,transformations:I,origins:C,castShadow:!0,metadata:F});U.objectTransformation=_,d[ce.OBJECT][U.id]=U;var k=this._addTasks.get(e.id),q=new me;q.node=e,q.engineObject=U,q.featureIds=m,q.componentColorBuffer=g,q.componentIndices=y,q.cachedRendererVersion=this._getInvalidRendererVersion(),q.cachedSymbolInfos=[],q.attributeInfo=k.attributeInfo,!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors||(this._hasColors=c),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors");var z=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(q).then(function(){var t=r._stageLayer,i=r._stage,n=d[ce.OBJECT];for(var a in n)n.hasOwnProperty(a)&&t.addObject(n[a]);for(var o in d)if(d.hasOwnProperty(o)){var s=d[o];for(var l in s)s.hasOwnProperty(l)&&null==i.get(o,l)&&i.add(o,s[l])}if(r._nodeId2Meta.set(e.id,q),r.suspended)r._removeNodeStageData(e.id);else{q.attributeInfo=k.attributeInfo,q.cachedRendererVersion===r._rendererVersion&&z===r.slicePlaneEnabled||r._addOrUpdateEdgeRendering(q),r._setObjectSymbology(q),r._applyFiltersToNode(q)&&r._updateEdgeRendering(q),r.visibleGeometryChanged(U),r._highlights.objectCreated(U);for(var u=0,c=q.engineObject.getGeometryRecords();u<c.length;u++)c[u].material.updateParameters({slicePlaneEnabled:r.slicePlaneEnabled})}})},l.prototype._addData=function(e,t,i){var n=this,a=this._addTasks.get(e.id);return a?a.attributeInfo=t:(a=r({},x.createResolver(),{attributeInfo:t}),this._addTasks.set(e.id,a),i().then(a.resolve,a.reject).then(function(){return n._addTasks.delete(e.id)})),a.promise},l.prototype._clippingAreaChanged=function(){var e=T.create();K.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},l.prototype._filterChange=function(){this._applyFilters(!1)},l.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e.engineObject))})},l.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},l.prototype.addSqlFilter=function(e,t,r,i){var n=this;t&&r&&e.push(function(e,a){return n._sqlFilter(e,a,t,r,i)})},l.prototype._sqlFilter=function(e,t,r,i,n){var a={},o=this._createLayerGraphic(a),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;i.every(function(e){return null!=d[e]||e===s})&&U.filterInPlace(e,l,function(e){a[s]=l[e];for(var t=0,u=i;t<u.length;t++){var c=u[t];c!==s&&(a[c]=U.getCachedAttributeValue(d[c],e))}try{return r.testFeature(o)}catch(e){return n(e),!1}})},l.prototype._boundingboxFilter=function(e,t,r){K.mbsToMbs(t.node.mbs,this._controller.crsIndex,Se,this.view.renderSpatialReference);var i=null!=r?U.intersectBoundingBoxWithMbs(r,Se):2;if(2!==i){if(0===i)return void(e.length=0);var n=t.engineObject.getGeometryRecords()[0].geometry;if(n.componentCount===t.featureIds.length){var a=U.getClipAABB(r,t.engineObject);U.filterInPlace(e,t.featureIds,function(e){return T.intersects(a,n.getComponentAABB(e,we))})}}},l.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return x.resolve();var r=e.engineObject,i=this._edgeView.hasObject(r),n=this._extractObjectEdgeMaterials(e),a=n.hasEdges,o=n.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};if(a){var l=!r.isHidden(r.geometryRecords[0]);if(i)this._edgeView.updateAllComponentMaterials(r,o,s,t),this._edgeView.updateObjectVisibility(r,l);else if(l)return c.safeCast(this._edgeView.addObject(r,o,s,!1))}else i&&this._edgeView.removeObject(r);return x.resolve()},l.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._edgeView.removeObject(e.engineObject)},l.prototype._applyFiltersToNode=function(e){var t=e.engineObject,r=t.areAllComponentsVisible();if(t.unhideAllComponents(),0===this._filters.length)return!r;var i=e.featureIds;null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters);var n=e.filteredIds;if(n===i)return!r;for(var a=t.getGeometryRecords()[0],o=0,s=0;s<i.length;s++){var l=i[s];o>=n.length||n[o]!==l?t.setComponentVisibility(a,s,!1):o++}return!0},l.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length;r++)(0,i[r])(t,e);return t.length===e.featureIds.length?e.featureIds:t},l.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,i){return t._removeNodeStageData(i,e)})},l.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop();this._removeNodeStageData(r.id),t.madeProgress()}},l.prototype._removeNodeStageData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._nodeId2Meta.get(e);if(r){var i=r.engineObject;i.setHidden(i.geometryRecords[0],!0),this.visibleGeometryChanged(i),this._removeEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(i),this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory)}},l.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,i=e.engineObject;this._edgeView&&this._edgeView.removeObject(i),r.removeObject(i);for(var n=0,a=i.getGeometryRecords();n<a.length;n++){var o=a[n];this.memEstimateGeometryRemoved(o.geometry.data),t.remove(ce.GEOMETRY,o.geometry.id),this._removeMaterial(o.material,t)}if(e.componentIndices){for(var s=0;s<e.componentIndices.length;s++)e.componentColorBuffer.releaseIndex(e.componentIndices[s]);this._componentColorManager.garbageCollect()}t.remove(ce.OBJECT,i.id)},l.prototype._removeMaterial=function(e,t){t.remove(ce.MATERIAL,e.id);var r=e.metadata.engineTex;r&&(this.memEstimateTextureRemoved(r),t.remove(ce.TEXTURE,r.id))},l.prototype.setPolygonOffset=function(e,t){var r=this._nodeId2Meta.get(e.id);if(r)for(var i=0,n=r.engineObject.getGeometryRecords();i<n.length;i++){n[i].material.updateParameters({polygonOffsetEnabled:t})}},l.prototype._getInvalidRendererVersion=function(){return ue(this._rendererVersion,-1)},l.prototype._rendererChange=function(e){return o(this,void 0,void 0,function(){var t,r,i,n,o,s,l,d;return a(this,function(a){switch(a.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererNeedsTextures"),this._rendererVersion=ue(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e?(t=this,r=U.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[a.sent(),this.layer.fields]),a.label=2;case 2:if(e&&"visualVariables"in e&&e.visualVariables)for(i=0,n=e.visualVariables;i<n.length;i++)"color"===(o=n[i]).type?this._colorVariable=o:"opacity"===o.type?this._opacityVariable=o:he.warn("Unsupported visual variable type for 3D Object Scene Services: "+o.type);if(e)for(s=0,l=e.getSymbols();s<l.length;s++)"mesh-3d"!==(d=l[s]).type&&he.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},l.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},l.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},l.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},i=this._tmpAttributeOnlyGraphic;i.attributes=r;var n=this._currentRenderer,a=e.attributeInfo.attributeData,o=null!=e.featureIds?this.layer.objectIdField:null,s=null!=a?this._rendererFields:null;null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));for(var l=e.cachedSymbolColors,d=!0,u=0;u<t;u++){if(null!=o&&(r[o]=e.featureIds[u]),null!=s)for(var c=0,h=s;c<h.length;c++){var p=h[c];a[p]&&(r[p]=U.getCachedAttributeValue(a[p],u))}var f=n&&n.getSymbol(i),m=null;f instanceof A&&(this._symbolInfos.has(f.id)||this._symbolInfos.set(f.id,U.getSymbolInfo(f)),m=this._symbolInfos.get(f.id)),e.cachedSymbolInfos[u]=m;var g=null,y=null,v=!0,_=!0;if(n&&"visualVariables"in n){if(this._colorVariable){var b=n.getColor(i,{colorInfo:this._colorVariable,color:Ie});b&&((g=Ce)[0]=b.r/255,g[1]=b.g/255,g[2]=b.b/255,this._opacityVariable||null===b.a||(y=b.a))}this._opacityVariable&&(y=n.getOpacity(i,{opacityInfo:this._opacityVariable}))}if(m&&m.material){var x=m.material;g=null==g||null==y?j.overrideColor(g,y,x.color,x.alpha,pe,Ce):j.overrideColor(g,y,null,null,pe,Ce),Q.encodeSymbolColor(g,x.colorMixMode,l,4*u),v=m.castShadows}else Q.encodeSymbolColor(null,null,l,4*u),v=!0;if(u>0&&d){for(var w=4*(u-1);w<4*u;w++)l[w]!==l[w+4]&&(d=!1);v!==_&&(d=!1)}_=v}e.uniformSymbolColor=d}},l.prototype._extractObjectEdgeMaterials=function(e){for(var t=[],r=e.engineObject,i=e.featureIds?e.featureIds.length:1,n={opacity:this.fullOpacity},a=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),o=!1,s=null,l=null,d=this._getSymbolInfos(e),u=0;u<i;u++){var c=d[u];r.getComponentVisibility(r.getGeometryRecords()[0],u)&&c?(l!==c&&(l=c,(s=z.createMaterialFromEdges(this._edgeView,c.edges,n))&&(o=!0)),t.push(_.isSome(s)?s:a)):t.push(a)}return{hasEdges:o,perFeatureEdgeMaterials:t}},l.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r=this._getSymbolColors(e);if(e.uniformSymbolColor){var i=Q.decodeSymbolColor(r,0),n=i.color,a=i.colorMixMode,o=!0;e.cachedSymbolInfos[0]&&(o=e.cachedSymbolInfos[0].castShadows);for(var s=0,l=e.engineObject.getGeometryRecords();s<l.length;s++){l[s].material.updateParameters({componentData:{castShadows:o,externalColor:n,externalColorMixMode:a}})}var d=n[3]<1;this._updateObjectOpacity(e.engineObject,d)}else{for(var u=e.componentColorBuffer.textureBuffer,c=!0,h=0;h<t;h++){var p=4*h,f=e.componentIndices[h],m=1;e.cachedSymbolInfos[h]&&(m=!0===e.cachedSymbolInfos[h].castShadows?1:0),u.setData(f,0,r[p],r[p+1],254&r[p+2]|m,r[p+3]),c=c&&Q.isOpaqueSymbolColor(r,p)}for(var g=0,y=e.engineObject.getGeometryRecords();g<y.length;g++){y[g].material.updateParameters({componentData:u})}this._updateObjectOpacity(e.engineObject,!c),this._stage.setNeedsRender()}}},l.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute(ie.VertexAttrConstants.COMPONENTINDEX),i=r.data,n=r.offsetIdx,a=r.strideIdx,o=e.getIndices(ie.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],u=l;u<d;u++){i[n+o[u]*a]=t[s]}},l.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},l.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},l.prototype._updateObjectOpacity=function(e,t){for(var r=0,i=e.getGeometryRecords();r<i.length;r++){var n=i[r].material,a=n.metadata;void 0!==t&&(a.symbolIsTransparent=t);var o=this._calcEngineMaterialTransparencyParams(a.i3sTex,a.i3sMatParams,a.symbolIsTransparent);n.updateParameters(o)}},l.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e.engineObject)},l.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._stageLayer.isSliceable=e,this._nodeId2Meta.forEach(function(e){for(var i=0,n=e.engineObject.getGeometryRecords();i<n.length;i++)n[i].material.updateParameters(r);t._updateEdgeRendering(e,!1)})},l.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e,t)},l.prototype._forAllFeatures=function(e,t,r){var i=this;this._nodeId2Meta.forEach(function(n,a){i._forAllFeaturesOfNode(n,e,r),t&&t(n.node)})},l.prototype._forAllFeaturesOfNode=function(e,t,r){for(var i=e.featureIds,n=e.engineObject.getGeometryRecords()[0],a=0;a<i.length;a++)if(r||e.engineObject.getComponentVisibility(n,a)){t(i[a],a,e,n)}},l.prototype._createGraphic=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=t.attributeInfo.attributeData;if(null!=i)for(var n=0,a=Object.keys(i);n<a.length;n++){var o=a[n];r[o]=U.getCachedAttributeValue(i[o],e)}return this._createLayerGraphic(r)},l.prototype._boundingBoxCornerPoints=function(e,t,r){for(var i=t.geometries[0].getComponentAABB(e,xe),n=0;n<8;++n)be[0]=1&n?i[0]:i[3],be[1]=2&n?i[1]:i[4],be[2]=4&n?i[2]:i[5],E.vec3.transformMat4(be,be,t.objectTransformation),r[3*n]=be[0],r[3*n+1]=be[1],r[3*n+2]=be[2];return r},l.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var i=this._highlights;if("number"==typeof e?e=[e]:e instanceof d?e=[e]:e instanceof h&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof d){var n=e.map(function(e){return q.attributeLookup(e.attributes,r._getObjectIdField())}),a=i.acquireSet(t),o=a.set,s=a.handle;return i.setFeatureIds(o,n),s}if("number"==typeof e[0]){n=e;var l=i.acquireSet(t);o=l.set,s=l.handle;return i.setFeatureIds(o,n),s}}return De},l.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=C.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},l.prototype.test=function(){return{controller:this._controller}},n([O.property()],l.prototype,"view",void 0),n([O.property()],l.prototype,"layer",void 0),n([O.property()],l.prototype,"_controller",void 0),n([O.property({dependsOn:["_controller.updating"]})],l.prototype,"updating",void 0),n([O.property({dependsOn:["_controller.rootNodeVisible"]})],l.prototype,"suspended",void 0),n([O.property(H.updatingPercentage)],l.prototype,"updatingPercentage",void 0),n([O.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],l.prototype,"updatingPercentageValue",void 0),n([O.property({readOnly:!0})],l.prototype,"hasTexturesOrVertexColors",null),n([O.property({readOnly:!0})],l.prototype,"rendererNeedsTextures",null),n([O.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],l.prototype,"elevationOffset",null),n([O.property({type:Boolean})],l.prototype,"slicePlaneEnabled",void 0),n([O.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],l.prototype,"uncompressedTextureDownsamplingEnabled",null),n([O.property({dependsOn:["layer.version"]})],l.prototype,"useCompressedTextures",null),n([O.subclass("esri.views.3d.layers.I3SMeshView3D")],l)}(O.declared(f,p,b));t.I3SMeshView3D=ve;var _e=N.mat4f64.create(),be=P.vec3f64.create(),xe=T.create(),we=T.create(),Ce=[0,0,0,0],Ie=new l([0,0,0,0]),Se=[0,0,0,0],De={remove:function(){},pause:function(){},resume:function(){}}}.apply(null,i))||(e.exports=n)},1706:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(99),r(6),r(52),r(48),r(17),r(19),r(10),r(88),r(209),r(9),r(21),r(0),r(4),r(3),r(45),r(1591),r(1707),r(1708),r(1709),r(1710),r(1516),r(1711),r(222),r(51)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h,p,f,m,g,y,v,_,b,x,w,C,I,S,D,M){function O(e,t){return e.length===t.length&&e.every(function(e){return N(t,e.name)>=0})}function N(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}function E(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var P=u.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),T=function(e){function t(t){var r=e.call(this)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingPercentage=0,r.leafsReached=!1,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._downloadingNodes=new Set,r._loadingNodes=new Set,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._poi=y.vec3f64.create(),r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r.disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new l,r._idleQueue=new _.PromiseQueue,r._errorCount=0,r}return r(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(D.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return I.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return I.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.getNode(this._rootNodeId);return!e||!this._viewportQueries||(this._updateViewData(),this._viewportQueries.isNodeVisible(e))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new w(this.layerView,function(){return e.updatingChanged()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var r=this._rootNodeUrl.split("/");this._rootNodeId=r[r.length-1],this.disableIDBCache=d("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var i=p.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var t=e.layerView.view;e.setClippingArea(t.clippingArea),e._centerOnSurface=t.pointsOfInterest.centerOnSurfaceFrequent;var r=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),r.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),f.init(e.layerView,"suspended",function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(i,n)}),b.addTask(e.layerView.view.resourceController.scheduler,function(t,r){return e._frame(t,r),e._index?e._index.getPriority():-1/0}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),t.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("requiredFields",function(){return e._requiredFieldsChange()})]),e._viewportQueries=new S(e.crsIndex,t.renderCoordsHelper,t.state.camera,e._clippingArea,t.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(e.layer),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(e.getBaseUrl(),e._rootNodeUrl,e._rootNodeId,e.streamDataSupplier,e._viewportQueries,P,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t)},function(t){return e._needsUpdate(t)})}});this.addResolvingPromise(i),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,L.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.requiredFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.requiredFields.map(function(r){var i=N(e,r),n=N(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null}).filter(function(e){return null!=e&&e.name!==r})},t.prototype._requiredFieldsChange=function(){O(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype.setClippingArea=function(e){var t=v.create();M.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=A.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=y.vec3f64.create();g.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,n=y.vec3f64.create();i.worldUpAtPosition(t,n);var a=g.vec3.angle(n,r)-.5*Math.PI;return g.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,a/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this._cameraDirty=!0,this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this.updatingChanged()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.getNode=function(e){return this._index?this._index.getNode(e):null},t.prototype.updateElevationChanged=function(e,t,r){r.clear();var i=this.getNode(this._rootNodeId);null!=i&&I.findIntersectingNodes(e,t,i,this.crsIndex,this._index,function(e){return r.push(e)});for(var n=0;n<r.length;n++){var a=r.data[n];this._viewportQueries.invalidateCache(a.id),a.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}r.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(){this._viewportQueries.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.updatingChanged()},t.prototype.schedule=function(e,t){var r=this;return this._idleQueue.push(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw new n;return t})},t.prototype.reschedule=function(e,t){var r=this;return this._idleQueue.unshift(t).then(function(t){if(!r._loadingNodes.has(e)&&!r._updatingNodes.has(e))throw new n;return t})},Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){this.layerView.suspended?this._updateView(e):(this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty),this.layerView.visible&&this._processLogError(e,t))},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?P.error("Error during processing: "+e):50===this._errorCount&&P.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateView(e),e.run(function(){return r._processIndex(t,e)}),this._updateFeatureLOD(),e.run(function(){return r._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return r._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this.updatingChanged(),this._lodHandling.lodGlobalHandling(e)}},t.prototype._processIndex=function(e,t){var r=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));this._index.update(o.keysOfSet(this._loadingNodes),t);var i=this._index.getFeatureEstimate().leafsReached;return this._index.isLoading()||i===this._get("leafsReached")||this._set("leafsReached",i),this._index.load(r)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0||this._index.updates.add.length>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processNodes=function(e,t){var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNodeIdLoading,this),i.cancel=[];i.update.length>0&&!e.done;)this._updateLoadedNode(i.update.pop()),e.madeProgress();for(;i.add.length>0&&!e.done&&r>0&&(--r,!i.add.back().notInCache||this._hasNodeLoadToken(t));){var n=i.add.pop();this._loadNode(n),e.madeProgress()}return e.hasProgressed},t.prototype._cancelNodeLoading=function(){var e=this;this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.forEach(function(t,r){return e._updatingNodes.get(r).cancel()}),this._updatingNodes.clear()},t.prototype._cancelNodeIdLoading=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var r=t.numIndexLoading+this._index.getIndexLoading(),i=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*r-2*i)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype.updatingChanged=function(){var e=(this._index?this._index.getIndexMissing():0)+3*(this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size,t=!(!(e>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===e&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(e,this._progressMaxNumNodes),t!==this._get("updating")&&this._set("updating",t);var r=100*e/this._progressMaxNumNodes;r!==this._get("updatingPercentage")&&this._set("updatingPercentage",r)},t.prototype._updateView=function(e){this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1)},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=y.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.progressiveLoadPenalty=A.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){return this.fixedFeatureTarget?1:2*Math.min(this.layerView.view.resourceController.memoryController.memoryFactor,.5)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._viewportQueries.isGeometryVisible(e)},t.prototype.updateVisibility=function(e){return this._viewportQueries.updateNode(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&(!e.obb||this._viewportQueries.isGeometryVisible(e))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return t<1&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.calcCameraDistance(e)>this._viewportQueries.maxDistance*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=C.TextureFormat.Normal;this.layerView.useCompressedTextures?t=C.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=C.TextureFormat.Downsampled);var r=this._defaultGeometrySchema,i={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==r||null==r.ordering};this._nodeLoader=new C(this.streamDataSupplier,P,r,this._requiredAttributes,i);var n=this.layerView.view.renderSpatialReference,a=this.crsIndex.equals(n)||this.crsIndex.isWGS84&&n.equals(M.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!a,this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._viewportQueries.isNodeVisible(t)},function(t){return e._viewportQueries.isGeometryVisible(t)},function(t){return e._index.nodeTraversalState(t)},function(t,r){return e._removeNodes(t,r)},this._index,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel}),this.updatingChanged()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._nodeLoader.cancelAll(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this.updatingChanged())},t.prototype._removeInvisibleNodes=function(e){var t=this.layerView.getLoadedNodeIDs();L.clear();for(var r=0,i=t;r<i.length;r++){var n=i[r],a=this.getNode(n);this._viewportQueries.isGeometryVisible(a)&&!this._shouldDropNode(a)||(this._lodHandling.setLodGlobalDirty(),L.push(a))}return this._removeNodes(L,e),0===L.length||(L.clear(),!1)},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate(),this.layerView.removeNodeData(e,t)},t.prototype._needsUpdate=function(e){if(null==e.featureData||0===e.featureData.length||this._updatingNodes.has(e.id))return!1;var t=this.layerView.getLoadedAttributes(e);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=O(this.layerView.getLoadedAttributes(e),this._requiredAttributes)?p.resolve(this.layerView.getAttributeData(e)):this._nodeLoader.loadAttributes(e,this._requiredAttributes);this._updatingNodes.set(e.id,r),r.then(function(r){return t.schedule(e.id).then(function(){return t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:r})})}).catch(function(r){r instanceof n||t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.id),t.updatingChanged()}),this.updatingChanged()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id),this.updatingChanged(),this._loadAndAddBundle(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.id),t.updatingChanged()})},t.prototype._loadAndAddBundle=function(e){var t=this;return 1!==e.featureData.length&&P.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded."),e.notInCache?this._loadUncached(e):this._loadCached(e).then(function(r){r||(e.notInCache=!0,t._index.updates.add.push(e))}).catch(function(t){t instanceof n||(e.notInCache=!0)})},t.prototype._enableFromGPUCache=function(e){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var t=this.layerView.loadCachedGPUData(e);return!!(t&&E(t.attributeInfo)&&O(t.attributeInfo.loadedAttributes,this._requiredAttributes))&&(this.layerView.addCachedGPUData(e,t),this._nodeAdded(e),!0)},t.prototype._nodeAdded=function(e){this._index.requestUpdate(),this._lodHandling.lodSwapBundleLoaded(e)},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e))return p.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule(e.id).then(function(){return r.loadCachedNodeData(e,function(e,r){return t._nodeLoader.loadTextures(e,r)})}).then(function(i){if(null==i)return!1;var n=t._requiredAttributes;return E(i)&&O(i.loadedAttributes,n)?t.reschedule(e.id).then(function(){return r.addCachedNodeData(e,i,i)}).then(function(){return t._nodeAdded(e),!0}):t.reschedule(e.id).then(function(){return t._nodeLoader.loadAttributes(e,n)}).then(function(r){return t.reschedule(e.id,{loadedAttributes:n,attributeData:r})}).then(function(t){return r.addCachedNodeData(e,i,t)}).then(function(){return t._nodeAdded(e),!0})}):p.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.id),this._nodeLoader.loadBundleData(e,0).then(function(r){return t._downloadingNodes.delete(e.id),t.schedule(e.id,r)}).then(function(r){return t.layerView.addNodeData(e,r)}).then(function(){t._nodeAdded(e),e.notInCache=!1}).catch(function(r){r instanceof n||(P.error("Failed to load node '"+e.id+"' bundle 0: "+r),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._viewportQueries&&this._viewportQueries.setCameraIdle(e),this.updatingChanged(),e&&this._index&&this._index.resetFailedNodes())},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),i([m.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),i([m.property({readOnly:!0})],t.prototype,"isGraphics3D",null),i([m.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),i([m.property({readOnly:!0})],t.prototype,"crsVertex",null),i([m.property({readOnly:!0})],t.prototype,"crsIndex",null),i([m.property()],t.prototype,"camPos",void 0),i([m.property()],t.prototype,"screenSizeFactor",void 0),i([m.property()],t.prototype,"featureTarget",void 0),i([m.property()],t.prototype,"fixedFeatureTarget",void 0),i([m.property()],t.prototype,"layerView",void 0),i([m.property()],t.prototype,"layer",void 0),i([m.property({readOnly:!0})],t.prototype,"updating",void 0),i([m.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),i([m.property({readOnly:!0})],t.prototype,"leafsReached",void 0),i([m.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),i([m.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),i([m.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(m.declared(a,h,s)),L=new c,A={factorIM:.2,factor3dObject:.05,distancePenalty:10};return T}.apply(null,i))||(e.exports=n)},1707:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(52)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(2,function(e){return t.update(e)},function(){return!0})}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i](e,r),this.runIndex=i},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){r.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),n=new Map;t.addTask=function(e,t){var r=n.get(e);return null==r&&(r=new i(e),n.set(e,r)),r.add(t),{remove:function(){if(null!=r){if(r.remove(t),r.callbacks.length>0)return void(r=null);n.delete(e),r.destroy(),r=null}}}}}.apply(null,i))||(e.exports=n)},1708:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11),r(99),r(88),r(33),r(1523)],void 0===(n=function(e,t,r,i,n,a,o){Object.defineProperty(t,"__esModule",{value:!0});var s=["version","level","sharedResource","attributeData","geometryData","textureData","lodSelection"],l=function(){function e(e,t,r,i,o,s,l,d,c,h){var p=this;this.rootId=r,this.streamDataSupplier=i,this.viewportQueries=o,this.logger=s,this._isLoaded=l,this._isSelected=d,this._enable=c,this._needsUpdate=h,this._dirty=!0,this.nodeIndex={},this._loadingNodes=new Set,this._failedNodes=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n,this._prefetch=new n,this._updates=new u,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.rootUrl=a.makeAbsolute(t,e),this.traverseVisible(function(e,t){return p.nodeTraversalState(t)})}return e.prototype.getNode=function(e){return this.nodeIndex[e]},Object.defineProperty(e.prototype,"size",{get:function(){return Object.keys(this.nodeIndex).length},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){d.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e,t){var i=this;if(this._dirty){this._indexMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),d.clear(),this._updates.reset(e);var n=!0,a=new c,o=new c,s=new Map;this.traverseVisible(function(l,u,c){if(i._updateNodeFeatureEstimate(u,o),!u){++i._indexMissing;var h=i.entryPriority(l);return i._loadingNodes.has(l.id)||i._failedNodes.has(l.id)||(i._missing.push(r({},l,{baseUrl:c})),s.set(l.id,h)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,h))}if(0===i._missing.length&&u.children)for(var p=0,f=u.children;p<f.length;p++){var m=f[p];i.nodeIndex[m.id]||i._loadingNodes.has(m.id)||(s.set(m.id,i.entryPriority(m)),i._prefetch.push(r({},m,{baseUrl:u.baseUrl})))}if(!u.failed&&u.featureData&&0!==u.featureData.length)if(i._isLoaded(u)){if(a.known+=u.memory,++a.knownNodes,i._isSelected(u)?u.children&&(n=!1):(a.unremoved+=u.memory,n=!1),i._needsUpdate(u)){var g=i.entryPriority(u);s.set(u.id,g),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,g),i._updates.update.push(u)}}else if(u.memory&&(a.known+=u.memory,++a.knownNodes),i._isSelected(u)){if(u.children&&(n=!1),u.memory?(a.missing+=u.memory,a.known+=u.memory,++a.knownNodes):++a.missingNodes,e.indexOf(u.id)>=0)return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i.entryPriority(u)),void(i._updates.cancel=i._updates.cancel.filter(function(e){return e!==u.id}));if(!t.done&&i._enable(u))return void t.madeProgress();var y=i.entryPriority(u);s.set(u.id,y),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,y),d.push(u)}}),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(o),this._featureEstimate.leafsReached=n,this._missing.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._missing.length>0?(this._maxUnloadedPrio=s.get(this._missing.back().id),this._prefetch.clear()):this._prefetch.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._updates.add=d.filter(function(e){var t=e.id;return s.get(t)>=i._maxUnloadedPrio},this,this._updates.add),this._updates.add.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._updates.update.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._dirty=this._indexMissing>0}},e.prototype.checkFeatureTarget=function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,a=r,o=10;o--;){var s=new c;if(this._updateFeatureEstimate(i,s),this._computeFeatureEstimate(s)<=e){if(i>=t||s.missingNodes>0||0===o)break;a=i,i=.5*(i+n)}else n=i,i=.5*(i+a)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)},e.prototype._updateFeatureEstimate=function(e,t){var r=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,i){return r._updateNodeFeatureEstimate(i,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){if(0===this._missing.length)return!1;e=Math.min(e,this._missing.length);for(var t=0;t<e;++t)this._loadNode(this._missing.pop());return!0},e.prototype.prefetch=function(e){if(0===this._prefetch.length)return!1;e=Math.min(e,this._prefetch.length);for(var t=0;t<e;++t)this._loadNode(this._prefetch.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loadingNodes.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.id];if(t&&t.version===this._version)return t;var r=this.viewportQueries.getLodLevel(e),i=this.viewportQueries.hasLOD(e),n=!0;if(i)if(e.parentNode){var a=this.nodeIndex[e.parentNode.id];if(null==a)return null;var o=this._nodeTraversalState[a.id];n=o&&r>o.lodLevel}else n=r>0;return t?(t.lodLevel=r,t.isChosen=n,t.version=this._version,t):(this._nodeTraversalState[e.id]={nodeHasLOD:i,lodLevel:r,isChosen:n,version:this._version},this._nodeTraversalState[e.id])},e.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id);var r=a.makeAbsolute(e.href,e.baseUrl),n=function(e){t._loadingNodes.delete(e),0===t._missing.length&&0===t._loadingNodes.size&&t.requestUpdate()};this.streamDataSupplier.request(r,"json").then(function(e){var i=e.data,a={id:i.id,mbs:i.mbs,parentNode:i.parentNode,children:i.children,featureData:i.featureData};s.forEach(function(e){a[e]=i.hasOwnProperty(e)?i[e]:null}),i.hasOwnProperty("obb")&&!t.ignoreServiceOBB&&(a.obb=o.clone(i.obb),a.hasServiceOBB=!0,t.viewportQueries.updateNode(a.id)),t.nodeIndex[a.id]=a,a.baseUrl=r,a.featureData&&1===a.featureData.length&&a.featureData[0].featureRange&&(a.numFeatures=a.featureData[0].featureRange[1]-a.featureData[0].featureRange[0]+1),t.nodeTraversalState(a),n(a.id)},function(a){a instanceof i||(t.logger.error("Error loading node: "+r),t._failedNodes.add(e.id)),n(e.id)})},e.prototype.resetFailedNodes=function(){this._failedNodes.clear();for(var e=0,t=Object.keys(this.nodeIndex);e<t.length;e++){var r=t[e];this.nodeIndex[r].failed=!1}},e.prototype.entryPriority=function(e){if(null==e.mbs&&e.id===this.rootId)return 1/0;var t=0,r=this.nodeIndex[e.id];if(null!=r&&null!=r.parentNode){var i=this._nodeTraversalState[r.parentNode.id];null!=i&&(t=i.lodLevel)}for(var n=this.progressiveLoadPenalty,a=r;a;a=a.parentNode?this.nodeIndex[a.parentNode.id]:null)if(this._isLoaded(a)){n=0;break}var o=this.viewportQueries.distToPOI(e);return-o-t*(o+this.progressiveLoadPenalty)+n},e.prototype.traverseVisible=function(e){var t=this.nodeIndex[this.rootId];t?this._traverse({id:this.rootId,mbs:t.mbs,href:this.rootUrl},t,e,""):e({id:this.rootId,mbs:null,href:this.rootUrl},null,"")},e.prototype._traverse=function(e,t,r,i){if(t.children&&0!==t.children.length){if(this.viewportQueries.isNodeVisible(t)){r(e,t,i);var n=this.nodeTraversalState(t);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=0,o=t.children;a<o.length;a++){var s=o[a],l=this.nodeIndex[s.id];l?this._traverse(s,l,r,t.baseUrl):this.viewportQueries.isNodeVisible(s)&&r(s,null,t.baseUrl)}}}else this.viewportQueries.isGeometryVisible(t)&&r(e,t,i)},e.prototype.traverse=function(e,t){if(t(e)&&e.children)for(var r=0;r<e.children.length;++r){var i=this.getNode(e.children[r].id);i&&this.traverse(i,t)}},e.prototype.traverseChildren=function(e,t){if(e.children)for(var r=0;r<e.children.length;++r){var i=this.getNode(e.children[r].id);i&&t(i)&&this.traverseChildren(i,t)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e}();t.I3SIndex=l;var d=new n,u=function(){function e(){this.update=new n,this.add=new n,this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}(),c=function(){return function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}()}.apply(null,i))||(e.exports=n)},1709:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(88)],void 0===(n=function(e,t,r){var i=function(){function e(e,t){this.layerView=e,this.lodGlobalDirtyChanged=t}return e.prototype.startNodeLoading=function(e,t,r,i,n,a,o){this._lodGlobalDirty=!1,this._maxLodLevel=o.maxLodLevel,this._index=n,this._rootId=a,this._nodeTraversalState=r,this._isNodeVisible=e,this._isGeometryVisible=t,this._removeNodes=i,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.shouldLoadNode=function(e){var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.lodSwapBundleLoaded=function(e){this.setLodGlobalDirty()},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._rootId&&(!0===this._lodGlobalDirty||this.layerView.view&&this.layerView.view.resourceController.memoryController.usedMemory>1.1)},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(this.requiresLODGlobalHandling){var t=this._rootId,r=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(r-1)));n.clear(),this._lodGlobalHandlingRecursion(t,i),this._removeNodes(n,e),0===n.length&&(this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty)),n.clear()}},e.prototype._lodGlobalHandlingRecursion=function(e,t){var r=this._index.getNode(e);if(null==r)return!1;var i=this._nodeTraversalState(r),a=this.isChosenMaxLOD(i),o=this.layerView.isNodeLoaded(r);if(o&&null!=this.layerView.setPolygonOffset){var s=!a;this.layerView.setPolygonOffset(r,s)}if(a&&o)return this._removeChildrenRecursive(r),!0;var l=!1;if(null!=r.children&&0!==r.children.length){l=!0;for(var d=0,u=r.children;d<u.length;d++){var c=u[d],h=this._index.getNode(c.id);(h?this._isGeometryVisible(h):this._isNodeVisible(c))&&!this._lodGlobalHandlingRecursion(c.id,t)&&(l=!1)}}o&&!a&&(l||n.length<t)&&(n.push(r),o=!1);var p=!r.featureData||0===r.featureData.length;return l||o||p},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,function(e){return n.push(e),!0})},e.prototype.childrenEmpty=function(e){var t=this,r=!0;return this._index.traverseChildren(e,function(e){return!(!r||!t._isNodeVisible(e)||t.layerView.isNodeLoaded(e)&&(r=!1,1))}),r},e.prototype._childrenRequireLoading=function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,function(e){if(!i||!t._isNodeVisible(e))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e)&&(r=!0),!t.layerView.isNodeLoaded(e)||(i=!1,!1)}),i&&r},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),n=new r;return i}.apply(null,i))||(e.exports=n)},1710:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(99),r(7),r(9),r(33),r(1530),r(1516),r(16)],void 0===(n=function(e,t,r,i,n,a,o,s,l){var d=function(){function e(t,r,i,o,s){this.loader=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=o,this.options=s,this.cancelled=!1,this.loadShared=function(t){if(null==t.sharedResource)return n.resolve({});var r=a.makeAbsolute(t.sharedResource.href,t.baseUrl);return this.load(r,"json").then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,r),t})}}return e.prototype.cancelAll=function(){this.cancelled=!0},e.prototype.load=function(e,t){var r=this;return n.create(function(i,n){r.loader.request(e,t).then(function(e){return i(e.data)},function(t){return n(t||new Error("Failed to load: "+e))})})},e.prototype.loadAttribute=function(e,t,r){var i=a.makeAbsolute(r,e);return this.load(i,"binary").then(function(e){return o.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t){var r=this,i=t.map(function(t){return null==e.attributeData||null==e.attributeData[t.index]?(r.logger.error("Missing attributeData for '"+t.name+"' on node '"+e.id+"'"),n.resolve(null)):r.loadAttribute(e.baseUrl,t.attributeStorageInfo,e.attributeData[t.index].href).catch(function(i){return r.logger.error("Failed to load attributeData for '"+t.name+"' on node '"+e.id+"'"),null})});return n.all(i).then(function(e){for(var r={},i=0;i<t.length;++i)e[i]&&(r[t[i].name]=e[i]);return r})},e.prototype.prepareBinaryGeometryData=function(e,t,r,n){var a=e.geometries[0];if(i.mixin(a.params,r),n||null!=r.vertexAttributes.region||delete r.vertexAttributes.region,null!=r.featureAttributes){var l=r.featureAttributes;if(l.faceRange){var d=o.createTypedView(t,l.faceRange),u=l.faceRange.valuesPerElement,c=r.header.fields.featureCount;e.componentOffsets=s.convertFlatRangesToOffsets(d,c,u)}if(l.id){e.featureIds=[];var h=1,p=o.valueType2TypedArrayClassMap[l.id.valueType];"UInt64"===l.id.valueType&&(p=Uint32Array,h=2);for(var f=new p(t,l.id.byteOffset,l.id.count*l.id.valuesPerElement*h),m=0;m<r.header.fields.featureCount;m++)if(e.featureIds[m]=f[m*l.id.valuesPerElement*h],2===h){var g=f[m*l.id.valuesPerElement*h+1];if(g>=2097150)throw new Error("ID exceeded maximum range supported by javascript (max = 53bit-1 = 9007199254740991)");e.featureIds[m]+=4294967296*g}}}},e.prototype.loadBundleData=function(e,t){var r=this,i=null,s=this.loadShared(e),l=null;null!=this.requiredAttributes&&(l=this.loadAttributes(e,this.requiredAttributes));var d=null;if(null!=e.geometryData){var u=e.geometryData[t],c=a.makeAbsolute(u.href,e.baseUrl);d=this.load(c,"binary")}return s.then(function(a){return r.handleCancelled(),(r.options.loadFeatureData?r.loadFeatureData(e,t):n.resolve(null)).then(function(t){r.handleCancelled();var s,u=r.options.loadFeatureData?r.collectGeometries(e,t,a):r.meshPyramidGeometryData(e,a);s=null!=d?d.then(function(e){i=e;var t=Object.keys(a.materialDefinitions)[0],n=a.materialDefinitions[t].params.vertexRegions,s=o.createGeometryDataIndex(e,r.defaultGeometrySchema,n);return r.prepareBinaryGeometryData(u[0],e,s,n),u}):n.resolve(u);var c=r.loadTextures(u,a);return n.all([c,s,l])}).then(function(e){var t=e[0],n=e[1],o=e[2];r.handleCancelled();var s=null;return o&&(s={attributeData:o,loadedAttributes:r.requiredAttributes}),{allGeometryData:n,attributeDataInfo:s,geometryBuffer:i,sharedResource:a,textureData:t}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=0,s=r[n[i]].images;o<s.length;o++){var l=s[o];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return a.makeAbsolute(e,t)}):l.hrefConcat=a.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var a;"data:"===(a=i.encoding[n]).substring(0,5)&&(i.encoding[n]=a.substring(5))}else"data:"===(a=i.encoding).substring(0,5)&&(i.encoding=a.substring(5))}},e.prototype.loadTexture=function(e,t,r,i){var n=this;return i===s.DDS_ENCODING_STRING?this.load(e,"binary").then(function(e){return n.handleCancelled(),{i3sTexId:t,data:e,encoding:i}}):this.load(e,"image").then(function(e){var a=e;if(n.handleCancelled(),r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),s=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=o,l.height=s,l.getContext("2d").drawImage(e,0,0,o,s),a=l}return{i3sTexId:t,data:a,encoding:i}})},e.prototype.loadTextures=function(t,r){for(var i=[],a=0;a<t.length;a++){var o=t[a].geometries;if(null!=o)for(var d=0,u=o;d<u.length;d++){var c=u[d].params.textureID||"none";if("none"!==c){null!=r.textureDefinitions&&null!=r.textureDefinitions[c]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+c);var h=r.textureDefinitions[c];if(l.assert(void 0!==h,"geometry wants unknown texture "+c),0===h.images.length)continue;var p=h.images.length-1,f=h.images[p],m=this.options.textureFormat===e.TextureFormat.Compressed,g=this.options.textureFormat===e.TextureFormat.Downsampled,y=s.getAppropriateTextureEncoding(h.encoding,m),v=y>-1?h.encoding[y]:h.encoding,_=y>-1?f.hrefConcat[y]:f.hrefConcat;this.options.loadTextureData?i.push(this.loadTexture(_,c,g,v)):i.push({i3sTexId:c,encoding:v,data:null})}}}return n.all(i)},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,textureID:t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e,t,r){for(var i=[],n=0,a=t.featureData;n<a.length;n++){var o=a[n],s=o.geometries;if(null!=s)for(var l=0;l<s.length;l++){var d=o.geometries[l];i.push({featureIds:[o.id],featureDataPosition:o.position,geometries:[d]})}else null!=o.position&&i.push({featureIds:[o.id],featureDataPosition:o.position,geometries:null})}return i},e.prototype.loadFeatureData=function(e,t){var r=a.makeAbsolute(e.featureData[t].href,e.baseUrl);return this.load(r,"json")},e.prototype.handleCancelled=function(){if(this.cancelled)throw new r},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(d||(d={})),d}.apply(null,i))||(e.exports=n)},1711:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(4),r(3),r(54),r(36),r(31),r(383),r(178),r(102),r(1516),r(29),r(1523),r(51)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h,p){return function(){function e(e,t,r,n,a,s,l){void 0===l&&(l={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=n,this.elevationProvider=a,this.options=l,this._computedOBBs={},this._computedMBSs={},this._isNodeVisibleCached={},this.fp=c.frustum.create(),this._poi=i.vec3f64.create(),this._idleCamera=!0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=i.vec3f64.create(),this._tmp2=i.vec3f64.create(),this._tmp3=i.vec3f64.create(),this._tmp0=i.vec3f64.create(),this.supportedMetrics=["maxScreenThreshold","screenSpaceRelative","removedFeatureDiameter","distanceRangeFromDefaultCamera"],this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s),this.tmpPoint=new o({x:0,y:0,z:0,spatialReference:e})}return e.prototype.updateElevationInfo=function(e){this.invalidateCache(),null!=e?(this._elevationContext=new s,this._elevationContext.featureExpressionInfoContext=l.createContext(l.extractExpressionInfo(e,!1)),this._elevationContext.mixinApi(e)):this._elevationContext=null},e.prototype.updateCamera=function(e){c.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this._isNodeVisibleCached={},this.maxDistance=0},e.prototype.updateNode=function(e){delete this._isNodeVisibleCached[e]},e.prototype.setPointOfInterest=function(e){r.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.setCameraIdle=function(e){this._idleCamera!==e&&(this._idleCamera=e,this._isNodeVisibleCached={})},e.prototype.updateExtent=function(e){this.extent=e,this._isNodeVisibleCached={}},e.prototype.computeMbs=function(e){var t=this._computedMBSs[e.id];return t||(t=a.vec4f64.fromValues(e.mbs[0],e.mbs[1],e.mbs[2],-1),this._computedMBSs[e.id]=t),t[3]<0&&(n.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=d.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.computeObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)){var t=this._computedOBBs[e.id];return t||((t=h.clone(e.obb)).halfSize[0]=-1,this._computedOBBs[e.id]=t),t.halfSize[0]<0&&(t.halfSize[0]=e.obb.halfSize[0],r.vec3.copy(t.center,e.obb.center),this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],t.center[2]=d.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.bufferToBuffer(t.center,this.indexSR,0,t.center,this.engineSR,0,1)),t}},e.prototype._isNodeVisible=function(e){var t=this.computeMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.hasServiceOBB&&e.obb){var r=this.computeObb(e);return h.isVisible(r,this.fp)}return this.isMBSVisible(t)},e.prototype.isNodeVisible=function(e){return this._idleCamera?null!=this._isNodeVisibleCached[e.id]?this._isNodeVisibleCached[e.id]:(this._isNodeVisibleCached[e.id]=this._isNodeVisible(e),this._isNodeVisibleCached[e.id]):this._isNodeVisible(e)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;if(e.hasServiceOBB)return!0;var t=this.computeObb(e);return!t||h.isVisible(t,this.fp)},e.prototype.invalidateCache=function(e){if(null==e){for(var t=0,r=Object.keys(this._computedMBSs);t<r.length;t++){var i=r[t];this._computedMBSs[i][3]=-1}for(var n=0,a=Object.keys(this._computedOBBs);n<a.length;n++){i=a[n];this._computedOBBs[i].halfSize[0]=-1}}else this._computedMBSs[e]&&(this._computedMBSs[e][3]=-1),this._computedOBBs[e]&&(this._computedOBBs[e].halfSize[0]=-1)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==u.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return c.frustum.intersectsSphere(this.fp.planes,c.sphere.wrap(e[3],e))},e.prototype.calcScreenSpaceSize=function(e,t){var i=this.computeMbs(e),n=r.vec3.squaredDistance(i,this._camPos),a=i[3];this.maxDistance=Math.max(this.maxDistance,Math.sqrt(n)-a);var o=n-a*a;return o<0?.5*Number.MAX_VALUE:t/Math.sqrt(o)*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){var t=this.computeMbs(e),i=r.vec3.distance(t,this._camPos)-t[3];return this.maxDistance=Math.max(this.maxDistance,i),i},e.prototype.calcAngleDependentLoD=function(e){var t=this.computeMbs(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/r.vec3.length(t)+i)/r.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return null!=e.lodSelection},e.prototype.hasFeatures=function(e){return null!=e.featureData},e.prototype.getDistancePlanarMode=function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],a=r*r+i*i,o=t[3];if(a<=o*o)return Math.abs(n);var s=Math.sqrt(a)-o;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var i=r.vec3.length(t),n=r.vec3.length(e)-i;r.vec3.scale(this._tmp0,e,r.vec3.dot(e,t)/r.vec3.squaredLength(e));var a=r.vec3.squaredDistance(t,this._tmp0),o=t[3];if(a<=o*o)return Math.abs(n);var s=r.vec3.scale(this._tmp0,t,1/i),l=i,d=o*o/2/l,u=r.vec3.scale(this._tmp1,s,l-d),c=e,h=r.vec3.subtract(this._tmp2,c,u),p=r.vec3.subtract(this._tmp2,h,r.vec3.scale(this._tmp3,s,r.vec3.dot(s,h))),f=r.vec3.add(this._tmp2,u,r.vec3.scale(this._tmp2,p,o/r.vec3.length(p))),m=r.vec3.distance(c,f);if(n>=2e5){var g=r.vec3.subtract(this._tmp1,c,f),y=r.vec3.dot(g,s)/r.vec3.length(g);y<.08&&(y=1e-4),m/=y}return m},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._selectErrorMetric=function(e){for(var t=0;t<e.length;t++)if(this.supportedMetrics.indexOf(e[t].metricType)>=0)return e[t];return null},e.prototype.getLodLevel=function(e){if(!e.lodSelection||e.lodSelection.length<=0||!1===this.hasFeatures(e))return 0;if(null==e.children||0===e.children.length)return this.maxLodLevel;var t=this._selectErrorMetric(e.lodSelection);if(null==t)return 0;if(this.progressiveLoadFactor<1){var r=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,r,t)?this.evaluateLODmetric(e,i,t)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias,t)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t,r){switch(r.metricType){case"screenSpaceRelative":var i=this.computeMbs(e),n=this.getDistance(this._camPos,i),a=2*n/this._screenSizeFactor;return this.maxDistance=Math.max(this.maxDistance,n),r.maxError*t<=a;case"maxScreenThreshold":var o=this.calcScreenSpaceSize(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(o*=this.calcAngleDependentLoD(e)),o<r.maxError;case"removedFeatureDiameter":return this.calcScreenSpaceSize(e,r.maxError)*t<10;case"distanceRangeFromDefaultCamera":return this.calcCameraDistance(e)>r.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.computeMbs(e);return r.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return r.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,i))||(e.exports=n)},1793:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(11),r(604)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isUniformComponentData=function(e){return!(e instanceof i.TextureBackedBuffer)},t.fillDefaults=function(e){return r({baseColor:n,baseColorOpacity:1,baseColorTexture:null,doubleSidedShading:!1,normals:"screen-space",cullFace:"back",componentData:a,receiveSSAO:!0,forceTransparency:null,slicePlaneEnabled:!1,polygonOffsetEnabled:!1,writeStencil:!1,layerOpacity:1},e)};var n=[1,1,1],a={externalColor:[1,1,1,1],externalColorMixMode:"multiply",castShadows:!0}}.apply(null,i))||(e.exports=n)},1794:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(75)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.createVertexBufferLayout=function(e){var t=r.newLayout().vec3f("position");return"compressed"===e.normals?t.vec2i16("normalCompressed",{glNormalized:!0}):"default"===e.normals&&t.vec3f("normal"),e.textureCoordinates&&t.vec2f("uv0"),e.textureCoordinateRegions&&t.vec4u16("region",{glNormalized:!0}),e.colors&&t.vec4u8("color"),e.componentData&&t.u16("componentIndex"),t.alignTo(4)}}.apply(null,i))||(e.exports=n)},2242:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1551)],void 0===(n=function(e,t,r){var i=function(){return function(e){this.highlightSet=new r,this.ids=new Set,this.paused=!1,this.options=e}}();return function(){function e(e){this.highlights=[],this.layerView=e}return e.prototype.destroy=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()}),this.highlights=null},e.prototype.acquireSet=function(e){var t=this,r=new i(e);return this.highlights.push(r),{set:r,handle:{remove:function(){return t.releaseSet(r)},pause:function(){r.highlightSet.removeAll(),r.paused=!0},resume:function(){r.paused=!1,t.initializeSet(r)}}}},e.prototype.releaseSet=function(e){e.highlightSet.removeAll();var t=this.highlights?this.highlights.indexOf(e):-1;-1!==t&&this.highlights.splice(t,1)},e.prototype.setFeatureIds=function(e,t){t.forEach(function(t){return e.ids.add(t)}),this.initializeSet(e)},e.prototype.initializeSet=function(e){this.layerView._forAllFeatures(function(t,r,i,n){if(e.ids.has(t)){var a=i.engineObject.setComponentHighlight(n,r,e.options);e.highlightSet.addObject(i.engineObject,a)}},null,!0)},e.prototype.objectCreated=function(e){var t=this;this.highlights.forEach(function(r){r.paused||t.layerView._forAllFeaturesOfNode(t.layerView._getMetadata(e),function(t,i,n,a){if(r.ids.has(t)){var o=e.setComponentHighlight(a,i,r.options);r.highlightSet.addObject(e,o)}},!0)})},e.prototype.objectDeleted=function(e){this.highlights.forEach(function(t){t.highlightSet.removeObject(e)})},e.prototype.allObjectsDeleted=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()})},e}()}.apply(null,i))||(e.exports=n)},2243:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2),r(1),r(6),r(10),r(0),r(4),r(3),r(37),r(128),r(138),r(184)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h){var p=d.empty(),f={spatialReference:null,extent:p},m=l.vec3f64.create(),g=l.vec3f64.create(),y=l.vec3f64.create(),v=a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(e){function t(t){return e.call(this)||this}return r(t,e),t.prototype.initialize=function(){var e=this.layerView.view;this.view=e,this.renderCoordsHelper=e.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new h(e.viewingMode);var t=this.layerView.layer.fullExtent;this.zmin=t.zmin,this.zmax=t.zmax},t.prototype.getElevation=function(e){if(u.isPoint(e)){if(!this.renderCoordsHelper.toRenderCoords(e,m))return v.error("could not project point for elevation alignment"),-1/0}else if(!this.renderCoordsHelper.toRenderCoords(e,this.spatialReference,m))return v.error("could not project point for elevation alignment"),-1/0;var t=this.layerView.elevationOffset,r=this.zmin+t,i=this.zmax+t;return s.vec3.copy(g,m),s.vec3.copy(y,m),this.renderCoordsHelper.setAltitude(i,g),this.renderCoordsHelper.setAltitude(r,y),this.intersector.intersect(this.intersectLayers,g,y,null,null,1,!1),this.intersector.results.min.getIntersectionPoint(m)?this.renderCoordsHelper.getAltitude(m):-1/0},t.prototype.layerChanged=function(){this.spatialReference&&(f.extent=this.computeLayerExtent(this.intersectLayers[0]),f.spatialReference=this.spatialReference,this.emit("elevation-change",f))},t.prototype.objectChanged=function(e){this.spatialReference&&(f.extent=this.computeObjectExtent(e),f.spatialReference=this.spatialReference,this.emit("elevation-change",f))},t.prototype.computeObjectExtent=function(e){return d.empty(p),this.expandExtent(e,p),p},t.prototype.computeLayerExtent=function(e){d.empty(p);for(var t=0,r=e.getObjects();t<r.length;t++){var i=r[t];this.expandExtent(i,p)}return p},t.prototype.expandExtent=function(e,t){for(var r=e.getBBMin(!0),i=e.getBBMax(!0),n=0;n<8;++n)m[0]=1&n?r[0]:i[0],m[1]=2&n?r[1]:i[1],m[2]=4&n?r[2]:i[2],s.vec3.transformMat4(m,m,e.objectTransformation),this.renderCoordsHelper.fromRenderCoords(m,m,this.spatialReference),d.expand(t,m);return t},i([o.property({constructOnly:!0})],t.prototype,"layerView",void 0),i([o.property({constructOnly:!0})],t.prototype,"stageLayer",void 0),i([o.property()],t.prototype,"view",void 0),i([o.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],t.prototype,"spatialReference",void 0),i([o.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],t)}(o.declared(n,c.Evented))}.apply(null,i))||(e.exports=n)},2244:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(13),r(9)],void 0===(n=function(e,t,r,i){function n(e){return i.create(function(t,r){e.oncomplete=function(){return t()},e.onerror=function(){return r(e.error)},e.onabort=function(){return r(e.error)}})}function a(e){return i.create(function(t,r){"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return r(e.error)})})}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,r){this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t,this._version=r}return e.prototype.init=function(){var e=this;return i.resolve().then(function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(r){var i=t.result,n=t.transaction,a=i.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):i.createObjectStore(e._storeName),o=i.objectStoreNames.contains("last_access")?n.objectStore("last_access"):i.createObjectStore("last_access");o.indexNames.contains("date")||o.createIndex("date","date",{unique:!1}),o.indexNames.contains("byteSize")||o.createIndex("byteSize","byteSize",{unique:!1}),r.oldVersion<e._version&&(a.clear(),o.clear())},a(t)}).then(function(t){e._destroyed?t.close():e._db=t})},e.prototype.destroy=function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0},e.prototype.getHitRate=function(){return this._hit/(this._hit+this._miss)},e.prototype.put=function(e,t){var n=this;return null==this._db?i.reject(new r("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:i.resolve()).then(function(){return n._put(e,t)}).catch(function(r){if(r&&"QuotaExceededError"===r.name)return null==n._quotaReductionPromise&&(n._quotaReductionPromise=n._getCacheSize().then(function(e){return n._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*n.quotaReductionFactor))}),n._quotaReductionPromise.then(function(){return n._quotaReductionPromise=null},function(){return n._quotaReductionPromise=null})),n._quotaReductionPromise.then(function(){return n._put(e,t)});throw r}).then(function(){--n._gcCounter<0&&null!=n._db&&(n._gcCounter=n.gcFrequency,n._getCacheSize().then(function(e){return n._removeLeastRecentlyAccessed(e-n.maxByteSize)}))})},e.prototype.get=function(e){var t=this;return null==this._db?i.resolve(null):i.resolve().then(function(){return a(t._db.transaction(t._storeName,"readonly").objectStore(t._storeName).get(e))}).then(function(r){if(null==r)++t._miss;else if(t._db){++t._hit,t._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:r.byteSize},e)}return r}).catch(function(e){return++t._miss,null})},e.prototype.remove=function(e){var t=this;return null==this._db?i.resolve():i.resolve().then(function(){var r=t._db.transaction([t._storeName,"last_access"],"readwrite"),o=r.objectStore(t._storeName),s=r.objectStore("last_access"),l=o.delete(e),d=s.delete(e);return i.all([a(l),a(d),n(r)])})},e.prototype._put=function(e,t){var r=this._db.transaction([this._storeName,"last_access"],"readwrite"),o=r.objectStore(this._storeName),s=r.objectStore("last_access"),l=o.put(t,e),d=s.put({date:Date.now(),byteSize:t.byteSize},e);return i.all([a(l),a(d),n(r)])},e.prototype._removeLeastRecentlyAccessed=function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),i=t.objectStore("last_access"),a=0,o=i.index("date").openCursor(null,"next");return o.onsuccess=function(t){var n=o.result;null!=n&&(null!=n.value.byteSize&&(a+=n.value.byteSize),r.delete(n.primaryKey),i.delete(n.primaryKey),a<e&&n.continue())},n(t)}},e.prototype._getCacheSize=function(){var e=this._db.transaction("last_access"),t=0,r=e.objectStore("last_access").index("byteSize").openKeyCursor();return r.onsuccess=function(e){var i=r.result;if(i){var n=i.key;null!=n&&(t+=n),i.continue()}},n(e).then(function(){return t})},e}();t.IDBCache=o,t.whenTransaction=n,t.whenRequest=a}.apply(null,i))||(e.exports=n)},2245:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(2246),r(1794)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.create=function(e,t,i){return new r.ComponentMaterial(e,t,i)},e.vertexBufferLayout=i.createVertexBufferLayout}(t.ComponentMaterial||(t.ComponentMaterial={}))}.apply(null,i))||(e.exports=n)},2246:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(5),r(11),r(32),r(144),r(2247),r(1793),r(1794),r(68),r(2249)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u){Object.defineProperty(t,"__esModule",{value:!0});var c=function(e){function t(t,r,i){var n=e.call(this,i)||this;return n.supportsEdges=!0,n._parameters=s.fillDefaults(t),n._geometryParameters=r,n}return r(t,e),Object.defineProperty(t.prototype,"parameters",{get:function(){return this._parameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryParameters",{get:function(){return this._geometryParameters},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasTransparency",{get:function(){var e=this._parameters.forceTransparency;if(n.isSome(e))return e;if(this._parameters.baseColorOpacity<1||this._parameters.layerOpacity<1)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||"replace"!==t.externalColorMixMode||t.externalColor[3]<1},enumerable:!0,configurable:!0}),t.prototype.isVisibleInPass=function(e){if(3!==e)return!0;var t=this._parameters.componentData;return!s.isUniformComponentData(t)||t.castShadows},t.prototype.isVisible=function(){var t=this.parameters;if(!e.prototype.isVisible.call(this))return!1;if(0===t.layerOpacity)return!1;var r=t.componentData;return!s.isUniformComponentData(r)||("replace"===r.externalColorMixMode?r.externalColor[3]>0:t.baseColorOpacity>0)},t.prototype.updateParameters=function(e){var t=!1;for(var r in e){var i=this._parameters[r],n=e[r];i!==n&&(t=!0,this._parameters[r]=n)}return t&&this.notifyDirty("matChanged"),t},t.prototype.intersect=function(e,t,r,i,n,a,o){d.intersectTriangleGeometry(e,t,r,i,n,a,o)},t.prototype.getGLMaterials=function(){return{color:o.GLMaterialColor,depthShadowMap:o.GLMaterialDepthShadowMap,normal:o.GLMaterialNormal,depth:o.GLMaterialDepth,highlight:o.GLMaterialHighlight}},t.prototype.createRenderer=function(e,t){return new u(e,t,this)},t.prototype.createBufferWriter=function(){throw Error("Not supported")},t.prototype.createBufferLayout=function(){return l.createVertexBufferLayout(this.geometryParameters)},t}(a);t.ComponentMaterial=c}.apply(null,i))||(e.exports=n)},2247:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(5),r(1),r(600),r(188),r(601),r(1793),r(68),r(68),r(2248),r(606),r(46)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c,h){function p(e){if(function(e){return!e.parameters.slicePlaneEnabled&&"none"!==e.parameters.cullFace}(e))return{face:"front"===e.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(t,"__esModule",{value:!0});var f=function(e){function t(t,r,i,a){var o=e.call(this,r,i)||this;o._passName=t,o.material=r;var s=r.parameters;return o._baseColorTexture=new u.TextureBinding(a,s.baseColorTexture,{textureUniform:"tex",textureSizeUniform:"texSize",textureUnit:n.DefaultTextureUnits.DIFFUSE}),o.createPrograms(),o.selectPipeline(),o.selectSlot(),o}return r(t,e),t.prototype.createPrograms=function(){var e=this;this.programs=l.BindParametersMap.create(this.material.parameters,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.material.parameters,r=this.material.geometryParameters,i=t.baseColorTexture?r.textureCoordinateRegions?"AtlasTextured":"Textured":"none",n="screen-space"===t.normals||"none"===r.normals?"screenDerivative":"compressed"===r.normals?"compressed":"default";return"color"===this._passName?this.programRep.getProgram(c.colorPass,{textureMode:i,vertexColors:r.colors,doubleSided:t.doubleSidedShading,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO}):"depth"===this._passName||"depthShadowMap"===this._passName?this.programRep.getProgram(c.depthPass,{textureMode:i,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this._passName,slice:t.slicePlaneEnabled}):"normal"===this._passName?this.programRep.getProgram(c.normalPass,{textureMode:i,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):"highlight"===this._passName?this.programRep.getProgram(c.highlightPass,{textureMode:i,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:n,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):void 0},t.prototype.selectPipeline=function(){var e=this.material.parameters;"color"===this._passName?this.pipelineState=h.makePipelineState({blending:function(e){if(e.hasTransparency)return h.separateBlendingParams(770,1,771,771)}(this.material),culling:p(this.material),polygonOffset:e.polygonOffsetEnabled&&w,stencilTest:e.writeStencil&&{function:{func:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams}):this.pipelineState=h.makePipelineState({culling:p(this.material),polygonOffset:e.polygonOffsetEnabled&&w,depthTest:{func:513},depthWrite:h.defaultDepthWriteParams,colorWrite:h.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=this.material.hasTransparency?6:this.material.parameters.writeStencil?2:4},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return l.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){var e=this.material.parameters;this._baseColorTexture.update(e.baseColorTexture),this.createPrograms(),this.selectPipeline(),this.selectSlot()},t.prototype.bind=function(e,t){var r=this.material.parameters,i=this.program=l.BindParametersMap.lookup(this.programs,t);e.bindProgram(i),e.setPipelineState(this.pipelineState),i.setUniform3fv("ambient",r.baseColor),i.setUniform3fv("diffuse",r.baseColor),i.setUniform3fv("specular",x),i.setUniform1f("opacity",r.baseColorOpacity),i.setUniform1f("layerOpacity",r.layerOpacity),s.isUniformComponentData(r.componentData)?(i.setUniform4fv("externalColor",r.componentData.externalColor),i.setUniform1i("colorMixMode",d.colorMixModes[r.componentData.externalColorMixMode])):(i.setUniform4fv("externalColor",b),i.setUniform1i("colorMixMode",d.colorMixModes.multiply),this.material.geometryParameters.componentData&&(r.componentData.updateTexture(),r.componentData.bind(i,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:n.DefaultTextureUnits.COMPONENT_COLOR}))),this._baseColorTexture.bind(e,i),i.setUniform1f("textureAlphaCutoff",.1),"depth"!==this._passName&&"depthShadowMap"!==this._passName||i.setUniform2fv("nearFar",t.nearFar),"highlight"===this._passName&&d.bindHighlightRendering(e,t,i)},t.prototype.bindView=function(e,t){var r=this.material.parameters,i=this.program=l.BindParametersMap.lookup(this.programs,t),n=t.origin;d.bindView(n,t.view,i),d.bindCamPos(n,t.viewInvTransp,i),r.slicePlaneEnabled&&d.bindSlicePlane(n,t.slicePlane,i),"color"===this._passName&&t.shadowMappingEnabled&&t.shadowMap.bindView(i,n),"normal"===this._passName&&i.setUniformMatrix4fv("viewNormal",t.viewInvTransp)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},i([o.manageDisposal()],t.prototype,"_baseColorTexture",void 0),t}(a),m=function(e){function t(t,r,i){var n=e.call(this,"color",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialColor=m;var g=function(e){function t(t,r,i){var n=e.call(this,"depth",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialDepth=g;var y=function(e){function t(t,r,i){var n=e.call(this,"depthShadowMap",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialDepthShadowMap=y;var v=function(e){function t(t,r,i){var n=e.call(this,"normal",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialNormal=v;var _=function(e){function t(t,r,i){var n=e.call(this,"highlight",t,r,i)||this;return n.material=t,n}return r(t,e),t}(f);t.GLMaterialHighlight=_;var b=[1,1,1,1],x=[0,0,0],w={factor:2,units:2}}.apply(null,i))||(e.exports=n)},2248:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(32)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i){var n=this;this._textureRep=e,this._textureId=t,this._options=i,this._textureRef=r.map(this._textureId,function(e){return n._textureRep.aquire(e,!!n._options.initTransparent)})}return e.prototype.dispose=function(){var e=this;this._textureRef=r.map(this._textureId,function(t){e._textureRep.release(t)})},e.prototype.bind=function(e,t){if(r.isSome(this._textureRef)&&(t.setUniform1i(this._options.textureUniform,this._options.textureUnit),e.bindTexture(this._textureRef.getGLTexture(),this._options.textureUnit),this._options.textureSizeUniform)){var i=this._textureRef.getGLTexture();t.setUniform2f(this._options.textureSizeUniform,i.descriptor.width,i.descriptor.height)}},e.prototype.update=function(e){var t=this;e!==this._textureId&&(r.map(this._textureId,function(e){t._textureRep.release(e)}),this._textureRef=r.map(e,function(e){return t._textureRep.aquire(e,!!t._options.initTransparent)}))},e}();t.TextureBinding=i}.apply(null,i))||(e.exports=n)},2249:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(18),r(15),r(101),r(47),r(16),r(403),r(282),r(59),r(41),r(66)],void 0===(n=function(e,t,r,i,n,a,o,s,l,d,u,c){var h=function(){function e(e,t,r){this._material=r,this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._materialRep=t,this._glMaterials=l.acquireMaterials(this._material,this._materialRep)}return e.prototype.dispose=function(){l.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateHighlightCount()},e.prototype.addAndRemoveGeometries=function(e,t){var u=this,h=this._rctx,f=this._dataByOrigin;e.forEach(function(e){var t=e.data;if(t.preinterleaved)if(null!=t.vertexData){var m=e.origin.id,g=e.origin.vec3,y=e.uniqueName,v=f.get(m);v||(v={origin:g,highlightCount:0,dataByGeometry:new Map},f.set(m,v)),o.setMatrixTranslation3(p,-g[0],-g[1],-g[2]);var _=i.mat4f64.create();r.mat4.multiply(_,p,e.transformation);var b=l.generateRenderGeometryVisibleIndexRanges(e),x=l.generateRenderGeometryHighlightRanges(e);x&&(v.highlightCount=null);var w=t.indexCount,C=t.id,I=new s(e.name,0,w,b,x,_,e.instanceParameters,e.idx,C),S=t.indexData?d.createIndex(h,35044,t.indexData):null,D=u._material.createBufferLayout(),M=new c(h,a.Default3D,{geometry:n.glLayout(D)},{geometry:d.createVertex(h,35044)},S);M.vertexBuffers.geometry.setData(t.vertexData),t.indexData=null,t.vertexData=null,v.dataByGeometry.set(y,{instance:I,vao:M})}else o.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else o.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}),t.forEach(function(e){var t=e.origin.id,r=e.uniqueName,i=f.get(t);i.dataByGeometry.get(r).vao.dispose(),i.dataByGeometry.delete(r),0===i.dataByGeometry.size&&f.delete(t)})},e.prototype.updateGeometries=function(e){var t=this;e.forEach(function(e){var r=e.updateType,i=e.renderGeometry,n=i.origin.id,a=i.uniqueName,o=t._dataByOrigin.get(n),s=o&&o.dataByGeometry.get(a).instance;s&&(1&r&&(s.displayedIndexRange=l.generateRenderGeometryVisibleIndexRanges(i)),17&r&&(s.highlightedIndexRanges=l.generateRenderGeometryHighlightRanges(i),o.highlightCount=null),2&r&&console.error("Updating Preinterleaved geometry not supported"),4&r&&l.calculateTransformRelToOrigin(i,s.transformation,s.transformationNormal))})},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.dataByGeometry.forEach(function(e){e.instance.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.render=function(e,t,r,i){var n=this,a=this._rctx,o=this._glMaterials.get(t.pass),s=4===t.pass;if(!o||null!=e&&!o.beginSlot(e)||s&&0===this._highlightCount)return!1;o.bind(a,r);var l=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,o.bindView(a,r),s?e.dataByGeometry.forEach(function(e){l=n.renderInstanceHighlight(o,e,i)||l}):e.dataByGeometry.forEach(function(e){l=n.renderInstance(o,e,i)||l}))}),o.release(a,r),a.bindVAO(null),l},e.prototype.renderInstance=function(e,t,r){var i=t.instance,n=t.vao,a=i.displayedIndexRange;if(a&&0===a.length)return!1;var o=this._rctx,s=e.getProgram(),d=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(n,s),o.bindVAO(n),e.bindInstance(o,i);var c=n.indexBuffer&&n.indexBuffer.indexType;if(a)c?l.drawElementsFaceRange(o,a,i.from,d,c,r):l.drawArraysFaceRange(o,a,i.from,d,r);else{var h=i.to-i.from;c?l.drawElements(o,d,c,i.from,h,r):l.drawArrays(o,d,i.from,h,r)}return!0},e.prototype.renderInstanceHighlight=function(e,t,r){var i=t.instance,n=t.vao,a=i.highlightedIndexRanges;if(!a)return!1;var o=this._rctx,s=e.getProgram(),d=e.getDrawMode();u.assertCompatibleVertexAttributeLocations(n,s),o.bindVAO(n),e.bindInstance(o,i);for(var c=n.indexBuffer&&n.indexBuffer.indexType,h=!1,p=0;p<a.length;p++){var f=a[p],m=f.range?f.range[0]+i.from:i.from,g=f.range?f.range[1]-f.range[0]+1:i.to-i.from;c?l.drawElements(o,d,c,m,g,r):l.drawArrays(o,d,m,g,r),h=!0}return h},e}(),p=i.mat4f64.create();return h}.apply(null,i))||(e.exports=n)}}]);