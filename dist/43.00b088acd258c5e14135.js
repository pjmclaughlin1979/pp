(function(){(this||window).webpackJsonp.registerAbsMids({"esri/core/HandleOwner":1503,"esri/views/layers/LayerView":1504,"esri/views/3d/layers/LayerView3D":1507,"esri/views/3d/layers/support/layerViewUpdatingProperties":1514,"esri/views/3d/layers/i3s/I3SUtil":1516,"esri/views/3d/support/orientedBoundingBox":1523,"esri/views/layers/support/popupUtils":1526,"esri/views/3d/layers/i3s/I3SBinaryReader":1530,"esri/core/libs/gl-matrix-2/quatf32":1543,"esri/layers/graphics/data/FeatureStore":1544,"esri/layers/graphics/data/QueryEngineCapabilities":1545,"esri/views/3d/webgl-engine/lib/HighlightSet":1551,"esri/layers/graphics/data/QueryEngine":1553,"esri/core/libs/rbush/PooledRBush":1558,"esri/views/3d/layers/graphics/Graphics3DFrustumVisibility":1574,"esri/views/3d/layers/graphics/constants":1575,"esri/views/3d/layers/graphics/Graphics3DCore":1576,"esri/renderers/support/rendererConversion":1577,"esri/views/3d/layers/graphics/Graphics3DSymbolCreationContext":1578,"esri/views/3d/layers/graphics/Graphics3DSymbolFactory":1579,"esri/views/3d/layers/graphics/Graphics3DPointSymbol":1580,"esri/views/3d/layers/graphics/Graphics3DElevationAlignment":1581,"esri/views/3d/layers/graphics/Graphics3DHighlights":1582,"esri/views/3d/layers/graphics/Graphics3DHighlightSet":1583,"esri/views/3d/layers/graphics/Graphics3DScaleVisibility":1584,"esri/views/3d/layers/graphics/Graphics3DSpatialIndex":1585,"esri/views/3d/layers/i3s/LEPCC":1588,"esri/layers/support/PromiseQueue":1591,"esri/views/3d/layers/support/attributeUtils":1596,"esri/core/libs/gl-matrix-2/factories/quatf32":1625,"esri/views/3d/support/dito":1631,"esri/renderers/support/renderingInfoUtils":1636,"esri/views/3d/layers/graphics/Graphics3DFeatureLikeLayerView":1637,"esri/views/3d/layers/graphics/Graphics3DFilterVisibility":1638,"esri/views/3d/layers/support/DefinitionExpressionSceneLayerView":1643,"esri/layers/graphics/data/QueryEngineResult":1678,"esri/layers/graphics/data/AttributesBuilder":1679,"esri/views/3d/layers/graphics/Graphics3DVerticalScale":1696,"esri/layers/graphics/controllers/I3SOnDemandController":1706,"esri/views/3d/layers/i3s/I3SFrameTask":1707,"esri/views/3d/layers/i3s/I3SIndex":1708,"esri/views/3d/layers/i3s/I3SLodHandling":1709,"esri/views/3d/layers/i3s/I3SNodeLoader":1710,"esri/views/3d/layers/i3s/I3SViewportQueries":1711,"esri/views/3d/layers/i3s/I3SQueryEngine":1712,"esri/views/3d/layers/support/PopupSceneLayerView":1713,"esri/views/3d/layers/SceneLayerGraphicsView3D":2250,"esri/views/3d/support/GraphicsMap":2251})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[43,5,10],{1503:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(17),i(0)],void 0===(n=function(e,t,i,r,n,a,o){return function(e){function t(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var r=e.call(this)||this;return r.handles=new a,r}return i(t,e),t.prototype.destroy=function(){this.handles.destroy()},r([o.property({readOnly:!0})],t.prototype,"handles",void 0),r([o.subclass("esri.core.HandleOwner")],t)}(o.declared(n))}.apply(null,r))||(e.exports=n)},1504:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(48),i(1503),i(210),i(10),i(209),i(9),i(0)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d){return function(e){function t(t){var i=e.call(this)||this;return i.layer=null,i.parent=null,i.view=null,i}return i(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer),this.when().catch(function(t){if("layerview:create-error"!==t.name){var i=e.layer&&e.layer.id||"no id",r=e.layer&&e.layer.title||"no title";return s.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '"+r+"', id: '"+i+"')",t),u.reject(t)}})},t.prototype.destroy=function(){this.layer=this.view=this.parent=null},Object.defineProperty(t.prototype,"suspended",{get:function(){return!this.canResume()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&this.isUpdating()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullOpacity",{get:function(){var e=function(e){return null==e?1:e};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))},enumerable:!0,configurable:!0}),t.prototype.canResume=function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1},t.prototype.isUpdating=function(){return!1},r([d.property()],t.prototype,"layer",void 0),r([d.property()],t.prototype,"parent",void 0),r([d.property({readOnly:!0,dependsOn:["view","visible","layer.loaded","parent.suspended"]})],t.prototype,"suspended",null),r([d.property({type:Boolean,dependsOn:["suspended"],readOnly:!0})],t.prototype,"updating",null),r([d.property()],t.prototype,"view",void 0),r([d.property({dependsOn:["layer.visible"]})],t.prototype,"visible",null),r([d.property({dependsOn:["layer.opacity","parent.fullOpacity"]})],t.prototype,"fullOpacity",null),r([d.subclass("esri.views.layers.LayerView")],t)}(d.declared(a,n,o.Identifiable,l))}.apply(null,r))||(e.exports=n)},1507:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(9),i(21),i(0),i(357),i(1504)],void 0===(n=function(e,t,i,r,n,a,o,s,l){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.slicePlaneEnabled=!1,t.supportsHeightUnitConversion=!1,t}return i(t,e),t.prototype.postscript=function(e){this.inherited(arguments),s.mayHaveHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())},t.prototype._validateHeightModelInfo=function(){var e=this;return n.create(function(t,i){a.whenFalseOnce(e.view.defaultsFromMap,"isHeightModelInfoSearching",function(){var r=s.rejectLayerError(e.layer,e.view.heightModelInfo,e.supportsHeightUnitConversion);r?i(r):t()})})},r([o.property()],t.prototype,"view",void 0),r([o.property()],t.prototype,"slicePlaneEnabled",void 0),r([o.subclass("esri.views.3d.layers.LayerView3D")],t)}(o.declared(l))}.apply(null,r))||(e.exports=n)},1514:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updatingPercentageValue={value:100,readOnly:!0},t.updatingPercentage={dependsOn:["updating","updatingPercentageValue"],readOnly:!0,value:0,get:function(){return this.updating?this.updatingPercentageValue:0}}}.apply(null,r))||(e.exports=n)},1516:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(50),i(52),i(13),i(9),i(108),i(33),i(18),i(36),i(34),i(45),i(44),i(1587),i(353),i(1530),i(51),i(73)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m){function v(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function b(e,t){var i,r=t[0],n=t[1],a=t[2],o=t[3],s=0;r<e[0]&&(s+=(i=e[0]-r)*i);n<e[1]&&(s+=(i=e[1]-n)*i);a<e[2]&&(s+=(i=e[2]-a)*i);r>e[3]&&(s+=(i=r-e[3])*i);n>e[4]&&(s+=(i=n-e[4])*i);a>e[5]&&(s+=(i=a-e[5])*i);if(s>o*o)return 0;if(s>0)return 1;var l=1/0;return r-e[0]<l&&(l=r-e[0]),n-e[1]<l&&(l=n-e[1]),a-e[2]<l&&(l=a-e[2]),e[3]-r<l&&(l=e[3]-r),e[4]-n<l&&(l=e[4]-n),e[5]-a<l&&(l=e[5]-a),l>o?2:1}function _(e,t,i){for(var r=[],n=i&&i.missingFields,a=i&&i.originalFields,o=0,s=e;o<s.length;o++){for(var l=s[o],u=l.toLowerCase(),d=!1,h=0,c=t;h<c.length;h++){var p=c[h];if(u===p.name.toLowerCase()){r.push(p.name),d=!0,a&&a.push(l);break}}!d&&n&&n.push(l)}return r}function x(e,t,i){if(null!=e.maxRecordCount&&t.length>e.maxRecordCount){var r=function(e,t){for(var i=e.length,r=Math.ceil(i/t),n=[],a=0;a<r;a++){var o=Math.floor(i*a/r),s=Math.floor(i*(a+1)/r);n.push(e.slice(o,s))}return n}(t,e.maxRecordCount);return a.all(r.map(function(t){return x(e,t,i)})).then(C)}var o=new f({objectIds:t,outFields:i,orderByFields:[e.objectIdField]});return new p(e.parsedUrl.path).execute(o).then(function(e){return e&&e.features&&e.features.length===t.length?e.features.map(function(e){return e.attributes}):a.reject(new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function w(e,t,r,o,l){for(var u=[],d=0;d<t.attributeData.length;d++){var h=t.attributeData[d],c=e[d];if(c&&-1!==o.indexOf(c.name)){var p=s.makeAbsolute(h.href,t.baseUrl);u.push({url:p,storageInfo:c})}}return a.eachAlways(u.map(function(e){return i(e.url,{responseType:"array-buffer"}).then(function(t){return y.readBinaryAttribute(e.storageInfo,t.data)})})).then(function(e){var t=[];if(!l.ignoreUnavailableFields&&e.some(function(e){return null==e.value})){for(var i=[],o=0;o<e.length;o++)null==e[o].value&&i.push({name:u[o].storageInfo.name,error:e[o].error});return a.reject(new n("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:i}))}for(var s=0,d=r;s<d.length;s++){var h=d[s],c={};for(o=0;o<e.length;o++)null!=e[o].value&&(c[u[o].storageInfo.name]=S(e[o].value,h));t.push(c)}return t})}function S(e,t){var i=e[t];return o.isInt16Array(e)?i===M?null:i:o.isInt32Array(e)?i===G?null:i:i!=i?null:i}function C(e){for(var t=[],i=0,r=e;i<r.length;i++){var n=r[i];t=t.concat(n)}return t}function I(e){var t=new d(v(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function E(e){var t=new d(v(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function D(e,t,i){if(!c.canProject(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===i&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function F(e,t,i){var r=I(e),n=E(e);D(r,t,i),D(n,t,i)}function V(e){return"mesh-3d"===e.type}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=v,t.getAppropriateTextureEncoding=function(e,i){if(Array.isArray(e)){if(i){var r=e.indexOf(t.DDS_ENCODING_STRING);if(r>-1)return r}for(var n=0;n<e.length;n++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[n])>-1)return n;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1},t.findIntersectingNodes=function(e,t,i,r,n,a){n.traverse(i,function(i){var n=i.mbs;if(t!==r&&(n=P,g.mbsToMbs(i.mbs,r,n,t)),0!==b(e,n))return a(i),!0})},t.filterInPlace=function(e,t,i){for(var r=0,n=0,a=0;a<t.length&&r<e.length;a++)e[r]===t[a]&&(i(a)&&(e[n]=e[r],n++),r++);e.length=n};var O=h.create();t.getClipAABB=function(e,t){var i=l.mat4.copy(m.sm4d.get(),t.objectTransformation),r=t.getGeometryRecords()[0].getShaderTransformation();if(l.mat4.multiply(i,i,r),0===i[1]&&0===i[2]&&0===i[3]&&0===i[4]&&0===i[6]&&0===i[7]&&0===i[8]&&0===i[9]&&0===i[11]&&1===i[15])return O[0]=(e[0]-i[12])/i[0],O[1]=(e[1]-i[13])/i[5],O[2]=(e[2]-i[14])/i[10],O[3]=(e[3]-i[12])/i[0],O[4]=(e[4]-i[13])/i[5],O[5]=(e[5]-i[14])/i[10],O};var P=u.vec4f64.create();t.intersectBoundingBoxWithMbs=b,t.findFieldsCaseInsensitive=_,t.whenGraphicAttributes=function(e,t,i,o,s,l){var u=!0===(l&&l.populateObjectId),d=l.ignoreUnavailableFields?void 0:[],h=1===o.length&&"*"===o[0];!h&&u&&(o=function(e,t){return e.filter(function(e){return e.toLowerCase()!==t.toLowerCase()}).concat([t])}(o,i));var c=h?o:_(o,e.fields,{missingFields:d});if(d&&0!==d.length)return a.reject(new n("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:d}));if(0===t.length)return a.resolve(t);var p=e.associatedLayer,f=e.attributeStorageInfo,y=h?e.fields.map(function(e){return e.name}):c;if(p)return function(e,t,i,r){t.sort(function(e,t){return e.attributes[i]-t.attributes[i]});var n=t.map(function(e){return e.attributes[i]}),a=[],o=_(r,e.fields,{originalFields:a});return x(e,n,o).then(function(e){for(var i=0;i<t.length;i++){var r=t[i],n=e[i];r.attributes={};for(var s=0;s<a.length;s++)r.attributes[a[s]]=n[o[s]]}return t})}(p,t,i,y);var g=function(e,t){for(var i=[],r=0,n=e;r<n.length;r++){var a=n[r];a in t.attributes||i.push(a)}return i}(y,t[0]);if(0===g.length)return a.resolve(t);if(f){var m=s(t);return m?a.all(m.map(function(e){return w(f,e.node,e.indices,g,l).then(function(t){for(var i=0;i<e.graphics.length;i++){for(var r=0,n=y;r<n.length;r++){var a=n[r];a in t[i]||(t[i][a]=e.graphics[i].attributes[a])}e.graphics[i].attributes=t[i]}return e.graphics})})).then(r.flatten):a.reject(new n("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"))}return a.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var M=-Math.pow(2,15),G=-Math.pow(2,31);t.getCachedAttributeValue=S,t.convertFlatRangesToOffsets=function(e,t,i){void 0===i&&(i=2);for(var r=null!=t?t:e.length/i,a=new Uint32Array(r+1),o=0;o<r;o++){var s=e[o*i],l=3*s;a[o]=l;var u=(o-1)*i+1;if(u>=0&&s-1!==e[u])throw new n("Face ranges are not continuous")}var d=3*(e[(r-1)*i+1]+1);return a[a.length-1]=d,a},t.getIndexCrs=I,t.getVertexCrs=E,t.getCacheKeySuffix=function(e,t){return t===g.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=D,t.checkSpatialReferences=F,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null!=e.geometryType&&"triangles"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})},t.checkSceneLayerCompatibleWithView=function(e,t){F(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null==e.geometryType||"points"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})},t.checkPointCloudLayerCompatibleWithView=function(e,t){D(e.spatialReference,t.spatialReference,t.viewingMode)},t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var i=0,r=t;i<r.length;i++){var n=r[i];if(!V(n)||0===n.symbolLayers.length)return!0;for(var a=0,o=n.symbolLayers.items;a<o.length;a++){var s=o[a];if("fill"!==s.type||null==s.material||"replace"!==s.material.colorMixMode)return!0}}return!1};var R=function(){return function(){this.edges=null,this.material=null,this.castShadows=!0}}();t.SymbolInfo=R,t.getSymbolInfo=function(e){for(var t=new R,i=!1,r=!1,n=0,a=e.symbolLayers.items;n<a.length;n++){var o=a[n];if("fill"===o.type&&o.enabled){var s=o.material,l=o.edges;if(s&&!i){var u=s.color;t.material={color:u?[u.r/255,u.g/255,u.b/255]:null,alpha:u?u.a:null,colorMixMode:s.colorMixMode},t.castShadows=o.castShadows,i=!0}l&&!r&&(t.edges=o.edges,r=!0)}}return t}}.apply(null,r))||(e.exports=n)},1523:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(91),i(565),i(362),i(1543),i(4),i(262),i(3),i(45),i(1631),i(29)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h){function c(e,t,i){return{center:l.vec3f64.clone(e),halfSize:s.vec3f32.clone(t),quaternion:a.quatf32.clone(i)}}function p(e,t){var i=h.plane.signedDistance(t,e.center),r=f(e,t);return i>r?1:i<-r?-1:0}function f(e,t){n.quat.conjugate(y,e.quaternion),o.vec3.transformQuat(g,t,y);var i=e.halfSize;return Math.abs(g[0]*i[0])+Math.abs(g[1]*i[1])+Math.abs(g[2]*i[2])}Object.defineProperty(t,"__esModule",{value:!0});var y=a.quatf32.create(),g=s.vec3f32.create(),m=s.vec3f32.create(),v=r.mat3f32.create(),b=function(){return function(e){var t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(var i=0;i<e;i++)this.obbs[i]={center:l.vec3f64.createView(this.buffer,56*i+0),halfSize:s.vec3f32.createView(this.buffer,56*i+24),quaternion:a.quatf32.createView(this.buffer,56*i+36)}}}();t.ObbArray=b,t.create=c,t.clone=function(e){return c(e.center,e.halfSize,e.quaternion)},t.set=function(e,t){o.vec3.copy(t.center,e.center),o.vec3.copy(t.halfSize,e.halfSize),n.quat.copy(t.quaternion,e.quaternion)},t.compute=function(e,t){return t||(t=c([0,0,0],[-1,-1,-1],[0,0,0,1])),d.computeOBB(e,t),t},t.intersectPlane=p,t.toAaBoundingBox=function(e,t){t||(t=u.create());var r=i.mat3.fromQuat(v,e.quaternion),n=e.halfSize[0]*Math.abs(r[0])+e.halfSize[1]*Math.abs(r[3])+e.halfSize[2]*Math.abs(r[6]),a=e.halfSize[0]*Math.abs(r[1])+e.halfSize[1]*Math.abs(r[4])+e.halfSize[2]*Math.abs(r[7]),o=e.halfSize[0]*Math.abs(r[2])+e.halfSize[1]*Math.abs(r[5])+e.halfSize[2]*Math.abs(r[8]);return t[0]=e.center[0]-n,t[1]=e.center[1]-a,t[2]=e.center[2]-o,t[3]=e.center[0]+n,t[4]=e.center[1]+a,t[5]=e.center[2]+o,t},t.minimumDistancePlane=function(e,t){return h.plane.signedDistance(t,e.center)-f(e,t)},t.maximumDistancePlane=function(e,t){return h.plane.signedDistance(t,e.center)+f(e,t)},t.isVisible=function(e,t){return p(e,t.planes[0])<=0&&p(e,t.planes[1])<=0&&p(e,t.planes[2])<=0&&p(e,t.planes[3])<=0&&p(e,t.planes[4])<=0&&p(e,t.planes[5])<=0},t.intersectLine=function(e,t,i,r){void 0===r&&(r=0),n.quat.conjugate(y,e.quaternion),o.vec3.subtract(g,t,e.center);for(var a=o.vec3.transformQuat(g,g,y),s=o.vec3.transformQuat(m,i,y),l=-1/0,u=1/0,d=0;d<3;d++)if(Math.abs(s[d])>1e-6){var h=(r+e.halfSize[d]-a[d])/s[d],c=(-r-e.halfSize[d]-a[d])/s[d];l=Math.max(l,Math.min(h,c)),u=Math.min(u,Math.max(h,c))}else if(a[d]>e.halfSize[d]+r||a[d]<-e.halfSize[d]-r)return!1;return l<=u}}.apply(null,r))||(e.exports=n)},1526:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(22),i(25),i(154),i(32),i(127)],void 0===(n=function(e,t,i,r,n,a,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getRequiredFields=function(e,t){return void 0===t&&(t=e.popupTemplate),r(this,void 0,void 0,function(){var r,s,l,u,d,h,c,p,f,y,g;return i(this,function(i){switch(i.label){case 0:return a.isSome(t)?[4,t.getRequiredFields(e.fields)]:[2,[]];case 1:return r=i.sent(),s=t.lastEditInfoEnabled,l=e.objectIdField,u=e.typeIdField,n.includes(r,"*")?[2,["*"]]:(h=o.fixFields,c=[e.fields],f=(p=r).concat,y=[[u]],(g=s)?[4,o.getFeatureEditFields(e)]:[3,3]);case 2:g=i.sent(),i.label=3;case 3:return(d=h.apply(void 0,c.concat([f.apply(p,y.concat([g||null]))])))&&l&&o.hasField(e.fields,l)&&-1===d.indexOf(l)&&d.push(l),[2,d]}})})},t.getFetchPopupTemplate=function(e,t){return e.popupTemplate?e.popupTemplate:a.isSome(t)&&t.defaultPopupTemplateEnabled&&a.isSome(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}}.apply(null,r))||(e.exports=n)},1530:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(13),i(7),i(10),i(1588)],void 0===(n=function(e,t,i,r,n,a){function o(e,t,r){for(var n="",a=0;a<r;){var o=e[t+a];if(o<128)n+=String.fromCharCode(o),a++;else if(o>=192&&o<224){if(a+1>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var s=(31&o)<<6|63&e[t+a+1];n+=String.fromCharCode(s),a+=2}else if(o>=224&&o<240){if(a+2>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");s=(15&o)<<12|(63&e[t+a+1])<<6|63&e[t+a+2];n+=String.fromCharCode(s),a+=3}else{if(!(o>=240&&o<248))throw new i("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(a+3>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");if((s=(7&o)<<18|(63&e[t+a+1])<<12|(63&e[t+a+2])<<6|63&e[t+a+3])>=65536){var l=55296+(s-65536>>10),u=56320+(1023&s);n+=String.fromCharCode(l,u)}else n+=String.fromCharCode(s);a+=4}}return n}function s(e,i){for(var r={byteOffset:0,byteCount:0,fields:Object.create(null)},n=0,a=0;a<i.length;a++){var o=i[a],s=o.valueType||o.type,l=t.valueType2ArrayBufferReader[s];r.fields[o.property]=l(e,n),n+=t.valueType2TypedArrayClassMap[s].BYTES_PER_ELEMENT}return r.byteCount=n,r}function l(e,t,r){var n,a,s=[],l=0;for(a=0;a<e;a+=1){if((n=t[a])>0){if(s.push(o(r,l,n-1)),0!==r[l+n-1])throw new i("string-array-error","Invalid string array: missing null termination.")}else s.push(null);l+=n}return s}function u(e,i){return new(0,t.valueType2TypedArrayClassMap[i.valueType])(e,i.byteOffset,i.count*i.valuesPerElement)}function d(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function h(e,t,n){for(var a=null!=t.header?s(e,t.header):{byteOffset:0,byteCount:0,fields:{count:n}},o={header:a,byteOffset:a.byteCount,byteCount:0,entries:Object.create(null)},l=a.byteCount,u=0;u<t.ordering.length;u++){var d=t.ordering[u],h=r.clone(t[d]);if(h.count=a.fields.count,"String"===h.valueType){if(h.byteOffset=l,h.byteCount=a.fields[d+"ByteCount"],"UTF-8"!==h.encoding)throw new i("unsupported-encoding","Unsupported String encoding.",{encoding:h.encoding})}else{if(!p(h.valueType))throw new i("unsupported-value-type","Unsupported binary valueType",{valueType:h.valueType});var c=f(h.valueType);l+=l%c!=0?c-l%c:0,h.byteOffset=l,h.byteCount=c*h.valuesPerElement*h.count}l+=h.byteCount,o.entries[d]=h}return o.byteCount=l-o.byteOffset,o}function c(e,t,r){if(t!==e&&y.error("Invalid "+r+" buffer size\n expected: "+e+", actual: "+t+")"),t<e)throw new i("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function p(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function f(e){return p(e)&&t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT}Object.defineProperty(t,"__esModule",{value:!0});var y=n.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");t.readHeader=s,t.readStringArray=l,t.createTypedView=u,t.createRawView=d,t.createAttributeDataIndex=h,t.createGeometryDataIndex=function(e,t,i){var n=s(e,t&&t.header),a=n.byteCount,o={header:n,byteOffset:n.byteCount,byteCount:0,vertexAttributes:r.clone(t.vertexAttributes)},l=o.vertexAttributes;i||null==l.region||delete l.region;for(var u=n.fields,d=null!=u.vertexCount?u.vertexCount:u.count,h=0;h<t.ordering.length;h++){var p=t.ordering[h];null!=l[p]&&(l[p].byteOffset=a,l[p].count=d,a+=f(l[p].valueType)*l[p].valuesPerElement*d)}var y=u.faceCount;if(t.faces&&y){o.faces=r.clone(t.faces);var g=o.faces;for(h=0;h<t.ordering.length;h++){var m=t.ordering[h];null!=g[m]&&(g[m].byteOffset=a,g[m].count=y,a+=f(g[m].valueType)*g[m].valuesPerElement*y)}}var v=u.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&v){o.featureAttributes=r.clone(t.featureAttributes);var b=o.featureAttributes;for(h=0;h<t.featureAttributeOrder.length;h++){var _=t.featureAttributeOrder[h];b[_].byteOffset=a,b[_].count=v;var x=f(b[_].valueType);"UInt64"===b[_].valueType&&(x=8),a+=x*b[_].valuesPerElement*v}}return c(a,e.byteLength,"geometry"),o.byteCount=a-o.byteOffset,o},t.readBinaryAttribute=function(e,t,r){if("lepcc-rgb"===e.encoding)return a.decodeRGB(t);if("lepcc-intensity"===e.encoding)return a.decodeIntensity(t);if(null!=e.encoding&&""!==e.encoding)throw new i("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(y.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(y.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var n=h(t,e,r);c(n.byteOffset+n.byteCount,t.byteLength,"attribute");var o=n.entries.attributeValues||n.entries.objectIds;if(o){if("String"===o.valueType){var s=n.entries.attributeByteCounts,p=u(t,s),f=d(t,o);return l(s.count,p,f)}return u(t,o)}throw new i("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=p,t.getBytesPerValue=f}.apply(null,r))||(e.exports=n)},1543:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1625)],void 0===(n=function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.quatf32=i}.apply(null,r))||(e.exports=n)},1544:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(22),i(25),i(546),i(13),i(19),i(10),i(1533),i(37),i(547)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d){Object.defineProperty(t,"__esModule",{value:!0});var h=[],c=s.getLogger("esri.layers.graphics.data.FeatureStore"),p={minX:0,minY:0,maxX:0,maxY:0},f=function(){function e(e){this._featuresById=new n.default,this._boundsByFeature=new n.default,this._featuresByBounds=new n.default,this._index=l(9,o("csp-restrictions")?function(e){return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}:["[0]","[1]","[2]","[3]"]),this._geometryInfo=e}return Object.defineProperty(e.prototype,"geometryType",{get:function(){return this._geometryInfo.geometryType},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasM",{get:function(){return this._geometryInfo.hasM},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasZ",{get:function(){return this._geometryInfo.hasZ},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numFeatures",{get:function(){return this._featuresById.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullBounds",{get:function(){if(!this.numFeatures)return null;var e=u.create(u.NEGATIVE_INFINITY);return this._boundsByFeature.forEach(function(t){t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]))}),e},enumerable:!0,configurable:!0}),e.prototype.setEngine=function(e){this._engine=e},e.prototype.add=function(e){this._add(e,h),this._index.load(h),this._clearCache(),h.length=0},e.prototype.addMany=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._add(r,h)}this._index.load(h),this._clearCache(),h.length=0},e.prototype.clear=function(){this._featuresById.clear(),this._boundsByFeature.clear(),this._featuresByBounds.clear(),this._index.clear(),this._clearCache()},e.prototype.removeManyById=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=this._featuresById.get(r);if(n){var a=this._boundsByFeature.get(n);a&&(this._index.remove(a),this._featuresByBounds.delete(a)),this._boundsByFeature.delete(n)}this._featuresById.delete(r)}this._clearCache()},e.prototype.forEachBounds=function(e,t){for(var i=0,r=e;i<r.length;i++){var n=r[i],a=this._boundsByFeature.get(n);a&&t(a,n)}},e.prototype.getFeature=function(e){return this._featuresById.get(e)},e.prototype.has=function(e){return this._featuresById.has(e)},e.prototype.forEach=function(e){this._featuresById.forEach(function(t){return e(t)})},e.prototype.forEachInBounds=function(e,t){for(var i=0,r=function(e,t){return p.minX=t[0],p.minY=t[1],p.maxX=t[2],p.maxY=t[3],e.search(p)}(this._index,e);i<r.length;i++){var n=r[i];t(this._featuresByBounds.get(n))}},e.prototype.transferIds=function(e,t){for(var i=[],r=0,n=t;r<n.length;r++){var a=n[r],o=this._featuresById.get(a);o&&(this._remove(o),i.push(o))}e.addMany(i),this._clearCache()},e.prototype.transferIdRange=function(e,t,i){for(var r=[],n=t;n<i;n++){var a=this._featuresById.get(n);a&&(this._remove(a),r.push(a))}e.addMany(r),this._clearCache()},e.prototype.transferIf=function(e,t){var i=this,r=[];this._featuresById.forEach(function(e,n){t(e)&&(i._remove(e),r.push(e))}),e.addMany(r),this._clearCache()},e.prototype.transferAll=function(e){var t=this,i=[];this._featuresById.forEach(function(e,r){t._remove(e),i.push(e)}),e.addMany(i),this._clearCache()},e.prototype._clearCache=function(){this._engine&&this._engine.clearCache()},e.prototype._add=function(e,t){if(e){var i=e.objectId;if(null==i)return void c.error(new a("featurestore:invalid-feature","feature id is missing",{feature:e}));var r,n=this._featuresById.get(i);if(n&&(r=this._boundsByFeature.get(n))&&(this._index.remove(r),this._boundsByFeature.delete(n),this._featuresByBounds.delete(r)),!e.geometry)return this._boundsByFeature.set(e,null),void this._featuresById.set(i,e);r=d.getBoundsOptimizedGeometry(r||u.create(),e.geometry,this._geometryInfo.hasZ,this._geometryInfo.hasM),this._boundsByFeature.set(e,r),this._featuresByBounds.set(r,e),this._featuresById.set(i,e),t.push(r)}},e.prototype._remove=function(e){var t;e&&((t=this._boundsByFeature.get(e))&&(this._index.remove(t),this._boundsByFeature.delete(e),this._featuresByBounds.delete(t)),this._featuresById.delete(e.objectId))},e}();t.default=f}.apply(null,r))||(e.exports=n)},1545:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.queryCapabilities={supportsStatistics:!0,supportsCentroid:!0,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0}}.apply(null,r))||(e.exports=n)},1551:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){return function(){function e(){this.items=[]}return e.prototype.addObject=function(e,t){this.items.push({type:"object",highlightId:t,object:e})},e.prototype.addRenderGeometry=function(e,t,i){this.items.push({type:"renderGeometry",highlightId:t,renderGeometry:e,owner:i})},e.prototype.addExternal=function(e,t){this.items.push({type:"external",highlightId:t,remove:e})},e.prototype.remove=function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];i.highlightId===e&&(this.removeHighlight(i),this.items.splice(t,1))}},e.prototype.removeObject=function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];"object"===i.type&&i.object===e&&(this.removeHighlight(i),this.items.splice(t,1))}},e.prototype.removeRenderGeometry=function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];"renderGeometry"===i.type&&i.renderGeometry===e&&(this.removeHighlight(i),this.items.splice(t,1))}},e.prototype.removeAll=function(){var e=this;this.items.forEach(function(t){e.removeHighlight(t)}),this.items=[]},e.prototype.removeHighlight=function(e){switch(e.type){case"object":e.object.removeHighlights(e.highlightId);break;case"renderGeometry":e.owner.removeRenderGeometryHighlight(e.renderGeometry,e.highlightId);break;case"external":e.remove(e.highlightId)}},e}()}.apply(null,r))||(e.exports=n)},1553:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(11),i(154),i(546),i(170),i(97),i(13),i(7),i(10),i(274),i(9),i(82),i(37),i(549),i(69),i(96),i(1554),i(1518),i(1545),i(1678),i(1607),i(1590),i(1562),i(1591)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m,v,b,_,x,w,S,C){function I(e,t,i,r,n,a,o,s,l){l||(l=E),o&&!a?r.forEachInBounds(n,function(r){if(!t.has(r.objectId)){var n=S.getCentroid(i,r,s),a=r.attributes;n&&(t.add(r.objectId),e.push(new F(a,null,n,l(r))))}}):a&&!o?r.forEachInBounds(n,function(r){if(!t.has(r.objectId)){var n=r.attributes,a=S.getGeometry(i,r,0,s);a&&(t.add(r.objectId),e.push(new F(n,a,null,l(r))))}}):r.forEachInBounds(n,function(r){if(!t.has(r.objectId)){var n=r.attributes,a=S.getGeometry(i,r,0,s),o=S.getCentroid(i,r,s);a&&o&&(t.add(r.objectId),e.push(new F(n,a,o,l(r))))}})}Object.defineProperty(t,"__esModule",{value:!0});var E=function(e){return 1},D=u.getLogger("esri.layers.graphics.data.QueryEngine"),F=function(){return function(e,t,i,r){this.attributes=e,this.geometry=t,this.centroid=i,this.filterFlags=r}}(),V=new a.default,O=new d.Storage(2e6),P=0,M=function(){function e(e){var t=this;this.capabilities={query:b.queryCapabilities},this.fieldsMap=new n.default,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.featureStore=e.featureStore,this.featureStore.setEngine(this),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new d(P+++"$$",O)),e.fields.forEach(function(e){t.fieldsMap.set(e.name.trim(),e),t.fieldsMap.set(e.name.trim().toLowerCase(),e)}),e.scheduler&&e.priority&&(this._frameQueue=new C.PromiseQueue,this._frameTask=e.scheduler.registerTask(e.priority,function(e){return t._update(e)},function(){return t._frameQueue.length>0}))}return e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this.fieldsMap.clear()},Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:S.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:(this._timeExtent=w.getTimeExtent(this.timeInfo,this.featureStore),this._timeExtent):null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},e.prototype.executeQuery=function(e){var t=this;void 0===e&&(e={});var i=l.clone(e);return o.safeCast(S.normalizeQuery(i,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(i)}).catch(function(e){if(e===S.QUERY_ENGINE_EMPTY_RESULT)return new _.default([],null,t);throw e}).then(function(e){return e.createQueryResponse(i)})},e.prototype.executeQueryForCount=function(e){var t=this;void 0===e&&(e={});var i=l.clone(e);return i.returnGeometry=!1,i.returnCentroid=!1,i.outSR=null,o.safeCast(S.normalizeQuery(i,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(i)}).then(function(e){return e.size}).catch(function(e){if(e===S.QUERY_ENGINE_EMPTY_RESULT)return 0;throw e})},e.prototype.executeQueryForExtent=function(e){var t=this;void 0===e&&(e={});var i=l.clone(e),r=i.outSR;return o.safeCast(S.normalizeQuery(i,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._checkQuerySupport(e)}).then(function(){return i.returnGeometry=!0,i.returnCentroid=!1,i.outSR=null,i}).then(function(e){return t._reschedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){var i=e.size;if(!i)return{count:i,extent:null};var n={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:S.cleanFromGeometryEngine(t.spatialReference)};t.featureStore.forEachBounds(e.items,function(e){n.xmin=Math.min(e[0],n.xmin),n.ymin=Math.min(e[1],n.ymin),n.xmax=Math.max(e[2],n.xmax),n.ymax=Math.max(e[3],n.ymax)});var a=v.project(n,e.spatialReference,r);if(a.spatialReference=S.cleanFromGeometryEngine(r||t.spatialReference),a.xmax-a.xmin==0){var o=c.getMetersPerUnitForSR(a.spatialReference);a.xmin-=o,a.xmax+=o}if(a.ymax-a.ymin==0){o=c.getMetersPerUnitForSR(a.spatialReference);a.ymin-=o,a.ymax+=o}return{count:i,extent:a}}).catch(function(e){if(e===S.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw e})},e.prototype.executeQueryForIds=function(e){return void 0===e&&(e={}),this.executeQueryForIdSet(e).then(function(e){return r.from(e)})},e.prototype.executeQueryForIdSet=function(e){var t=this;void 0===e&&(e={});var i=l.clone(e);return i.returnGeometry=!1,i.returnCentroid=!1,i.outSR=null,o.safeCast(S.normalizeQuery(i,this.definitionExpression,this.spatialReference)).then(function(e){return t._schedule(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeObjectIdsQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeTimeQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){return e.executeAttributesQuery(i)}).then(function(e){return t._reschedule(e)}).then(function(e){for(var t=e.items,i=new a.default,r=0,n=t;r<n.length;r++){var o=n[r];i.add(o.objectId)}return i}).catch(function(e){if(e===S.QUERY_ENGINE_EMPTY_RESULT)return new a.default;throw e})},e.prototype.executeTileQuery=function(e,t,i){var r=this;void 0===i&&(i=null);var n=t.returnGeometry,o=t.returnCentroid,s=t.pixelBuffer,l=new a.default,u=[],d=s*e.resolution,h=p.pad(e.bounds,d,p.create());if(I(u,l,this,this.featureStore,h,n,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},i),"esriGeometryPoint"===this.geometryType||o){var c=g.getInfo(this.spatialReference);if(c){var f=c.valid,y=f[0],m=f[1];if(h[0]<y){var v=p.fromValues(m-d,h[1],m,h[3]);I(u,l,this,this.featureStore,v,n,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[m,e.bounds[3]]},i)}if(h[2]>m){var b=p.fromValues(y,h[1],y+d,h[3]);I(u,l,this,this.featureStore,b,n,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[y-m+e.bounds[0],e.bounds[3]]},i)}}}return u.sort(function(e,t){return e.attributes[r.objectIdField]-t.attributes[r.objectIdField]}),{features:u,objectIds:l}},e.prototype.executeTileQueryForIds=function(e,t){var i=t.pixelBuffer*e.resolution,r=p.pad(e.bounds,i,p.create()),n=[];return this.featureStore.forEachInBounds(r,function(e){return n.push(e.objectId)}),n},e.prototype.executeQueryForLatestObservations=function(e){var t=this;return this.timeInfo?this.executeQuery(e).then(function(e){return t._filterLatest(e,t.timeInfo)}):void D.error(new s("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._schedule=function(e){return this._frameQueue?this._frameQueue.push(e).then(function(e){return e}):h.resolve(e)},e.prototype._reschedule=function(e){return this._frameQueue?this._frameQueue.push(e).then(function(e){return e}):h.resolve(e)},e.prototype._update=function(e){for(this._budget=e;!e.done&&this._frameQueue.process();)e.madeProgress();this._budget=null},e.prototype._filterLatest=function(e,t){for(var r=t.trackIdField,a=t.startTimeField,o=t.endTimeField||a,s=new n.default,l=[],u=0,d=e.features;u<d.length;u++){var h=d[u],c=h.attributes[r],p=h.attributes[o];(!s.has(c)||s.get(c).attributes[o]<p)&&s.set(c,h)}return s.forEach(function(e){return l.push(e)}),i({},e,{features:l})},e.prototype._getAll=function(){if(!this._allItems){var e=[];this.featureStore.forEach(function(t){return e.push(t)}),this._allItems=new _.default(e,null,this)}return this._allItems},e.prototype._executeGeometryQuery=function(e){var t=this,i=e.geometry,r=e.outSR,n=e.spatialRel,o=g.isValid(r)&&!g.equals(this.spatialReference,r),s=this.cacheSpatialQueries?o?JSON.stringify({geometry:i,spatialRelationship:n,outSpatialReference:r}):JSON.stringify({geometry:i,spatialRelationship:n}):null;if(s){var l=this._geometryQueryCache.get(s);if(void 0!==l)return h.resolve(l)}var u=function(i){return o&&(e.returnGeometry||e.returnCentroid)?i.project(r).then(function(e){return s&&t._geometryQueryCache.put(s,e,e.size||1),e}):(s&&t._geometryQueryCache.put(s,i,i.size||1),i)};if(!i)return h.resolve(this._getAll()).then(function(e){return u(e)});if("esriSpatialRelDisjoint"===n){var d,c,p=this._searchFeatures(this._getQueryBBoxes(i));return p.length?this._reschedule(p).then(function(e){return new a.default(e)}).then(function(e){return t._reschedule(e)}).then(function(e){var i=0;d=new Array(e.size),t.featureStore.forEach(function(e){return d[i++]=e}),c=e}).then(function(){return t._reschedule()}).then(function(){return x.getSpatialQueryOperator(n,i,t)}).then(function(e){return t._runSpatialFilter(d,function(t){return!c.has(t)||e(t.geometry)}).then(function(e){return new _.default(e,i,t)}).then(function(e){return u(e)})}):h.resolve(this._getAll()).then(function(e){return u(e)})}var f=this._searchFeatures(this._getQueryBBoxes(i));if(!f.length){var y=new _.default([],i,this);return s&&this._geometryQueryCache.put(s,y,y.size||1),h.resolve(y)}return this._canExecuteSoloPass(i,e)?h.resolve(new _.default(f,i,this)).then(function(e){return u(e)}):x.getSpatialQueryOperator(n,i,this).then(function(e){return t._runSpatialFilter(f,function(t){return e(t.geometry)})}).then(function(e){return new _.default(e,i,t)}).then(function(e){return u(e)})},e.prototype._runSpatialFilter=function(e,t){var i=this;if(!t)return h.resolve(e);if(!this._budget)return h.resolve(e.filter(function(e){return t(e)}));var r=0,n=new Array,a=function(){for(;r<e.length;){var o=e[r];if(t(o)&&n.push(o),i._budget.done)return i._reschedule().then(function(){return a()});++r}return h.resolve()};return this._reschedule().then(function(){return a()}).then(function(){return n})},e.prototype._canExecuteSoloPass=function(e,t){var i=this.geometryType,r=t.spatialRel;return x.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===i&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))},e.prototype._getQueryBBoxes=function(e){if(x.canQueryWithRBush(e)){if(y.isExtent(e))return[p.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(y.isPolygon(e))return e.rings.map(function(e){return p.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}return[f.getBoundsXY(p.create(),e)]},e.prototype._searchFeatures=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this.featureStore.forEachInBounds(r,function(e){V.add(e)})}var n=new Array(V.size),a=0;return V.forEach(function(e){return n[a++]=e}),V.clear(),n},e.prototype._checkQuerySupport=function(e){return e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text?h.reject(new s("feature-store:unsupported-query","Unsupported query options",{query:e})):h.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),x.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),v.checkProjectionSupport(this.spatialReference,e.outSR)]).then(function(){return e})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,i=e.orderByFields,r=e.returnDistinctValues;if(i&&i.length>0){var n=i.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});m.validateFields(this.fieldsMap,n,"orderByFields contains missing fields")}if(t&&t.length>0)m.validateFields(this.fieldsMap,t,"outFields contains missing fields");else if(r)throw new s("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});m.validateWhere(this.fieldsMap,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){var t=e.outStatistics,i=e.groupByFieldsForStatistics,r=e.having,n=i&&i.length,a=t&&t.length;if(r){if(!n||!a)return h.reject(new s("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e}));m.validateHaving(this.fieldsMap,r,t)}if(a){if(t.some(function(e){return"exceedslimit"===e.statisticType}))return;var o=t.map(function(e){return e.onStatisticField});m.validateFields(this.fieldsMap,o,"onStatisticFields contains missing fields"),n&&m.validateFields(this.fieldsMap,i,"groupByFieldsForStatistics contains missing fields");for(var l=0,u=t;l<u.length;l++){var d=u[l],c=d.onStatisticField,p=d.statisticType;if("exceedslimit"===p)return h.reject(new s("feature-store:unsupported-query","statistic type exceedslimit is not supported",{definition:d,query:e}));if((!n||"count"!==p)&&c&&m.hasInvalidFieldType(c,this.fieldsMap))return h.reject(new s("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:d,query:e}))}}},e}();t.default=M}.apply(null,r))||(e.exports=n)},1558:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(88),i(1603)],void 0===(n=function(e,t,i,r){function n(e,t,i){if(!i)return t.indexOf(e);for(var r=0;r<t.length;r++)if(i(e,t[r]))return r;return-1}function a(e,t){o(e,0,e.children.length,t,e)}function o(e,t,i,r,n){n||(n=g(null,!0)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var a=t,o=void 0;a<i;a++)o=e.children[a],s(n,e.leaf?r(o):o);return n}function s(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function l(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function d(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function h(e){return e.maxX-e.minX+(e.maxY-e.minY)}function c(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function p(e,t){var i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),a=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,a-r)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function y(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e,t){return{children:e,height:1,leaf:t,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(e,t,i,n,a){for(var o=[t,i];o.length;)if(!((i=o.pop())-(t=o.pop())<=n)){var s=t+Math.ceil((i-t)/n/2)*n;r(e,s,t,i,a),o.push(t,s,s,i)}}Object.defineProperty(t,"__esModule",{value:!0});var v=function(){function e(e,t){void 0===e&&(e=9),this.compareMinX=l,this.compareMinY=u,this.toBBox=function(e){return e},this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}return e.prototype.destroy=function(){this.clear(),b.prune(),_.prune(),x.prune(),w.prune()},e.prototype.all=function(e){this._all(this.data,e)},e.prototype.search=function(e,t){var i=this.data,r=this.toBBox;if(y(e,i))for(b.clear();i;){for(var n=0,a=i.children.length;n<a;n++){var o=i.children[n],s=i.leaf?r(o):o;y(e,s)&&(i.leaf?t(o):f(e,s)?this._all(o,t):b.push(o))}i=b.pop()}},e.prototype.collides=function(e){var t=this.data,i=this.toBBox;if(!y(e,t))return!1;for(b.clear();t;){for(var r=0,n=t.children.length;r<n;r++){var a=t.children[r],o=t.leaf?i(a):a;if(y(e,o)){if(t.leaf||f(e,o))return!0;b.push(a)}}t=b.pop()}return!1},e.prototype.load=function(e,t){if(void 0===t&&(t=e.length),!t)return this;if(t<this._minEntries){for(var i=0,r=t;i<r;i++)this.insert(e[i]);return this}var n=this._build(e.slice(0,t),0,t-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var a=this.data;this.data=n,n=a}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},e.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},e.prototype.clear=function(){return this.data=g([],!0),this},e.prototype.remove=function(e,t){if(!e)return this;var i,r,a,o,s=this.data,l=this.toBBox(e);for(x.clear(),w.clear();s||x.length;){if(s||(s=x.pop(),i=x.data[x.length-1],r=w.pop(),a=!0),s.leaf&&-1!==(o=n(e,s.children,t)))return s.children.splice(o,1),x.push(s),this._condense(x),this;a||s.leaf||!f(s,l)?i?(r++,s=i.children[r],a=!1):s=null:(x.push(s),w.push(r),r=0,i=s,s=s.children[0])}return this},e.prototype.toJSON=function(){return this.data},e.prototype.fromJSON=function(e){return this.data=e,this},e.prototype._all=function(e,t){for(_.clear();e;){if(!0===e.leaf)for(var i=0,r=e.children;i<r.length;i++){t(r[i])}else _.pushArray(e.children);e=_.pop()}},e.prototype._build=function(e,t,i,r){var n,o=i-t+1,s=this._maxEntries;if(o<=s)return a(n=g(e.slice(t,i+1),!0),this.toBBox),n;r||(r=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,r-1))),(n=g([],!1)).height=r;var l=Math.ceil(o/s),u=l*Math.ceil(Math.sqrt(s));m(e,t,i,u,this.compareMinX);for(var d=t;d<=i;d+=u){var h=Math.min(d+u-1,i);m(e,d,h,l,this.compareMinY);for(var c=d;c<=h;c+=l){var p=Math.min(c+l-1,h);n.children.push(this._build(e,c,p,r-1))}}return a(n,this.toBBox),n},e.prototype._chooseSubtree=function(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){for(var n=1/0,a=1/0,o=void 0,s=0,l=t.children.length;s<l;s++){var u=t.children[s],h=d(u),p=c(e,u)-h;p<a?(a=p,n=h<n?h:n,o=u):p===a&&h<n&&(n=h,o=u)}t=o||t.children[0]}return t},e.prototype._insert=function(e,t,i){var r=this.toBBox,n=i?e:r(e);x.clear();var a=this._chooseSubtree(n,this.data,t,x);for(a.children.push(e),s(a,n);t>=0&&x.data[t].children.length>this._maxEntries;)this._split(x,t),t--;this._adjustParentBBoxes(n,x,t)},e.prototype._split=function(e,t){var i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);var o=this._chooseSplitIndex(i,n,r),s=g(i.children.splice(o,i.children.length-o),i.leaf);s.height=i.height,a(i,this.toBBox),a(s,this.toBBox),t?e.data[t-1].children.push(s):this._splitRoot(i,s)},e.prototype._splitRoot=function(e,t){this.data=g([e,t],!1),this.data.height=e.height+1,a(this.data,this.toBBox)},e.prototype._chooseSplitIndex=function(e,t,i){var r,n,a;r=n=1/0;for(var s=t;s<=i-t;s++){var l=o(e,0,s,this.toBBox),u=o(e,s,i,this.toBBox),h=p(l,u),c=d(l)+d(u);h<r?(r=h,a=s,n=c<n?c:n):h===r&&c<n&&(n=c,a=s)}return a},e.prototype._chooseSplitAxis=function(e,t,i){var r=e.leaf?this.compareMinX:l,n=e.leaf?this.compareMinY:u;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)},e.prototype._allDistMargin=function(e,t,i,r){e.children.sort(r);for(var n=this.toBBox,a=o(e,0,t,n),l=o(e,i-t,i,n),u=h(a)+h(l),d=t;d<i-t;d++){var c=e.children[d];s(a,e.leaf?n(c):c),u+=h(a)}for(d=i-t-1;d>=t;d--){c=e.children[d];s(l,e.leaf?n(c):c),u+=h(l)}return u},e.prototype._adjustParentBBoxes=function(e,t,i){for(var r=i;r>=0;r--)s(t.data[r],e)},e.prototype._condense=function(e){for(var t=e.length-1,i=void 0;t>=0;t--)0===e.data[t].children.length?t>0?(i=e.data[t-1].children).splice(i.indexOf(e.data[t]),1):this.clear():a(e.data[t],this.toBBox)},e.prototype._initFormat=function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")},e}();t.PooledRBush=v;var b=new i,_=new i,x=new i,w=new i({deallocator:null});t.default=v}.apply(null,r))||(e.exports=n)},1574:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(17),i(21),i(0),i(49),i(572)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u){var d=-.3*l.earthRadius;return function(e){function t(){var t=e.call(this)||this;return t.suspended=!0,t._frustumVisibilityDirty=!0,t.extent=null,t.extentIntersectionDirty=!0,t._isVisibleBelowSurface=!1,t.handles=new a,t.layerView=null,t}return i(t,e),Object.defineProperty(t.prototype,"frustumVisibilityDirty",{get:function(){return this._frustumVisibilityDirty},set:function(e){e!==this._frustumVisibilityDirty&&(this._frustumVisibilityDirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.frustumVisibilityDirty},enumerable:!0,configurable:!0}),t.prototype.setup=function(e){var t=this;this.layerView=e,this.extentIntersection=new u.FrustumExtentIntersection({renderCoordsHelper:e.view.renderCoordsHelper});var i=e.view,r=i.basemapTerrain,n=i.resourceController.scheduler;this.handles.add([i.on("resize",function(){return t.viewChange()}),i.state.watch("camera",function(){return t.viewChange()},!0),n.registerTask(6,function(){return t.update()},function(){return t.needsUpdate()}),r.on("elevation-bounds-change",function(){return t.elevationBoundsChange()})]),"local"===i.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add(o.init(r,["opacity","wireframe"],function(){return t.isVisibleBelowSurface=!r.isOpaque()}))},t.prototype.destroy=function(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)},t.prototype.setExtent=function(e){this.extent=e,this.extentIntersectionDirty=!0,this.frustumVisibilityDirty=!0},t.prototype.viewChange=function(){this.frustumVisibilityDirty=!0},t.prototype.elevationBoundsChange=function(){this.frustumVisibilityDirty=!0,this.extentIntersectionDirty=!0},Object.defineProperty(t.prototype,"isVisibleBelowSurface",{set:function(e){this._isVisibleBelowSurface=e,this.frustumVisibilityDirty=!0,this.extentIntersectionDirty=!0},enumerable:!0,configurable:!0}),t.prototype.needsUpdate=function(){return this.frustumVisibilityDirty},t.prototype.update=function(){this.updateSuspendFrustumVisible(),this.frustumVisibilityDirty=!1},t.prototype.updateExtentIntersection=function(){if(this.extentIntersectionDirty){this.extentIntersectionDirty=!1;var e,t=this.layerView.view;if(this._isVisibleBelowSurface)e=d;else{var i=t.basemapTerrain.getElevationBounds(),r=i[0],n=i[1];e=r-Math.max(1,(n-r)*(1.2-1))}this.extentIntersection.update(this.extent,t.spatialReference,e)}},t.prototype.updateSuspendFrustumVisible=function(){if(this.extent){this.updateExtentIntersection();var e=this.layerView.view.frustum;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e))}else this._set("suspended",!1)},r([s.property({readOnly:!0})],t.prototype,"suspended",void 0),r([s.property({readOnly:!0})],t.prototype,"updating",null),r([s.subclass("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],t)}(s.declared(n))}.apply(null,r))||(e.exports=n)},1575:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultIconElevationOffset=1,t.SUSPEND_RESUME_EXTENT_OPTIMISM=1.2}.apply(null,r))||(e.exports=n)},1576:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(22),i(25),i(43),i(359),i(62),i(6),i(52),i(23),i(13),i(17),i(179),i(10),i(92),i(32),i(132),i(80),i(88),i(9),i(21),i(0),i(3),i(45),i(37),i(126),i(128),i(555),i(1577),i(81),i(560),i(573),i(178),i(570),i(1578),i(1579),i(571),i(72),i(181),i(51),i(137),i(85),i(375),i(368)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m,v,b,_,x,w,S,C,I,E,D,F,V,O,P,M,G,R,N,A,T,L,j,U,B,q,z,Q,k){var H=new o.Point,Y=C.vec3f64.create(),X=I.create(),W=y.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),Z=function(e){function t(t){var i=e.call(this)||this;return i.propertiesPool=new q.PropertiesPool({computedExtent:o.Extent},i),i.computedExtent=null,i.currentRenderer=null,i.rendererHasGeometryOperations=!1,i.symbolCreationContext=new A.Graphics3DSymbolCreationContext,i.graphics=new Map,i.stageLayer=null,i.stage=null,i.graphicsDrapedUids=new Set,i.graphicsBySymbol=new Map,i.symbolConversionCache=new Map,i.symbols=new Map,i.graphicsWithoutSymbol={},i.graphicsWaitingForSymbol=new Set,i.lastFastUpdate=null,i.handles=new p,i.viewSR=null,i.elevationAlignment=null,i.scaleVisibility=null,i.filterVisibility=null,i.spatialIndex=null,i.deconfliction=null,i.labeling=null,i.highlights=null,i.viewElevationProvider=null,i.sharedSymbolResourcesOwnerHandle=null,i.whenGraphics3DGraphicRequests={},i.pendingUpdates=new Map,i.pendingAdds=0,i.pendingRemoves=0,i.pendingUpdatesPool=new _({allocator:function(e){return e||{add:null,remove:null}},deallocator:function(e){return e.add=null,e.remove=null,e}}),i.symbolWarningLogged=!1,i.geometryWarningLogged=!1,i.objectIdInvisibleSet=new Set,i._whenSymbolRemoved=new _,i.asyncUpdates=!1,i.elevationFeatureExpressionEnabled=!0,i.owner=null,i.layer=null,i.hasDraped=!1,i.graphicSymbolSupported=!0,i._usedMemory=0,i.numberOfGraphics=0,i._visible=void 0,i._startCreateGraphics=!1,i.maxPendingUpdates=0,i}var u;return i(t,e),u=t,Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsWaitingForSymbol.size>0||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.maxSymbolComplexity,a=Math.max(t,Math.min(i,Math.ceil(r/Math.max(1,n?n.primitivesPerFeature:1)))),o=this._get("displayFeatureLimit");return o&&o.minimumTotalNumberOfFeatures===t&&o.maximumTotalNumberOfFeatures===i&&o.maximumTotalNumberOfPrimitives===r&&o.maximumSymbolComplexity===n&&o.maximumNumberOfFeatures===a?o:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,maximumSymbolComplexity:n,maximumNumberOfFeatures:a}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSymbolComplexity",{get:function(){for(var e=null,t=0,i=this.getSymbolComplexities();t<i.length;t++){var r=i[t];e?0===e.primitivesPerCoordinate&&r.primitivesPerFeature>e.primitivesPerFeature?e=r:0!==e.primitivesPerCoordinate&&r.primitivesPerCoordinate>e.primitivesPerCoordinate&&(e=r):e=r}var n=this._get("maxSymbolComplexity");return!e||n&&n.primitivesPerFeature===e.primitivesPerFeature&&n.primitivesPerCoordinate===e.primitivesPerCoordinate?n:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemory",{get:function(){return this._usedMemory},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemoryPerGraphic",{get:function(){return this._usedMemory&&this.numberOfGraphics?this._usedMemory/this.numberOfGraphics:this.maxSymbolComplexity?this.maxSymbolComplexity.memory.bytesPerFeature:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!0,configurable:!0}),t.prototype.getSymbolComplexities=function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()},t.prototype.getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;var i=M.to3D(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&W.error(i.error.message),this.symbolConversionCache.set(e.id,r),r},t.prototype.getSymbolComplexitiesUsedOrRenderer=function(e){var t=e.getSymbols();if(!t||!t.length)return[];for(var i=[],r=0,n=t;r<n.length;r++){var a=n[r],o=this.symbols.get(a.id);if(o)i.push(o.complexity);else{var s=this.getConvertedSymbol(a);s&&i.push(U.defaultSymbolComplexity(s))}}return i},t.prototype.getSymbolComplexitiesUsed=function(){var e=[];return this.symbols.forEach(function(t){t&&e.push(t.complexity)}),e},t.prototype.initialize=function(){this.viewSR=this.owner.view.spatialReference},t.prototype.setup=function(e){var t=this;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("spatialIndex",e.spatialIndex),this._set("deconfliction",e.deconfliction),this._set("labeling",e.labeling),this._set("highlights",e.highlights);var i=this.owner.view;this.viewElevationProvider=new G.ViewElevationProvider(this.viewSR,i),this.initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),this.symbolCreationContext.renderer=this.currentRenderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=i.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=i.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=new Q,this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.isAsync=this.asyncUpdates;var r=R.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=R.createContext(r,this.viewSR,W),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.handles.add(this.owner.watch("suspended",function(){return t.updateLayerVisibility()}));var n="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this.handles.add([this.owner.watch(n,function(){var e=i.screenSizePerspectiveEnabled&&t.layer.screenSizePerspectiveEnabled;e!==t.symbolCreationContext.screenSizePerspectiveEnabled&&(t.symbolCreationContext.screenSizePerspectiveEnabled=e,t.recreateAllGraphics())}),this.owner.watch("slicePlaneEnabled",function(e){return t.slicePlaneEnabledChange(!!e)}),this.owner.view.watch("pixelRatio",function(e){return t.pixelRatioChange(e)}),w.when(i.basemapTerrain,"tilingScheme",function(e){e.spatialReference.equals(t.symbolCreationContext.overlaySR)||(t.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),t.handles.has("loaded-graphics")?t.recreateAllGraphics():t.handles.add(w.on(t.owner,"loadedGraphics","change",function(e){return t.graphicsCollectionChanged(e)},function(){return t.recreateAllGraphics()}),"loaded-graphics")}),i.resourceController.scheduler.registerTask(3,function(e){return t.update(e)},function(){return t.needsUpdate()})]),this.owner.layer&&"featureReduction"in this.owner.layer&&this.handles.add(this.owner.watch("layer.featureReduction",function(){return t.deconfliction.featureReductionChange()})),this.rendererChange(this.layer.renderer),this.notifyChange("maxSymbolComplexity")},t.prototype.destroy=function(){for(var e in this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this.clear(),this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(z.ModelContentType.LAYER,this.stageLayer.id),this.stageLayer=null,this.stage=null),this.handles.destroy(),this.handles=null,this.viewSR=null,this._set("owner",null),this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new c("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear()},t.prototype.clear=function(){this.graphics.forEach(function(e){return e.destroy()}),this.spatialIndex&&this.spatialIndex.clear(),this.graphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach(function(e){e&&e.destroy()}),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol={},this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this.pendingAdds=0,this.pendingRemoves=0,this._set("hasDraped",!1),this.notifyChange("updating"),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.initializeStage=function(e,t){this.stage=e._stage,this.stageLayer=new k(t,{isPickable:!this.owner.suspended},t),this.stage.add(z.ModelContentType.LAYER,this.stageLayer),this.stage.addToViewContent([this.stageLayer.id])},t.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var t=new Set;this.symbols.forEach(function(i){i&&i.setDrawOrder(e,t)}),t.size>0&&this.stage.getDrapedRenderer().updateRenderOrder(t)},t.prototype.updateLayerVisibility=function(){var e=!!this.owner.suspended,t=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*ee,i=!e&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())},t.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},Object.defineProperty(t.prototype,"graphics3DGraphics",{get:function(){return this.graphics},enumerable:!0,configurable:!0}),t.prototype.getGraphics3DGraphicById=function(e){return this.graphics.get(e)},t.prototype._getGraphicObjectID=function(e,t){return void 0===t&&(t=this.owner.layer&&this.owner.layer.objectIdField),null!=e.objectId?e.objectId:t&&e.attributes[t]},Object.defineProperty(t.prototype,"graphics3DGraphicsByObjectID",{get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics.forEach(function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);m.isSome(a)&&i.set(a,r)}}),i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelsEnabled",{get:function(){return!(!this.labeling||!this.labeling.layerLabelsEnabled())},enumerable:!0,configurable:!0}),t.prototype.updateLabelingInfo=function(e){var t=this.deconfliction&&this.deconfliction.labelingInfoChange(e),i=this.labeling&&this.labeling.labelingInfoChange(e);return x.all([t,i]).then()},t.prototype.updateVisibilityInfo=function(){this.deconfliction&&this.deconfliction.labelingInfoChange(),this.labeling&&this.labeling.visibilityInfoChange()},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return f.everyMap(this.symbols,function(r,n){if(r){var a=r.getFastUpdateStatus();if(a.loading>0)return!1;e.graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}})?i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed":"unknown"},enumerable:!0,configurable:!0}),t.prototype.needsUpdate=function(){return this.pendingUpdates.size>0||!!this.lastFastUpdate&&v()-this.lastFastUpdate>500},t.prototype.update=function(e){var t=this.needsUpdate();this._applyPendingUpdates(e),!e.done&&this.lastFastUpdate&&(this.lastFastUpdate=null),t!==this.needsUpdate()&&this.notifyChange("updating")},t.prototype.setObjectIdVisibility=function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);m.isSome(i)&&this._updateUserVisibility(i)},t.prototype._findGraphics3DGraphicByObjectId=function(e){var t,i=this;return f.everyMap(this.graphics,function(r){return i._getGraphicObjectID(r.graphic)!==e||(t=r,!1)}),t},t.prototype._updateUserVisibility=function(e){if(m.isNone(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(m.isNone(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)},t.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics.get(e.uid);if(t)return x.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=x.createDeferred();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t.prototype.boundsForGraphics3DGraphic=function(e,t){return a(this,void 0,void 0,function(){var i,r,a,o,s,l,u,d,h,c;return n(this,function(n){switch(n.label){case 0:return i=this.owner.view.spatialReference,r=this.owner.view.renderSpatialReference,a=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,n){return B.bufferToBuffer(e,r,t,e,i,t,n)},s=function(e,t,r){return B.bufferToBuffer(e,a,t,e,i,t,r)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:t&&t.useViewElevation,minDemResolution:t&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,e.getProjectedBoundingBox(o,s,l)];case 1:return(u=n.sent())?(d=u.boundingBox,u.requiresDrapedElevation&&(h=this.symbolCreationContext.elevationProvider)&&(I.center(d,Y),H.x=Y[0],H.y=Y[1],H.z=void 0,H.spatialReference=i,c=h.getElevation(H)||0,d[2]=Math.min(d[2],c),d[5]=Math.max(d[5],c)),[2,{boundingBox:d,screenSpaceObjects:u.screenSpaceObjects}]):[2,null]}})})},t.prototype.whenGraphicBounds=function(e,t){var i=this;return w.whenOnce(this.owner,"loadedGraphics").then(function(){var t=i.owner.layer&&i.owner.layer.objectIdField,r=i.owner.loadedGraphics.find(function(i){return i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]});if(r)return i.whenGraphics3DGraphic(r);throw new c("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e,t)})},t.prototype.whenSymbolLayerSize=function(e,t){return a(this,void 0,void 0,function(){var i,r,a;return n(this,function(n){if(null==(i=this.symbols.get(e.id)))throw new c("internal:symbol-not-part-of-view","Symbol is not part of this view");if(-1===(r=e.symbolLayers.indexOf(t)))throw new c("internal:missing-symbol-layer","Symbol layer is not in symbol");return a=x.createResolver(),i.getSymbolLayerSize(r,function(e){null==e?a.reject(new c("internal:missing-size","Symbol layer has no valid size")):a(e)}),[2,a.promise]})})},t.prototype.graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic.uid,i=this.graphics.get(t),r=this.graphicsWithoutSymbol[t];if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i,e);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e);break;case"attributes":break;default:h.neverReached(e)}},t.prototype.graphicUpdateGeometryHandler=function(e,t){var i=t.graphic.geometry;if(i)if(m.isNone(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this.symbols.get(r);if(n&&!n.isFulfilled())return}this.recreateGraphic(t.graphic)}else e.graphics3DSymbol.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i);else this.recreateGraphic(t.graphic)},t.prototype.graphicUpdateSymbolHandler=function(e,t){var i=t.graphic,r=m.isSome(e)?e.graphics3DSymbol:t.oldValue&&this.symbols.get(t.oldValue.id);if(r){var n=r.symbol,a=this.getConvertedSymbol(t.newValue);if(a.type===n.type&&"web-style"!==a.type&&"web-style"!==n.type){var o=this.graphicsBySymbol.get(n.id);if(o&&1!==o.size)this.recreateGraphic(i);else{var s=V.diff(n,a);if(m.isNone(s))this.updateSymbolMapping(n.id,a);else{var l={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),V.isEmpty(l.diff)){for(var u=0,d=l.symbolStatePatches;u<d.length;u++){(0,d[u])()}var h=this._getRenderingInfo(i);if(m.isSome(e))for(var c=0,p=l.graphics3DGraphicPatches;c<p.length;c++){(0,p[c])(e,h)}this.updateSymbolMapping(n.id,a)}else this.recreateGraphic(i)}}}else this.recreateGraphic(i)}else this.recreateGraphic(i)},t.prototype.graphicUpdateVisibleHandler=function(e,t){var i=this._updateUserVisibility(e);i&&this.labeling&&(this.lastFastUpdate=v(),this.owner.view.labeler.setDirty()),i&&this.owner.view.deconflictor.setDirty()},t.prototype.recreateGraphic=function(e){var t=[e];this.remove(t),this.add(t)},t.prototype._beginGraphicUpdate=function(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),this._get("symbolsUpdating")||this._set("symbolsUpdating",!0)},t.prototype._endGraphicUpdate=function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))},t.prototype.expandComputedExtent=function(e){var t=X,i=e.spatialReference;F.computeAABB(e,t);var r=this.viewSR,n=u.tmpVec;if(i.equals(r)||B.xyzToVector(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],B.xyzToVector(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),g.isFinite(t[0])&&g.isFinite(t[3])&&g.isFinite(t[1])&&g.isFinite(t[4])){var a=this.computedExtent,o=null,s=g.isFinite(t[2])&&g.isFinite(t[5]),l=s&&(!a||null==a.zmin||t[2]<a.zmin),d=s&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||d)&&((o=this.propertiesPool.get("computedExtent")).xmin=Math.min(t[0],a.xmin),o.ymin=Math.min(t[1],a.ymin),o.xmax=Math.max(t[3],a.xmax),o.ymax=Math.max(t[4],a.ymax),o.spatialReference=r):((o=this.propertiesPool.get("computedExtent")).xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=r),o&&(l&&(o.zmin=t[2]),d&&(o.zmax=t[5]),this._set("computedExtent",o))}},t.prototype.updateHasDraped=function(){var e=this.graphicsDrapedUids.size>0;this._set("hasDraped",e)},t.prototype.elevationInfoChange=function(){var e=this,t=R.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=R.createContext(t,this.viewSR,W),this.labeling&&this.labeling.elevationInfoChange(),this.forEachGraphics3DSymbol(function(t,i,r){t.globalPropertyChanged("elevationInfo",i)?i.forEach(function(e){for(var t=e.graphic,i=e._labelGraphics,r=0;r<i.length;r++){var n=i[r];n.graphics3DSymbolLayer.updateGraphicElevationContext(t,n)}}):e._recreateSymbol(r)}),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange()},t.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.filterVisibility&&this.filterVisibility.clear(),this.labeling&&this.labeling.reset(),this.deconfliction&&this.deconfliction.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator()},t.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))},t.prototype._recreateSymbol=function(e){var t=this,i=[];this.graphicsBySymbol.get(e).forEach(function(e,r){var n=e.usedMemory;t._conditionalRemove(e,r),t.spatialIndex&&t.spatialIndex.remove(e),i.push(e.graphic),e.destroy(),t.removeGraphics3DGraphic(r,n),t.updateLayerVisibility()}),this.graphicsBySymbol.set(e,new Map);var r=this.symbols.get(e);r&&r.destroy(),this.symbols.delete(e),this.updateHasDraped(),this.add(i)},t.prototype._conditionalRemove=function(e,t){e.isDraped()&&this.graphicsDrapedUids.delete(t),this.highlights&&this.highlights.removeGraphic(e),this.labeling&&this.labeling.removeGraphic(e),this.deconfliction&&this.deconfliction.removeGraphic(e)},t.prototype.add=function(e){if(e&&0!==e.length){if(!this.owner.view.basemapTerrain||!this.owner.view.basemapTerrain.tilingScheme)return void W.error("#add()","Cannot add graphics before terrain surface has been initialized");this.asyncUpdates?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")}},t.prototype._addImmediate=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,J.clear();for(var i=0,r=e;i<r.length;i++){var n=r[i];this._startAddGraphic(n,J)}J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty(),this._cleanupSymbols()},t.prototype._addDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=r.uid,a=this.pendingUpdates.get(n);if(a)a.add||this.pendingAdds++,a.add=r;else{var o=this.pendingUpdatesPool.pushNew();o.add=r,this.pendingAdds++,this.pendingUpdates.set(n,o)}}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.remove=function(e){this.asyncUpdates?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t.prototype._removeImmediate=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._removeGraphic(r)}this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype._removeDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=r.uid,a=this.pendingUpdates.get(n);if(a)a.add&&(a.remove?a.add=null:this.pendingUpdates.delete(n),this.pendingAdds--);else{var o=this.pendingUpdatesPool.pushNew();o.remove=r,this.pendingUpdates.set(n,o),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&W.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0},t.prototype._applyPendingUpdates=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var i=e.idleFrame?1e3:100,r=0;J.clear(),f.everyMap(this.pendingUpdates,function(n,a){if(n.remove&&(t.pendingRemoves--,t._removeGraphic(n.remove)),n.add&&(t.pendingAdds--,t._startAddGraphic(n.add,J)&&r++),t.pendingUpdates.delete(a),r>i&&(J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),r=0),e.madeProgress(),e.done)return!1}),J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.updateHasDraped()},t.prototype._startAddGraphic=function(e,t){this.graphicsWithoutSymbol[e.uid]=e;var i=this._getRenderingInfo(e,W);if(!i)return!1;var r=i.symbol,n=this.getOrCreateGraphics3DSymbol(r,i.renderer);if(!n)return!1;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);var a={graphic:e,renderingInfo:i,layer:this.layer},o=n.symbol.id,s=t.get(o);if(s)s.graphics.push(a);else{var l=K.acquire();l.clear(),l.push(a),t.set(o,{asyncSymbol:n,graphics:l})}return!0},t.prototype._finishAddGraphics=function(e){var t=this,i=!1,r=function(t){t===e.asyncSymbol.symbol.id&&(i=!0)};this._whenSymbolRemoved.push(r),e.asyncSymbol.then(function(){t._whenSymbolRemoved.removeUnordered(r),$.clear();for(var n=0;n<e.graphics.length;n++){var a=e.graphics.data[n],o=a.graphic;if(!(i||e.asyncSymbol.destroyed||t.graphicSymbolSupported&&o.symbol&&o.symbol.id!==e.asyncSymbol.symbol.id)){if(t.graphicsWaitingForSymbol.has(o.uid)){var s=t.createGraphics3DGraphic(e.asyncSymbol,a);t.spatialIndex&&s&&$.push(s)}t._endGraphicUpdate(o)}--e.asyncSymbol.referenced}$.length>0&&(t.spatialIndex.addMany($.data,$.length),$.clear()),e.graphics.clear(),K.release(e.graphics),t.labeling&&(t.lastFastUpdate=v(),t.owner.view.labeler.setDirty())},function(){if(t._whenSymbolRemoved.removeUnordered(r),!i&&!e.asyncSymbol.destroyed)for(var n=0;n<e.graphics.length;n++)t._endGraphicUpdate(e.graphics.data[n].graphic);e.graphics.clear(),K.release(e.graphics)})},t.prototype._removeGraphic=function(e){var t=e.uid,i=this.graphics.get(t);if(i){var r=i.usedMemory;this._conditionalRemove(i,t),this.spatialIndex&&this.spatialIndex.remove(i);var n=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(n).delete(t),delete this.graphicsWithoutSymbol[t],this.removeGraphics3DGraphic(t,r),i.destroy()}else delete this.graphicsWithoutSymbol[t],this.graphicsWaitingForSymbol.delete(t)},t.prototype.hasLabelingContext=function(e){if(e instanceof l.LabelSymbol3D||e instanceof l.TextSymbol){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(function(t){return t.symbol===e})}return!1},t.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof l.LabelSymbol3D&&!this.hasLabelingContext(e)&&(W.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))},t.prototype._getRenderingInfo=function(e,t){if(!e.geometry)return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&e.symbol)return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var i=this.rendererHasGeometryOperations?F.hydrateGraphic(e,this.layer):e,r=this.owner.getRenderingInfo(i,this.currentRenderer);return r&&r.symbol?r:(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null)},t.prototype.createGraphics3DSymbol=function(e,t){var i=this;if(!this.hasValidSymbolCreationContext(e))return null;var r,n=this.getConvertedSymbol(e);if(!n)return null;if(t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=M.to3D(t.backgroundFillSymbol,!1,!0);a.symbol&&"web-style"!==a.symbol.type&&(r=a.symbol.symbolLayers)}var o=T.make(n,this.symbolCreationContext,r);return o.then(function(){return i.notifyChange("maxSymbolComplexity")}),o},t.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof l.WebStyleSymbol?new L(e,function(e){return i.createGraphics3DSymbol(e,t)}):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),r&&++r.referenced,r},t.prototype.addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics.set(e.graphic.uid,e),this.numberOfGraphics++,this.updateLayerVisibility()},t.prototype.removeGraphics3DGraphic=function(e,t){this._usedMemory-=t,this.graphics.delete(e),this.numberOfGraphics--,this.updateLayerVisibility()},t.prototype.createGraphics3DGraphic=function(e,t){var i=t.graphic;if(delete this.graphicsWithoutSymbol[i.uid],this.symbols.has(e.symbol.id)){if(!this.graphics.has(i.uid)){var r=e.createGraphics3DGraphic(t),n=e.symbol.id;this.addGraphics3DGraphic(r),this.graphicsBySymbol.has(n)||this.graphicsBySymbol.set(n,new Map),this.graphicsBySymbol.get(n).set(i.uid,r),r.initialize(this.stageLayer,this.stage),r.isDraped()&&(this.graphicsDrapedUids.add(i.uid),this._set("hasDraped",!0)),r.centroid=null,"point"!==i.geometry.type&&r instanceof N&&(r.centroid=j.computeCentroid(i.geometry,this.viewSR)),this._updateUserVisibility(r),this.deconfliction&&this.deconfliction.addGraphic(r),this.labeling&&this.labeling.addGraphic(r),this.scaleVisibility&&this.scaleVisibility.updateVisibility(r),this.filterVisibility&&this.filterVisibility.updateVisibility(r),this.highlights&&this.highlights.addGraphic(r),this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r);var a=this.whenGraphics3DGraphicRequests[i.uid];return a&&(delete this.whenGraphics3DGraphicRequests[i.uid],a.resolve(r)),r}}else this.add([i])},t.prototype.rendererChange=function(e){var t=this;e!==this.currentRenderer&&(this.validateRenderer(e),P.hasGeometryOperations(e)?P.enableGeometryOperations().then(function(){t.layer.renderer===e&&t.currentRendererChange(e,!0)}):this.currentRendererChange(e,!1))},t.prototype.currentRendererChange=function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t;var i=this.symbolCreationContext.renderer;if(e!==i){this.symbolConversionCache.clear();var r=V.diff(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,m.isNone(r)||("complete"===r.type?this.recreateAllGraphics():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}},t.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},t.prototype.applySymbolSetDiff=function(e,t,i,r){var n=this;e=e||[];for(var a=[],o=this,s=0,l=t=t||[];s<l.length;s++){!function(t){var r=o.graphicsBySymbol.get(t.id);r&&r.forEach(function(o,s){var l=o.graphic,u=n.layer instanceof D?n.layer:null;if(t!==i.defaultSymbol||i.getSymbol(F.hydrateGraphic(l,u))!==i.defaultSymbol){var d=o.usedMemory;e.length||i.defaultSymbol?a.push(l):n.graphicsWithoutSymbol[s]=l;var h=n.graphics.get(s);n._conditionalRemove(h,s),o.destroy(),r.delete(s),n.removeGraphics3DGraphic(s,d),n.updateLayerVisibility()}}),o._whenSymbolRemoved.forEach(function(e){return e(t.id)})}(l[s])}if(e.length||a.length){for(var u in this.graphicsWithoutSymbol)a.push(this.graphicsWithoutSymbol[u]);this.graphicsWithoutSymbol={},this.add(a)}this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype.applyUniqueValueRendererDiff=function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map(function(e){return e.symbol}):[],o=n?n.removed.map(function(e){return e.symbol}):[];if(n)for(var s=0;s<n.changed.length;s++)a.push(n.changed[s].newValue.symbol),o.push(n.changed[s].oldValue.symbol);return r?(i.defaultSymbol&&o.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&o.push(t.defaultSymbol),this.applySymbolSetDiff(a,o,t,i),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t.prototype.calculateUnchangedSymbolMapping=function(e,t,i){if(t instanceof s.UniqueValueRenderer&&i instanceof s.UniqueValueRenderer&&(m.isNone(e)||"partial"===e.type)){var r=e&&e.diff,n=r&&r.defaultSymbol,a=r&&r.uniqueValueInfos,o=void 0;return o=a?a.unchanged.map(function(e){return{oldId:e.oldValue.symbol.id,newId:e.newValue.symbol.id}}):i.uniqueValueInfos.map(function(e,i){return{oldId:e.symbol.id,newId:t.uniqueValueInfos[i].symbol.id}}),!n&&i.defaultSymbol&&o.push({oldId:i.defaultSymbol.id,newId:t.defaultSymbol.id}),o}return[]},t.prototype.updateSymbolMapping=function(e,t){var i="string"==typeof t?t:t.id,r="string"==typeof t?null:t;if(e&&e!==i){var n=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==n&&this.graphicsBySymbol.set(i,n);var a=this.symbols.get(e);this.symbols.delete(e),void 0!==a&&(this.symbols.set(i,a),r?a.symbol=r:a.symbol.id=i)}},t.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var r=0,n=this.calculateUnchangedSymbolMapping(e,t,i);r<n.length;r++){var a=n[r],o=a.oldId,s=a.newId;this.updateSymbolMapping(o,s)}},t.prototype.applyRendererDiff=function(e,t,i){var r=this;return!this.diffHasSymbolChange(e)&&(!!(t instanceof s.UniqueValueRenderer&&i instanceof s.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)||f.everyMap(this.graphicsBySymbol,function(i,n){var a=r.symbols.get(n);if(a&&!a.applyRendererDiff(e,t))return!1}))},t.prototype.opacityChange=function(){this.forEachGraphics3DSymbol(function(e){return e.globalPropertyChanged("opacity")}),this.updateStageLayerVisibility()},t.prototype.slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)}),this.deconfliction&&this.deconfliction.slicePlaneEnabledChange(),this.labeling&&this.labeling.slicePlaneEnabledChange())},t.prototype.pixelRatioChange=function(e){var t=this;this.forEachGraphics3DSymbol(function(e,i,r){e.globalPropertyChanged("pixelRatio",i)||t._recreateSymbol(r)})},t.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,r=E.create();return B.extentToBoundingRect(e,r,t)?this.symbolCreationContext.clippingExtent=[r[0],r[1],-1/0,r[2],r[3],1/0]:this.symbolCreationContext.clippingExtent=null,!d.equals(this.symbolCreationContext.clippingExtent,i)},t.prototype.notifyVisibilityChanged=function(){this.owner.view.deconflictor.setDirty(),this.owner.view.labeler.setDirty()},t.prototype.forEachGraphics3DGraphic=function(e){var t=this;if(this.owner.loadedGraphics){var i=!1;this.owner.loadedGraphics.forEach(function(r){var n=t.getGraphics3DGraphicById(r.uid);n&&e(n,r)&&(i=!0)}),i&&this.notifyVisibilityChanged()}},t.prototype.forEachGraphics3DSymbol=function(e){var t=this;this.graphicsBySymbol.forEach(function(i,r){var n=t.symbols.get(r);n&&e(n,i,r)})},t.prototype.updateAllGraphicsVisibility=function(){var e=this;this.filterVisibility&&(this.filterVisibility.dirty=!0),this.forEachGraphics3DGraphic(function(t){var i=e._updateUserVisibility(t),r=e.scaleVisibility&&e.scaleVisibility.updateVisibility(t);return i||r})},t.prototype.hideAllGraphics=function(){this.forEachGraphics3DGraphic(function(e){return e.setVisibilityFlag(0,!1,0)})},t.prototype.validateRenderer=function(e){var t=O.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";W.warn(i,t.message)}},t.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=v(),this.labeling.reset()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t.prototype._cleanupSymbols=function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0)){var t=!1;this.symbols.forEach(function(i,r){if(i&&!(i.referenced>0)){var n=e.graphicsBySymbol.get(r);n&&0!==n.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),i&&i.destroy(),t=!0)}}),t&&this.notifyChange("maxSymbolComplexity")}},t.prototype.snapshotInternals=function(){var e=this;return{graphics:d.keysOfMap(this.graphics).sort(),symbols:d.keysOfMap(this.symbols).sort(),graphicsBySymbol:d.keysOfMap(this.graphicsBySymbol).sort().map(function(t){return{symbolId:t,graphics:d.keysOfMap(e.graphicsBySymbol.get(t)).sort()}}),graphicsWithoutSymbol:Object.keys(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:d.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}},Object.defineProperty(t.prototype,"test",{get:function(){return{symbols:this.symbols,filterVisibility:this.filterVisibility}},enumerable:!0,configurable:!0}),t.prototype.getStats=function(){return{coreVisible:this.graphics.size,coreMissing:Object.keys(this.graphicsWithoutSymbol).length,corePending:this.pendingUpdates.size}},t.tmpVec=C.vec3f64.create(),r([S.property({readOnly:!0})],t.prototype,"computedExtent",void 0),r([S.property()],t.prototype,"currentRenderer",void 0),r([S.property()],t.prototype,"rendererHasGeometryOperations",void 0),r([S.property({readOnly:!0})],t.prototype,"elevationAlignment",void 0),r([S.property({readOnly:!0})],t.prototype,"scaleVisibility",void 0),r([S.property({readOnly:!0})],t.prototype,"filterVisibility",void 0),r([S.property({readOnly:!0})],t.prototype,"spatialIndex",void 0),r([S.property({readOnly:!0})],t.prototype,"deconfliction",void 0),r([S.property({readOnly:!0})],t.prototype,"labeling",void 0),r([S.property({readOnly:!0})],t.prototype,"highlights",void 0),r([S.property()],t.prototype,"asyncUpdates",void 0),r([S.property({constructOnly:!0})],t.prototype,"elevationFeatureExpressionEnabled",void 0),r([S.property({constructOnly:!0})],t.prototype,"owner",void 0),r([S.property({constructOnly:!0})],t.prototype,"layer",void 0),r([S.property({readOnly:!0})],t.prototype,"hasDraped",void 0),r([S.property({readOnly:!0})],t.prototype,"symbolsUpdating",void 0),r([S.property({constructOnly:!0})],t.prototype,"graphicSymbolSupported",void 0),r([S.property({readOnly:!0,dependsOn:["elevationAlignment.updating","scaleVisibility.updating","filterVisibility.updating"]})],t.prototype,"updating",null),r([S.property({readOnly:!0})],t.prototype,"updatingRemaining",null),r([S.property({readOnly:!0})],t.prototype,"updatingTotal",null),r([S.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],t.prototype,"displayFeatureLimit",null),r([S.property({readOnly:!0})],t.prototype,"maxSymbolComplexity",null),u=r([S.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],t)}(S.declared(u)),J=new Map,$=new _,K=new b(_),ee=10;return Z}.apply(null,r))||(e.exports=n)},1577:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(13),i(560)],void 0===(n=function(e,t,i,r){function n(e,t){if(!t)return null;var r;if((r=Array.isArray(t)?t:[t]).length>0){var n=r.map(function(e){return e.details.symbol.type||e.details.symbol.declaredClass}).filter(function(e){return!!e});n.sort();var a=[];return n.forEach(function(e,t){0!==t&&e===n[t-1]||a.push(e)}),new i("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols ("+a.join(", ")+") which are not supported in 3D",{renderer:e,symbolErrors:r})}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.validateTo3D=function(e){return e?function(e){return"simple"===e.type}(e)?function(e){return n(e,r.to3D(e.symbol).error)}(e):function(e){return"unique-value"===e.type}(e)?function(e){var t=e.uniqueValueInfos.map(function(e){return r.to3D(e.symbol).error}).filter(function(e){return!!e}),i=r.to3D(e.defaultSymbol);return i.error&&t.unshift(i.error),n(e,t)}(e):function(e){return"class-breaks"===e.type}(e)?function(e){var t=e.classBreakInfos.map(function(e){return r.to3D(e.symbol).error}).filter(function(e){return!!e}),i=r.to3D(e.defaultSymbol);return i.error&&t.unshift(i.error),n(e,t)}(e):new i("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '"+(e.type||e.declaredClass)+"'",{renderer:e}):null}}.apply(null,r))||(e.exports=n)},1578:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.sharedResources=null,this.streamDataSupplier=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.layerOrder=null,this.layerOrderDelta=null,this.clippingExtent=null,this.renderSpatialReference=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.layerView=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.isAsync=!1}}();t.Graphics3DSymbolCreationContext=i}.apply(null,r))||(e.exports=n)},1579:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1580),i(561)],void 0===(n=function(e,t,i,r){Object.defineProperty(t,"__esModule",{value:!0}),t.make=function(e,t,n){var a;switch(e.type){case"point-3d":a=i;break;default:a=r}return new a(e,t,n)}}.apply(null,r))||(e.exports=n)},1580:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(5),i(569),i(561)],void 0===(n=function(e,t,i,r,n){return function(e){function t(t,i,n){var a=e.call(this,t,i,n)||this;return a.calloutSymbolLayer=null,a.symbol.hasVisibleCallout()&&(a.calloutSymbolLayer=r.make(a.symbol,i)),a}return i(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this)},t.prototype.createGraphics3DGraphic=function(t,i,r){var n=e.prototype.createGraphics3DGraphic.call(this,t,r);if(this.calloutSymbolLayer){var a=this.createCalloutGraphic(t);a&&n.addAuxiliaryGraphic(a)}return n},t.prototype.globalPropertyChanged=function(t,i){var r=this;if(!e.prototype.globalPropertyChanged.call(this,t,i))return!1;if(this.calloutSymbolLayer){return this.calloutSymbolLayer.globalPropertyChanged(t,i,function(e){for(var t=0,i=e._auxiliaryGraphics;t<i.length;t++){var n=i[t];if(n.graphics3DSymbolLayer===r.calloutSymbolLayer)return n}})}return!0},t.prototype.createCalloutGraphic=function(e){var t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)},t}(n)}.apply(null,r))||(e.exports=n)},1581:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(17),i(88),i(0),i(37)],void 0===(n=function(e,t,i,r,n,a,o,s,l){var u=function(){function e(){this.extents=new o({allocator:function(e){return e||l.create()}}),this.tempExtent=l.create(),this.dirty=!1}return Object.defineProperty(e.prototype,"length",{get:function(){return this.extents.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this.extents.clear()},e.prototype.add=function(e){this.contains(e)||(this.removeContained(e),l.set(this.extents.pushNew(),e),this.dirty=!0)},e.prototype.pop=function(){return this.dirty&&(this.mergeTight(),this.dirty=!1),this.extents.pop()},e.prototype.mergeTight=function(){for(var e=this.extents,t=this.tempExtent,i=!1;!i;){i=!0;for(var r=0;r<e.length;++r)if(function(i){for(var r=e.data[i],n=l.area(r),a=!1,o=e.length-1;o>i;--o){var s=e.data[o],u=l.area(s);l.expand(r,s,t);var d=n+u;(l.area(t)-d)/d<.05&&(l.set(r,t),n=l.area(r),e.swapElements(o,e.length-1),e.pop(),a=!0)}return a}(r)){i=!1;break}}},e.prototype.contains=function(e){return this.extents.some(function(t){return l.contains(t,e)})},e.prototype.removeContained=function(e){for(var t=this.extents.length-1;t>=0;--t)l.contains(e,this.extents.data[t])&&this.extents.removeUnorderedIndex(t)},e}();return function(e){function t(){var t=e.call(this)||this;return t.dirtyExtents=new u,t.globalDirty=!1,t.dirtyGraphicsQueue=new o({deallocator:null}),t.handles=new a,t.updateElevation=!1,t.layerView=null,t.graphicsCore=null,t}return i(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t,i,r){var n=this;this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;var a=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",function(e){return n.elevationUpdateHandler(e)}),this.layerView.watch("suspended",function(){return n.suspendedChange()}),a.registerTask(12,function(e){return n.update(e)},function(){return n.needsUpdate()})])},t.prototype.destroy=function(){this.dirtyGraphicsQueue=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},t.prototype.clear=function(){this.dirtyGraphicsQueue.clear(),this.notifyChange("updating")},t.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},t.prototype.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},t.prototype.needsUpdate=function(){return this.dirtyGraphicsQueue.length>0||this.dirtyExtents.length>0||this.globalDirty},t.prototype.update=function(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress());this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},t.prototype._updateDirtyGraphics=function(e){for(var t=this.layerView.view,i=this.graphicsCore.stageLayer.id,r=this.layerView.labeling;this.dirtyGraphicsQueue.length>0&&!e.done;){for(var n=Math.min(this.dirtyGraphicsQueue.length,100);n--&&!e.done;){var a=this.dirtyGraphicsQueue.pop(),o=this.graphicsCore.getGraphics3DGraphicById(a);o&&o.alignWithElevation(this.elevationProvider,t.renderCoordsHelper),e.madeProgress()}t._stage.processDirtyLayer(i),r&&r.processStageDirty()}},t.prototype._updateDirtyExtents=function(e){for(var t=this;this.dirtyExtents.length>0&&this.dirtyGraphicsQueue.length<100&&!e.done;){var i=this.dirtyExtents.pop();this.queryGraphicUIDsInExtent(i,this.spatialReference,function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);i&&i.needsElevationUpdates()&&t.dirtyGraphicsQueue.push(e)}),e.madeProgress()}},t.prototype.markAllGraphicsElevationDirty=function(){var e=this;this.dirtyExtents.clear(),this.dirtyGraphicsQueue.clear(),this.graphicsCore.graphics3DGraphics.forEach(function(t,i){return e.dirtyGraphicsQueue.push(i)})},t.prototype.elevationUpdateHandler=function(e){var t=e.extent;if(this.layerView.suspended){if(!this.updateElevation){var i=this.graphicsCore.computedExtent;i&&t[2]>i.xmin&&t[0]<i.xmax&&t[3]>i.ymin&&t[1]<i.ymax&&(this.updateElevation=!0)}}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.spatialReference=e.spatialReference,this.notifyChange("updating")},r([s.property({readOnly:!0})],t.prototype,"updating",null),r([s.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],t)}(s.declared(n))}.apply(null,r))||(e.exports=n)},1582:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1583)],void 0===(n=function(e,t,i){return function(){function e(){this.graphicsCore=null,this.highlights=[]}return e.prototype.destroy=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()}),this.highlights=null},e.prototype.setup=function(e){this.graphicsCore=e},e.prototype.acquireSet=function(e,t){var r=this,n=new i(e,t);return this.highlights.push(n),{set:n,handle:{remove:function(){return r.releaseSet(n)},pause:function(){n.highlightSet.removeAll(),n.paused=!0},resume:function(){n.paused=!1,r.initializeSet(n)}}}},e.prototype.releaseSet=function(e){e.highlightSet.removeAll();var t=this.highlights?this.highlights.indexOf(e):-1;-1!==t&&this.highlights.splice(t,1)},e.prototype.setUids=function(e,t){for(var i=this.graphicsCore.graphics3DGraphics,r=0,n=t;r<n.length;r++){var a=n[r];e.ids.add(a);var o=i.get(a);o&&o.addHighlight(e.highlightSet,e.options)}},e.prototype.setObjectIds=function(e,t){t.forEach(function(t){return e.ids.add(t)}),this.initializeSet(e)},e.prototype.addGraphic=function(e){this.highlights.forEach(function(t){!t.paused&&t.hasGraphic(e)&&e.addHighlight(t.highlightSet,t.options)})},e.prototype.removeGraphic=function(e){this.highlights.forEach(function(t){t.hasGraphic(e)&&e.removeHighlight(t.highlightSet)})},e.prototype.allGraphicsDeleted=function(){this.highlights.forEach(function(e){return e.highlightSet.removeAll()})},e.prototype.initializeSet=function(e){var t=this.graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(function(t){t&&e.hasGraphic(t)&&t.addHighlight(e.highlightSet,e.options)}):e.ids.forEach(function(i){var r=t.get(i);r&&r.addHighlight(e.highlightSet,e.options)})},e}()}.apply(null,r))||(e.exports=n)},1583:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(1551)],void 0===(n=function(e,t,i){return function(){function e(e,t){this.highlightSet=new i,this.ids=new Set,this.paused=!1,this.options=e,this.objectIdField=t}return e.prototype.hasGraphic=function(e){if(this.objectIdField){var t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)},e}()}.apply(null,r))||(e.exports=n)},1584:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(17),i(0)],void 0===(n=function(e,t,i,r,n,a,o){function s(e,t){return null!==e&&e>0&&e<8e7||t>50}return function(e){function t(){var t=e.call(this)||this;return t._scaleRangeActive=!1,t._layerScaleRangeVisibilityDirty=!0,t.layerScaleRangeVisibilityQuery=!1,t.scaleChangeEventHandle=null,t.handles=new a,t.layerView=null,t.layer=null,t.queryGraphicUIDsInExtent=null,t.extent=null,t.graphicsCore=null,t.basemapTerrain=null,t.suspended=!1,t}return i(t,e),Object.defineProperty(t.prototype,"layerScaleRangeVisibilityDirty",{get:function(){return this._layerScaleRangeVisibilityDirty},set:function(e){this._layerScaleRangeVisibilityDirty!==e&&(this._layerScaleRangeVisibilityDirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t,i,r,n){var a=this;this.layerView=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=n,this.updateScaleRangeActive();var o=this.layerView.view.resourceController.scheduler;this.handles.add(o.registerTask(6,function(){return a.update()},function(){return a.needsUpdate()}))},t.prototype.destroy=function(){this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null),this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null},t.prototype.needsUpdate=function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},t.prototype.setExtent=function(e){this.extent=e,this.layerScaleRangeVisibilityDirty=!0},t.prototype.update=function(){this.updateSuspendScaleVisible(),this.layerScaleRangeVisibilityDirty=!1},t.prototype.scaleRangeActive=function(){return this._scaleRangeActive},t.prototype.updateScaleRangeActive=function(){var e=this,t=this.layer,i=s(t.minScale,t.maxScale);t.labelingInfo&&!i&&(i=t.labelingInfo.some(function(e){return e&&s(e.minScale,e.maxScale)}));var r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.scaleChangeEventHandle&&this.basemapTerrain?this.scaleChangeEventHandle=this.basemapTerrain.on("scale-change",function(t){return e.scaleUpdateHandler(t)}):!i&&this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null),r},t.prototype.updateSuspendScaleVisibleFinish=function(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e)},t.prototype.updateSuspendScaleVisible=function(){var e=this,t=this.layerView.view.basemapTerrain;this.extent&&t&&this._scaleRangeActive?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,t.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,function(t){return e.updateSuspendScaleVisibleFinish(t)})):this.updateSuspendScaleVisibleFinish(!0)},t.prototype.visibleAtScale=function(e,t,i){return null==e||e>i&&(!t||e<t)},t.prototype.visibleAtLayerScale=function(e){return this.visibleAtScale(e,this.layer.minScale,this.layer.maxScale)},t.prototype.visibleAtLabelScale=function(e,t){return this.visibleAtScale(e,t.minScale,t.maxScale)},t.prototype.graphicScale=function(e){var t;return e.centroid?t=e.centroid:"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(t):1:null},t.prototype.graphicVisible=function(e){var t=this.graphicScale(e);return this.visibleAtLayerScale(t)},t.prototype.updateVisibility=function(e){if(this._scaleRangeActive){var t=this.graphicVisible(e);return e.setVisibilityFlag(1,t,0)}return!1},t.prototype.updateGraphicLabelScaleVisibility=function(e){if(!this._scaleRangeActive)return!1;if(!e._labelGraphics||0===e._labelGraphics.length)return!1;var t=this.graphicScale(e),i=this.updateLabelScaleVisibility(e,t);return i&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),i},t.prototype.updateLabelScaleVisibility=function(e,t){if(!e._labelGraphics||0===e._labelGraphics.length)return!1;var i=e._labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this.visibleAtLabelScale(t,i);if(e.setVisibilityFlag(1,r,1))return!0}return!1},t.prototype.scaleUpdateHandler=function(e){var t=this;if(!this.layerView.suspended){var i=e.extent,r=e.scale,n=this.visibleAtLayerScale(r),a=!1;this.queryGraphicUIDsInExtent(i,e.spatialReference,function(e){var o=t.graphicsCore.getGraphics3DGraphicById(e);if(o){var s=o.centroid;if(s&&(i[0]>s.x||i[1]>s.y||i[2]<s.x||i[3]<s.y))return;var l=!1;o.setVisibilityFlag(1,n,0)&&(l=!0),t.updateLabelScaleVisibility(o,r)&&(l=!0),l&&(a=!0)}}),a&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}this.layerScaleRangeVisibilityDirty=!0},t.prototype.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&(this._scaleRangeActive?this.graphicsCore.updateAllGraphicsVisibility():this.graphicsCore.forEachGraphics3DGraphic(function(e){return e.clearVisibilityFlag(1)})),this.layerScaleRangeVisibilityDirty=!0},r([o.property({readOnly:!0})],t.prototype,"suspended",void 0),r([o.property({readOnly:!0})],t.prototype,"updating",null),r([o.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],t)}(o.declared(n))}.apply(null,r))||(e.exports=n)},1585:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(19),i(88),i(0),i(1558)],void 0===(n=function(e,t,i,r,n,a,o,s,l){var u=function(e){function t(t){var i=e.call(this)||this;return i.index=new l.default(9,a("csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),i.spatialReference=null,i}return i(t,e),t.prototype.destroy=function(){this.index.destroy(),this.index=null,d.prune()},t.prototype.queryGraphicUIDsInExtent=function(e,t,i){t.equals(this.spatialReference)&&(h.minX=e[0],h.minY=e[1],h.maxX=e[2],h.maxY=e[3],this.index.search(h,function(e){return i(e.graphic.uid)}))},t.prototype.add=function(e){!e.addedToSpatialIndex&&e.computeExtent(this.spatialReference)&&(this.index.insert(e),e.addedToSpatialIndex=!0)},t.prototype.addMany=function(e,t){void 0===t&&(t=e.length),d.clear();for(var i=0;i<t;i++){var r=e[i];!r.addedToSpatialIndex&&r.computeExtent(this.spatialReference)&&(d.push(r),r.addedToSpatialIndex=!0)}this.index.load(d.data,d.length)},t.prototype.remove=function(e){e.addedToSpatialIndex&&(e.addedToSpatialIndex=!1,this.index.remove(e))},t.prototype.clear=function(){this.index.clear()},r([s.property({constructOnly:!0})],t.prototype,"spatialReference",void 0),r([s.subclass("esri.views.3d.layers.graphics.Graphics3DSpatialIndex")],t)}(s.declared(n)),d=new o,h={minX:0,minY:0,maxX:0,maxY:0};return u}.apply(null,r))||(e.exports=n)},1588:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(13)],void 0===(n=function(e,t,i){function r(e,t,i){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,i+d.identifierOffset,d.identifierLength)),version:t.getUint16(i+d.versionOffset,u),checksum:t.getUint32(i+d.checksumOffset,u)}}function n(e,t){return{sizeLo:e.getUint32(t+h.sizeLo,u),sizeHi:e.getUint32(t+h.sizeHi,u),minX:e.getFloat64(t+h.minX,u),minY:e.getFloat64(t+h.minY,u),minZ:e.getFloat64(t+h.minZ,u),maxX:e.getFloat64(t+h.maxX,u),maxY:e.getFloat64(t+h.maxY,u),maxZ:e.getFloat64(t+h.maxZ,u),errorX:e.getFloat64(t+h.errorX,u),errorY:e.getFloat64(t+h.errorY,u),errorZ:e.getFloat64(t+h.errorZ,u),count:e.getUint32(t+h.count,u),reserved:e.getUint32(t+h.reserved,u)}}function a(e,t,i){var r=[];t=o(e,t,r);for(var n=[],a=0;a<r.length;a++){n.length=0,t=o(e,t,n);for(var s=0;s<n.length;s++)i.push(n[s]+r[a])}return t}function o(e,t,r){var n=new DataView(e,t),a=n.getUint8(0),o=31&a,s=!!(32&a),l=(192&a)>>6,d=0;if(0===l)d=n.getUint32(1,u),t+=5;else if(1===l)d=n.getUint16(1,u),t+=3;else{if(2!==l)throw new i("lepcc-decode-error","Bad count type");d=n.getUint8(1),t+=2}if(s)throw new i("lepcc-decode-error","LUT not implemented");for(var h=Math.ceil(d*o/8),c=new Uint8Array(e,t,h),p=0,f=0,y=0,g=-1>>>32-o,m=0;m<d;m++){for(;f<o;)p|=c[y]<<f,f+=8,y+=1;r[m]=p&g,p>>>=o,(f-=o)+o>32&&(p|=c[y-1]>>8-f)}return t+y}function s(e,t){return{sizeLo:e.getUint32(t+c.sizeLo,u),sizeHi:e.getUint32(t+c.sizeHi,u),count:e.getUint32(t+c.count,u),colorMapCount:e.getUint16(t+c.colorMapCount,u),lookupMethod:e.getUint8(t+c.lookupMethod),compressionMethod:e.getUint8(t+c.compressionMethod)}}function l(e,t){return{sizeLo:e.getUint32(t+p.sizeLo,u),sizeHi:e.getUint32(t+p.sizeHi,u),count:e.getUint32(t+p.count,u),scaleFactor:e.getUint16(t+p.scaleFactor,u),bitsPerPoint:e.getUint8(t+p.bitsPerPoint),reserved:e.getUint8(t+p.reserved)}}Object.defineProperty(t,"__esModule",{value:!0});var u=!0,d={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16},h={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};t.decodeXYZ=function(e){var t=new DataView(e,0),o=0,s=r(e,t,o),l=s.identifier,u=s.version;if(o+=d.byteCount,"LEPCC     "!==l)throw new i("lepcc-decode-error","Bad identifier");if(u>1)throw new i("lepcc-decode-error","Unknown version");var c=n(t,o);if(o+=h.byteCount,c.sizeHi*Math.pow(2,32)+c.sizeLo!==e.byteLength)throw new i("lepcc-decode-error","Bad size");var p=new Float64Array(3*c.count),f=[],y=[],g=[],m=[];if((o=a(e,o=a(e,o=a(e,o=a(e,o,f),y),g),m))!==e.byteLength)throw new i("lepcc-decode-error","Bad length");for(var v=0,b=0,_=0;_<f.length;_++){b+=f[_];for(var x=0,w=0;w<y[_];w++){x+=g[v];var S=m[v];p[3*v]=Math.min(c.maxX,c.minX+2*c.errorX*x),p[3*v+1]=Math.min(c.maxY,c.minY+2*c.errorY*b),p[3*v+2]=Math.min(c.maxZ,c.minZ+2*c.errorZ*S),v++}}return{errorX:c.errorX,errorY:c.errorY,errorZ:c.errorZ,result:p}};var c={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};t.decodeRGB=function(e){var t=new DataView(e,0),n=0,a=r(e,t,n),o=a.identifier,l=a.version;if(n+=d.byteCount,"ClusterRGB"!==o)throw new i("lepcc-decode-error","Bad identifier");if(l>1)throw new i("lepcc-decode-error","Unknown version");var u=s(t,n);if(n+=c.byteCount,u.sizeHi*Math.pow(2,32)+u.sizeLo!==e.byteLength)throw new i("lepcc-decode-error","Bad size");if((2===u.lookupMethod||1===u.lookupMethod)&&0===u.compressionMethod){if(3*u.colorMapCount+u.count+n!==e.byteLength||u.colorMapCount>256)throw new i("lepcc-decode-error","Bad count");for(var h=new Uint8Array(e,n,3*u.colorMapCount),p=new Uint8Array(e,n+3*u.colorMapCount,u.count),f=new Uint8Array(3*u.count),y=0;y<u.count;y++){var g=p[y];f[3*y]=h[3*g],f[3*y+1]=h[3*g+1],f[3*y+2]=h[3*g+2]}return f}if(0===u.lookupMethod&&0===u.compressionMethod){if(3*u.count+n!==e.byteLength||0!==u.colorMapCount)throw new i("lepcc-decode-error","Bad count");return new Uint8Array(e,n).slice()}if(u.lookupMethod<=2&&1===u.compressionMethod){if(n+3!==e.byteLength||1!==u.colorMapCount)throw new i("lepcc-decode-error","Bad count");var m=t.getUint8(n),v=t.getUint8(n+1),b=t.getUint8(n+2);for(f=new Uint8Array(3*u.count),y=0;y<u.count;y++)f[3*y]=m,f[3*y+1]=v,f[3*y+2]=b;return f}throw new i("lepcc-decode-error","Bad method "+u.lookupMethod+","+u.compressionMethod)};var p={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};t.decodeIntensity=function(e){var t=new DataView(e,0),n=0,a=r(e,t,n),s=a.identifier,u=a.version;if(n+=d.byteCount,"Intensity "!==s)throw new i("lepcc-decode-error","Bad identifier");if(u>1)throw new i("lepcc-decode-error","Unknown version");var h=l(t,n);if(n+=p.byteCount,h.sizeHi*Math.pow(2,32)+h.sizeLo!==e.byteLength)throw new i("lepcc-decode-error","Bad size");var c=new Uint16Array(h.count);if(8===h.bitsPerPoint){if(h.count+n!==e.byteLength)throw new i("lepcc-decode-error","Bad size");for(var f=new Uint8Array(e,n,h.count),y=0;y<h.count;y++)c[y]=f[y]*h.scaleFactor}else if(16===h.bitsPerPoint){if(2*h.count+n!==e.byteLength)throw new i("lepcc-decode-error","Bad size");for(f=new Uint16Array(e,n,h.count),y=0;y<h.count;y++)c[y]=f[y]*h.scaleFactor}else{if(o(e,n,f=[])!==e.byteLength)throw new i("lepcc-decode-error","Bad size");for(y=0;y<h.count;y++)c[y]=f[y]*h.scaleFactor}return c}}.apply(null,r))||(e.exports=n)},1591:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(99),i(9)],void 0===(n=function(e,t,i,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._deferreds=[],this._values=[]}return e.prototype.push=function(e){var t=this;return r.create(function(i,r){t._deferreds.push({resolve:i,reject:r}),t._values.push(e)})},e.prototype.unshift=function(e){var t=this;return r.create(function(i,r){t._deferreds.unshift({resolve:i,reject:r}),t._values.unshift(e)})},Object.defineProperty(e.prototype,"length",{get:function(){return this._deferreds.length},enumerable:!0,configurable:!0}),e.prototype.process=function(){return 0!==this.length&&(this._deferreds.shift().resolve(this._values.shift()),!0)},e.prototype.cancelAll=function(){for(var e=new i,t=0,r=this._deferreds;t<r.length;t++)r[t].reject(e);this._deferreds.length=0,this._values.length=0},e}();t.PromiseQueue=n}.apply(null,r))||(e.exports=n)},1596:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var i=t.toLowerCase(),r=0,n=Object.keys(e);r<n.length;r++){var a=n[r];if(a.toLowerCase()===i)return e[a]}return null}}.apply(null,r))||(e.exports=n)},1625:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.create=function(){var e=new Float32Array(4);return e[3]=1,e},t.clone=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},t.fromValues=function(e,t,i,r){var n=new Float32Array(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n},t.createView=function(e,t){return new Float32Array(e,t,4)}}.apply(null,r))||(e.exports=n)},1631:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){function i(e,t,i,r,n,o,s,l,u,d,h){return function(e,t,i){for(var r=b(e.maxVert[0],e.minVert[0]),n=0,a=1;a<7;++a){var o=b(e.maxVert[a],e.minVert[a]);o>r&&(r=o,n=a)}y(t,e.minVert[n]),y(i,e.maxVert[n])}(e,r,n),b(r,n)<x?1:(p(s,r,n),m(s,s),function(e,t,i,r){for(var n=e.data,a=e.offsetIdx,o=e.strideIdx,s=Number.NEGATIVE_INFINITY,l=0,u=a;u<n.length;u+=o){M[0]=n[u]-t[0],M[1]=n[u+1]-t[1],M[2]=n[u+2]-t[2];var d=i[0]*M[0]+i[1]*M[1]+i[2]*M[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],c=M[0]*M[0]+M[1]*M[1]+M[2]*M[2],p=c-d*d/h;p>s&&(s=p,l=u)}return y(r,n,l),s}(t,r,s,o)<x?2:(p(l,n,o),m(l,l),p(u,o,r),m(u,u),g(i,l,s),m(i,i),a(t,i,s,l,u,d),0))}function r(e,t,i,r,o,s,l,u,d,h){n(e,t,i,r,o,C,I),void 0!==C[0]&&(p(E,C,i),m(E,E),p(D,C,r),m(D,D),p(F,C,o),m(F,F),g(V,D,s),m(V,V),g(O,F,l),m(O,O),g(P,E,u),m(P,P),a(e,V,s,D,E,d),a(e,O,l,F,D,d),a(e,P,u,E,F,d)),void 0!==I[0]&&(p(E,I,i),m(E,E),p(D,I,r),m(D,D),p(F,I,o),m(F,F),g(V,D,s),m(V,V),g(O,F,l),m(O,O),g(P,E,u),m(P,P),a(e,V,s,D,E,d),a(e,O,l,F,D,d),a(e,P,u,E,F,d))}function n(e,t,i,r,n,a,o){!function(e,t,i,r,n){var a=e.data,o=e.offsetIdx,s=e.strideIdx;y(r,a,o),y(n,r),i[0]=_(U,t),i[1]=i[0];for(var l=o+s;l<a.length;l+=s){var u=a[l]*t[0]+a[l+1]*t[1]+a[l+2]*t[2];u<i[0]&&(i[0]=u,y(r,a,l)),u>i[1]&&(i[1]=u,y(n,a,l))}}(e,t,G,o,a);var s=_(i,t);G[1]-x<=s&&(a[0]=void 0),G[0]+x>=s&&(o[0]=void 0)}function a(e,t,i,r,n,a){if(!(v(t)<x)){g(R,i,t),g(N,r,t),g(A,n,t),o(e,t,G),L[1]=G[0],T[1]=G[1],j[1]=T[1]-L[1];for(var s=[i,r,n],l=[R,N,A],u=0;u<3;++u){o(e,s[u],G),L[0]=G[0],T[0]=G[1],o(e,l[u],G),L[2]=G[0],T[2]=G[1],j[0]=T[0]-L[0],j[2]=T[2]-L[2];var d=h(j);d<a.quality&&(y(a.b0,s[u]),y(a.b1,t),y(a.b2,l[u]),a.quality=d)}}}function o(e,t,i){var r=e.data,n=e.offsetIdx,a=e.strideIdx;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(var o=n;o<r.length;o+=a){var s=r[o]*t[0]+r[o+1]*t[1]+r[o+2]*t[2];i[0]=Math.min(i[0],s),i[1]=Math.max(i[1],s)}}function s(e,t,i){y(i.center,e),f(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}function l(e,t,i){y(B,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?B[0]=0:Math.abs(t[1])>Math.abs(t[2])?B[1]=0:B[2]=0,v(B)<x&&(B[0]=B[1]=B[2]=1),g(q,t,B),m(q,q),g(z,t,q),m(z,z),u(e,t,q,z,Q,k),p(H,k,Q),d(t,q,z,Q,k,H,i)}function u(e,t,i,r,n,a){o(e,t,G),n[0]=G[0],a[0]=G[1],o(e,i,G),n[1]=G[0],a[1]=G[1],o(e,r,G),n[2]=G[0],a[2]=G[1]}function d(e,t,i,r,n,a,o){X[0]=e[0],X[1]=e[1],X[2]=e[2],X[3]=t[0],X[4]=t[1],X[5]=t[2],X[6]=i[0],X[7]=i[1],X[8]=i[2],function(e,t){var i=t[0]+t[4]+t[8];if(i>0){var r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{var n=0;t[4]>t[0]&&(n=1),t[8]>t[3*n+n]&&(n=2);var a=(n+1)%3,o=(n+2)%3,r=Math.sqrt(t[3*n+n]-t[3*a+a]-t[3*o+o]+1);e[n]=.5*r,r=.5/r,e[3]=(t[3*a+o]-t[3*o+a])*r,e[a]=(t[3*a+n]+t[3*n+a])*r,e[o]=(t[3*o+n]+t[3*n+o])*r}}(o.quaternion,X),c(W,r,n),f(W,W,.5),f(o.center,e,W[0]),f(Y,t,W[1]),c(o.center,o.center,Y),f(Y,i,W[2]),c(o.center,o.center,Y),f(o.halfSize,a,.5)}function h(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function c(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function p(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function f(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function y(e,t,i){void 0===i&&(i=0),e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function g(e,t,i){var r=t[0],n=t[1],a=t[2],o=i[0],s=i[1],l=i[2];e[0]=n*l-a*s,e[1]=a*o-r*l,e[2]=r*s-n*o}function m(e,t){var i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){var r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function v(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function b(e,t){var i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return i*i+r*r+n*n}function _(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}Object.defineProperty(t,"__esModule",{value:!0});var x=1e-6,w=[0,0,0],S=[0,0,0];t.computeOBB=function(e,t){var n=e.data,a=e.strideIdx,o=n.length/a;if(!(o<=0)){var y=new J(e);c(w,y.minProj,y.maxProj),f(w,w,.5),p(S,y.maxProj,y.minProj);var g=h(S),m=new $;m.quality=g,o<14&&(e={data:new Float64Array(y.buffer,112,42),size:3,offsetIdx:0,strideIdx:3});var v=[0,0,0],b=[0,0,0],_=[0,0,0],x=[0,0,0],C=[0,0,0],I=[0,0,0],E=[0,0,0];switch(i(y,e,E,v,b,_,x,C,I,m)){case 1:return void s(w,S,t);case 2:return void l(e,x,t)}r(e,E,v,b,_,x,C,I,m),u(e,m.b0,m.b1,m.b2,Q,k);var D=[0,0,0];p(D,k,Q),m.quality=h(D),m.quality<g?d(m.b0,m.b1,m.b2,Q,k,D,t):s(w,S,t)}};var C=[0,0,0],I=[0,0,0],E=[0,0,0],D=[0,0,0],F=[0,0,0],V=[0,0,0],O=[0,0,0],P=[0,0,0],M=[0,0,0],G=[0,0],R=[0,0,0],N=[0,0,0],A=[0,0,0],T=[0,0,0],L=[0,0,0],j=[0,0,0],U=[0,0,0],B=[0,0,0],q=[0,0,0],z=[0,0,0],Q=[0,0,0],k=[0,0,0],H=[0,0,0],Y=[0,0,0],X=[1,0,0,0,1,0,0,0,1],W=[0,0,0],Z=7,J=function(){return function(e){this.minVert=new Array(Z),this.maxVert=new Array(Z);var t=64*Z;this.buffer=new ArrayBuffer(t);var i=0;this.minProj=new Float64Array(this.buffer,i,Z),i+=8*Z,this.maxProj=new Float64Array(this.buffer,i,Z),i+=8*Z;for(var r=0;r<Z;++r)this.minVert[r]=new Float64Array(this.buffer,i,3),i+=24;for(r=0;r<Z;++r)this.maxVert[r]=new Float64Array(this.buffer,i,3),i+=24;for(r=0;r<Z;++r)this.minProj[r]=Number.POSITIVE_INFINITY,this.maxProj[r]=Number.NEGATIVE_INFINITY;var n=new Array(Z),a=new Array(Z),o=e.data,s=e.offsetIdx,l=e.strideIdx;for(r=s;r<o.length;r+=l){var u=o[r];u<this.minProj[0]&&(this.minProj[0]=u,n[0]=r),u>this.maxProj[0]&&(this.maxProj[0]=u,a[0]=r),(u=o[r+1])<this.minProj[1]&&(this.minProj[1]=u,n[1]=r),u>this.maxProj[1]&&(this.maxProj[1]=u,a[1]=r),(u=o[r+2])<this.minProj[2]&&(this.minProj[2]=u,n[2]=r),u>this.maxProj[2]&&(this.maxProj[2]=u,a[2]=r),(u=o[r]+o[r+1]+o[r+2])<this.minProj[3]&&(this.minProj[3]=u,n[3]=r),u>this.maxProj[3]&&(this.maxProj[3]=u,a[3]=r),(u=o[r]+o[r+1]-o[r+2])<this.minProj[4]&&(this.minProj[4]=u,n[4]=r),u>this.maxProj[4]&&(this.maxProj[4]=u,a[4]=r),(u=o[r]-o[r+1]+o[r+2])<this.minProj[5]&&(this.minProj[5]=u,n[5]=r),u>this.maxProj[5]&&(this.maxProj[5]=u,a[5]=r),(u=o[r]-o[r+1]-o[r+2])<this.minProj[6]&&(this.minProj[6]=u,n[6]=r),u>this.maxProj[6]&&(this.maxProj[6]=u,a[6]=r)}for(r=0;r<Z;++r){var d=n[r];y(this.minVert[r],o,d),d=a[r],y(this.maxVert[r],o,d)}}}(),$=function(){return function(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}()}.apply(null,r))||(e.exports=n)},1636:function(e,t,i){var r,n;r=[i.dj.c(e.i),t],void 0===(n=function(e,t){function i(e,t){if(!e||e.symbol)return null;var i=t.renderer;return e&&i&&i.getObservationRenderer?i.getObservationRenderer(e):i}function r(e,t){if(e.symbol)return e.symbol;var r=i(e,t);return r&&r.getSymbol(e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.getRenderer=i,t.getSymbol=r,t.getRenderingInfo=function(e,t){var n=i(e,t),a=r(e,t);if(!a)return null;var o={renderer:n,symbol:a};if(!(n&&"visualVariables"in n&&n.visualVariables))return o;for(var s=["proportional","proportional","proportional"],l=0,u=n.getVisualVariableValues(e,t);l<u.length;l++){var d=u[l],h=d.variable,c=d.value;if("color"===h.type)o.color=c.toRgba();else if("size"===h.type)if("outline"===h.target)o.outlineSize=c;else{var p=h.axis,f=h.useSymbolValue?"symbolValue":c;"width"===p?s[0]=f:"depth"===p?s[1]=f:"height"===p?s[2]=f:s[0]=s[1]="width-and-depth"===p?f:s[2]=f}else"opacity"===h.type?o.opacity=c:"rotation"===h.type&&"tilt"===h.axis?o.tilt=c:"rotation"===h.type&&"roll"===h.axis?o.roll=c:"rotation"===h.type&&(o.heading=c)}return(isFinite(s[0])||isFinite(s[1])||isFinite(s[2]))&&(o.size=s),o}}.apply(null,r))||(e.exports=n)},1637:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(79),i(6),i(23),i(17),i(9),i(21),i(0),i(44),i(555),i(353),i(1575),i(1576),i(1581),i(1638),i(1574),i(1582),i(1584),i(1585),i(72),i(1596)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m,v,b,_,x,w,S){var C=function(e){function t(t){var i=e.call(this)||this;return i._handles=new s,i.highlights=new b,i.suspendResumeExtentMode="computed",i.dataExtent=null,i.suspendResumeExtent=null,i}return i(t,e),Object.defineProperty(t.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating)},enumerable:!0,configurable:!0}),t.prototype.normalizeCtorArgs=function(e){var t=!e.queryGraphicUIDsInExtent&&(e.scaleVisibilityEnabled||e.elevationAlignmentEnabled)?new x({spatialReference:e.owner.view.spatialReference}):null,i=e.frustumVisibilityEnabled?new v:null,r=e.scaleVisibilityEnabled?new _:null,n=e.filterVisibilityEnabled&&"multipatch"!==e.layer.geometryType?new m.Graphics3DFilterVisibility({geometryType:e.layer.geometryType}):null,a=e.elevationAlignmentEnabled?new g:null,o=new y({owner:e.owner,layer:e.layer,asyncUpdates:e.asyncGraphicsUpdates,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1}),s=e.updateClippingExtent,l=e.queryGraphicUIDsInExtent,u=e.suspendResumeExtentMode,d=e.dataExtent;return{graphicsCore:o,frustumVisibility:i,scaleVisibility:r,filterVisibility:n,elevationAlignment:a,spatialIndex:t,updateClippingExtent:s,suspendResumeExtentMode:u,dataExtent:d,queryGraphicUIDsInExtent:l||function(e,i,r){return t.queryGraphicUIDsInExtent(e,i,r)}}},t.prototype.initialize=function(){var e=this;this.scaleVisibility&&this._handles.add(this.layer.watch(["minScale","maxScale"],function(){return e.scaleVisibility.layerMinMaxScaleChangeHandler()})),this.filterVisibility&&this._handles.add(this.owner.watch("filter",function(){return e.filterVisibility.filterChanged()})),this.elevationAlignment&&this._handles.add(this.layer.watch("elevationInfo",function(t,i){c.diff(t,i)&&e.graphicsCore.elevationInfoChange()})),this._handles.add(this.layer.watch("labelsVisible",function(){return e.graphicsCore.updateVisibilityInfo()})),this._handles.add(this.layer.watch("labelingInfo",function(t,i){c.diff(t,i)&&e.graphicsCore.updateLabelingInfo()}))},t.prototype.setup=function(){var e=this;this.frustumVisibility&&this.frustumVisibility.setup(this.owner);var t=this.owner,i=this.owner.view.basemapTerrain;if(this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,this.queryGraphicUIDsInExtent,this.graphicsCore,i),this.filterVisibility&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment){var r=t.view.elevationProvider;this.elevationAlignment.setup(t,this.queryGraphicUIDsInExtent,this.graphicsCore,r)}return this.highlights&&this.highlights.setup(this.graphicsCore),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility,this.spatialIndex)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,spatialIndex:this.spatialIndex,deconfliction:this.deconfliction,labeling:this.labeling,highlights:this.highlights}),this._handles.add([this.layer.watch("renderer",function(t){return e.graphicsCore.rendererChange(t)}),t.watch("fullOpacity",function(){return e.graphicsCore.opacityChange()})]),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this._handles.add(t.view.watch("clippingArea",function(){return e._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?this.graphicsCore.updateLabelingInfo():l.resolve()},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var e=0,t=["frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","highlights","graphicsCore","spatialIndex"];e<t.length;e++){var i=t[e],r=this[i];r&&(r.destroy(),this._set(i,null))}this._set("layer",null),this._set("owner",null)},t.prototype.highlight=function(e,t,i){var r=this;if(e instanceof p){var a=this.highlights.acquireSet(t,i),o=a.set,s=a.handle;return this.owner.queryObjectIds(e).then(function(e){return r.highlights.setObjectIds(o,e)}),s}if("number"==typeof e)return this.highlight([e],t,i);if(e instanceof n)return this.highlight([e],t,i);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof n){var l=e;if(!i||!l[0].attributes||null===S.attributeLookup(l[0].attributes,i)){var u=l.map(function(e){return e.uid}),d=this.highlights.acquireSet(t,null),h=d.set;s=d.handle;return this.highlights.setUids(h,u),s}e=l.map(function(e){return S.attributeLookup(e.attributes,i)})}if("number"==typeof e[0]){var c=e,f=this.highlights.acquireSet(t,i);h=f.set,s=f.handle;return this.highlights.setObjectIds(h,c),s}}return E},t.prototype._updateClippingExtent=function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())},t.prototype.setupSuspendResumeExtent=function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(u.init(this,"suspendResumeExtentMode",function(){switch(e._handles.remove(I),e.suspendResumeExtentMode){case"computed":e._handles.add(u.init(e.graphicsCore,"computedExtent",function(t){return e.updateSuspendResumeExtent(t)}),I);break;case"data":e._handles.add(u.init(e,"dataExtent",function(t){return e.updateSuspendResumeExtent(t)}),I);break;default:o.neverReached(e.suspendResumeExtentMode)}}))},t.prototype.updateSuspendResumeExtent=function(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},t.prototype.extentToSuspendResumeRect=function(e,t){var i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!h.canProject(e,i))return;e=h.project(e,i)}return w.enlargeExtent(e,t,f.SUSPEND_RESUME_EXTENT_OPTIMISM)},t.prototype.suspendResumeExtentChanged=function(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)},r([d.property({aliasOf:"graphicsCore.layer"})],t.prototype,"layer",void 0),r([d.property({aliasOf:"graphicsCore.owner"})],t.prototype,"owner",void 0),r([d.property({constructOnly:!0})],t.prototype,"updateClippingExtent",void 0),r([d.property({constructOnly:!0})],t.prototype,"queryGraphicUIDsInExtent",void 0),r([d.property({constructOnly:!0})],t.prototype,"graphicsCore",void 0),r([d.property({constructOnly:!0})],t.prototype,"spatialIndex",void 0),r([d.property({constructOnly:!0})],t.prototype,"scaleVisibility",void 0),r([d.property({constructOnly:!0})],t.prototype,"filterVisibility",void 0),r([d.property({constructOnly:!0})],t.prototype,"elevationAlignment",void 0),r([d.property({constructOnly:!0})],t.prototype,"frustumVisibility",void 0),r([d.property({readOnly:!0})],t.prototype,"deconfliction",void 0),r([d.property({readOnly:!0})],t.prototype,"labeling",void 0),r([d.property({readOnly:!0})],t.prototype,"highlights",void 0),r([d.property()],t.prototype,"suspendResumeExtentMode",void 0),r([d.property()],t.prototype,"dataExtent",void 0),r([d.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],t.prototype,"suspended",null),r([d.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating"]})],t.prototype,"updating",null),r([d.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],t)}(d.declared(a)),I="suspendResumeExtentMode",E={remove:function(){},pause:function(){},resume:function(){}};return C}.apply(null,r))||(e.exports=n)},1638:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(43),i(6),i(17),i(10),i(21),i(0),i(65),i(69),i(547),i(550),i(1544),i(1553)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y){Object.defineProperty(t,"__esModule",{value:!0});var g=s.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility"),m=function(e){function t(t){var i=e.call(this)||this;return i._dirty=!1,i._querying=!1,i._handles=new o,i}return i(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this._dirty||this._querying||null!=this._queryResult},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureGeometryType",{get:function(){switch(this.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.geometryType;case"mesh":case"extent":return"polygon"}},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t){var i=this;this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,e.layer.timeInfo&&(this._timeInfo=e.layer.timeInfo.toJSON()),this._scheduler=this._layerView.view.resourceController.scheduler,this._handles.add(this._scheduler.registerTask(4,function(e){return i._update(e)},function(){return i._needsUpdate()})),this._handles.add(l.on(t.owner,"loadedGraphics","change",function(e){return i._graphicsChanged(e)},function(){return i.dirty=!0}))},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null},t.prototype.clear=function(){this._queryEngine&&(this._queryEngine.destroy(),this._queryEngine=null,this._queryResult=null,this._store=null,this._querying=!1,this._core.forEachGraphics3DGraphic(function(e){return e.clearVisibilityFlag(2)})),this.dirty=!1,this.notifyChange("updating")},t.prototype._graphicsChanged=function(e){if(this._queryEngine){if(e.removed&&e.removed.length>0){for(var t=new Array(e.removed.length),i=0;i<e.removed.length;++i)t[i]=e.removed[i].uid;this._store.removeManyById(t)}if(e.added&&e.added.length>0){var r=new Array(e.added.length);for(i=0;i<e.added.length;++i)r[i]=this._convertToOptimizedFeature(e.added[i]);this._store.addMany(r),this.dirty=!0}}else this.dirty=!0},t.prototype.updateVisibility=function(e){this._queryEngine&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)},t.prototype.filterChanged=function(){this.dirty=!0},Object.defineProperty(t.prototype,"active",{get:function(){return this._layerView.filter&&this._core.owner.loadedGraphics.length>0},enumerable:!0,configurable:!0}),t.prototype._ensureQueryEngine=function(e){var t=this;if(!this.active)return this.clear(),!1;if(this._queryEngine)return!0;var i,r=this._core.owner.loadedGraphics,a=n.featureGeometryTypeKebabDictionary.toJSON(this.featureGeometryType),o=new Array(r.length),s=0;return r.forEach(function(e){o[++s]=t._convertToOptimizedFeature(e),i=i||e.geometry.spatialReference}),this._store=new f.default({geometryType:a,hasM:!1,hasZ:!1}),this._store.addMany(o),this._queryEngine=new y.default({hasZ:!1,hasM:!1,geometryType:a,fields:[],timeInfo:this._timeInfo,spatialReference:i,objectIdField:this._objectIdField,featureStore:this._store,scheduler:this._scheduler,priority:4}),e.madeProgress(),!0},t.prototype._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult},t.prototype._update=function(e){var t=this;if(this._ensureQueryEngine(e)){if(this._dirty&&!this._querying&&!e.done){this._querying=!0,this.dirty=!1;var i=this._layerView.filter?this._layerView.filter.toJSON():{};this._queryEngine.executeQueryForIdSet(i).then(function(e){t._queryResult=e,t._querying=!1}).catch(function(e){g.warn("FeatureFilter query failed: "+e),t._queryResult=new Set,t._core.forEachGraphics3DGraphic(function(e){return t._queryResult.add(t._getFeatureId(e.graphic)),!1}),t._querying=!1}),e.madeProgress()}this._queryResult&&!e.done&&(this._core.forEachGraphics3DGraphic(function(i){if(e.done)return!1;var r=t._queryResult.has(t._getFeatureId(i.graphic));return!!i.setVisibilityFlag(2,r,0)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null)),this.notifyChange("updating")}else this.dirty=!1},t.prototype._convertToOptimizedFeature=function(e){var t=e.geometry;if("mesh"===t.type||"extent"===t.type){var i=d.fromExtent("mesh"===t.type?t.extent:t);return i.hasZ=!1,i.hasM=!1,new p.default(c.convertFromGeometry(i),e.attributes,null,this._getFeatureId(e))}return c.convertFromFeature(e,h.getJsonType(e.geometry),!1,!1,this._objectIdField)},t.prototype._getFeatureId=function(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId},Object.defineProperty(t.prototype,"dirty",{set:function(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))},enumerable:!0,configurable:!0}),r([u.property({readOnly:!0})],t.prototype,"updating",null),r([u.property({constructOnly:!0})],t.prototype,"geometryType",void 0),r([u.property({readOnly:!0,dependsOn:["geometryType"]})],t.prototype,"featureGeometryType",null),r([u.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],t)}(u.declared(a));t.Graphics3DFilterVisibility=m}.apply(null,r))||(e.exports=n)},1643:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(6),i(10),i(0),i(559),i(127),i(1516)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u){Object.defineProperty(t,"__esModule",{value:!0});var d=a.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t.logError=function(e){t._definitionExpressionErrors<t._maxDefinitionExpressionErrors&&d.error("Error while evaluating definitionExpression: "+e),++t._definitionExpressionErrors===t._maxDefinitionExpressionErrors&&d.error("Further errors are ignored")},t}return i(t,e),Object.defineProperty(t.prototype,"parsedDefinitionExpression",{get:function(){if(this.layer.definitionExpression)try{var e=s.create(this.layer.definitionExpression);if(!e.isStandardized())return d.error("definitionExpression is using non standard function"),null;var t=[],i=e.getFields();return u.findFieldsCaseInsensitive(i,this.layer.fields,{missingFields:t}),t.length>0?(d.error("definitionExpression references unknown fields: "+t.join(", ")),null):(this._definitionExpressionErrors=0,e)}catch(e){return d.error("Failed to parse definitionExpression: "+e),null}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definitionExpressionFields",{get:function(){return this.parsedDefinitionExpression?l.fixFields(this.layer.fields,this.parsedDefinitionExpression.getFields()):null},enumerable:!0,configurable:!0}),t.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(e){return this.logError(e),!1}},r([o.property()],t.prototype,"layer",void 0),r([o.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],t.prototype,"parsedDefinitionExpression",null),r([o.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],t.prototype,"definitionExpressionFields",null),r([o.subclass("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t)}(o.declared(n));t.DefinitionExpressionSceneLayerView=h,t.default=h}.apply(null,r))||(e.exports=n)},1678:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(11),i(170),i(32),i(9),i(558),i(96),i(547),i(1679),i(1554),i(1518),i(1590),i(1562)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p){Object.defineProperty(t,"__esModule",{value:!0});var f=function(){function e(e,t,i){this.items=e,this.queryGeometry=t,this.definitionExpression=i.definitionExpression,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.fieldsMap=i.fieldsMap,this.timeInfo=i.timeInfo}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){var t;return t=e.outStatistics?e.outStatistics.some(function(e){return"exceedslimit"===e.statisticType})?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e),e.returnQueryGeometry&&(s.isValid(e.outSR)&&!s.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=p.cleanFromGeometryEngine(i({spatialReference:e.outSR},h.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=p.cleanFromGeometryEngine(i({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var i=d.getWhereClause(t.where);if(!i)return a.resolve(this);if(i.isStandardized()){for(var r=0,n=[],o=0,s=this.items;o<s.length;o++){var l=s[o];i.testFeature(l.attributes)&&(n[r++]=l)}var u=new e(n,this.queryGeometry,this);return u.definitionExpression=t.where,a.resolve(u)}return a.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return a.resolve(this);var i=new r.default(t.objectIds);return a.resolve(new e(this.items.filter(function(e){return i.has(e.objectId)}),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var i=c.getTimeOperator(this.timeInfo,t.timeExtent);if(!n.isSome(i))return a.resolve(this);var r=this.items.filter(i);return a.resolve(new e(r,this.queryGeometry,this))},e.prototype.project=function(t){var i=this;return!t||s.equals(this.spatialReference,t)?a.resolve(this):h.projectMany(this.items.map(function(e){return p.getGeometry(i,e)}),this.spatialReference,t).then(function(r){for(var n=[],a=0;a<i.items.length;a++)n[a]={attributes:i.items[a].attributes,geometry:r[a]};var o=[];return l.convertFromFeatures(o,n,i.geometryType,i.hasZ,i.hasM,i.objectIdField),new e(o,i.queryGeometry,{definitionExpression:i.definitionExpression,geometryType:i.geometryType,hasM:i.hasM,hasZ:i.hasZ,objectIdField:i.objectIdField,spatialReference:t,fieldsMap:i.fieldsMap,timeInfo:i.timeInfo})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,i=this.items,r=this,n=r.geometryType,a=r.hasM,s=r.hasZ,l=r.objectIdField,u=r.spatialReference,d=e.outFields,h=e.outSR,c=e.quantizationParameters,f=e.resultRecordCount,y=e.resultOffset,g=!1;if(null!=f&&null!=y){var m=y+f;g=i.length>m,i=i.slice(y,Math.min(i.length,m))}return{exceededTransferLimit:g,features:this._createFeatures(e,i),fields:d&&d.map(function(e){return t.fieldsMap.get(e)}),geometryType:n,hasM:a,hasZ:s,objectIdFieldName:l,spatialReference:p.cleanFromGeometryEngine(h||u),transform:c&&o.toQuantizationTransform(c)||null}},e.prototype._createFeatures=function(e,t){var i=new u.default(e,this.fieldsMap),r=e.quantizationParameters,n=e.returnGeometry,a=e.returnCentroid,s=e.maxAllowableOffset,l=e.orderByFields,d=[],h=0;if(t.length&&l&&l.length){var c=l[0].split(" "),f=c[0],y="DESC"===c[1];t.sort(function(e,t){var r=i.getFieldValue(e,f),n=i.getFieldValue(t,f);if("number"==typeof r&&"number"==typeof n)return y?n-r:r-n;if("string"==typeof r&&"string"==typeof n){var a=r.toUpperCase(),o=n.toUpperCase();return(y?a>o:a<o)?-1:(y?a<o:a>o)?1:0}})}if(n||a){var g=o.toQuantizationTransform(r);if(n&&!a)for(var m=0,v=t;m<v.length;m++){var b=v[m];d[h++]={attributes:i.getAttributes(b),geometry:p.getGeometry(this,b,s,g)}}else if(!n&&a)for(var _=0,x=t;_<x.length;_++){b=x[_];d[h++]={attributes:i.getAttributes(b),centroid:p.getCentroid(this,b,g)}}else for(var w=0,S=t;w<S.length;w++){b=S[w];d[h++]={attributes:i.getAttributes(b),centroid:p.getCentroid(this,b,g),geometry:p.getGeometry(this,b,s,g)}}}else for(var C=0,I=t;C<I.length;C++){b=I[C];var E=i.getAttributes(b);E&&(d[h++]={attributes:E})}return d},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,i=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,a=0,o=e.outStatistics;a<o.length;a++){var s=o[a];if("exceedslimit"===s.statisticType){i=null!=s.maxPointCount?s.maxPointCount:Number.POSITIVE_INFINITY,r=null!=s.maxRecordCount?s.maxRecordCount:Number.POSITIVE_INFINITY,n=null!=s.maxVertexCount?s.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>i;else if(this.items.length>r)t=!0;else{var l=this.hasZ?this.hasM?4:3:this.hasM?3:2;t=this.items.reduce(function(e,t){return e+(t.geometry&&t.geometry.coords.length||0)},0)/l>n}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=new u.default(e,this.fieldsMap),i=e.outStatistics,r=[],n=[],a=e.groupByFieldsForStatistics,o=e.having,s=a&&a.length,l=s&&a[0],d={},h={},c={},p={attributes:{}},f=0,y=i;f<y.length;f++){var g=y[f],m=g.outStatisticFieldName,v=g.statisticType,b="exceedslimit"!==g.statisticType?g.onStatisticField:void 0,_="1"===b;if(s&&(b===l||_)&&"count"===g.statisticType){d[b]||(d[b]=this._calculateUniqueValues(t,_?l:b));var x=d[b];for(var w in x){var S=x[w],C=S.count,I=S.data,E=S.items,D=h[I]||{attributes:{}};o&&!t.validateItems(E,o)||(D.attributes[m]=C,D.attributes[_?"EXPR_1":b]=I,h[I]=D)}n.push({name:m,alias:m,type:"esriFieldTypeString"})}else{if(s){var F=this._calculateUniqueValues(t,l);for(var w in F){var V=F[w];I=V.data,E=V.items;if(!o||t.validateItems(E,o)){D=h[I]||{attributes:{}};var O=this._calculateStatistics(E,t,b),P="var"===v?"variance":v;D.attributes[m]=O[P],D.attributes[l]=I,h[I]=D}}}else{c[b]||(c[b]=this._calculateStatistics(this.items,t,b));O=c[b],P="var"===v?"variance":v;p.attributes[m]=O[P]}n.push({name:m,alias:m,type:"esriFieldTypeDouble"})}}if(s)for(var M in h)r.push(h[M]);else r.push(p);return{fields:n,features:r}},e.prototype._calculateStatistics=function(e,t,i){for(var r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,a=null,o=null,s=null,l=null,u=[],d=0;d<e.length;d++){var h=e[d];null==(g=t.getFieldValue(h,i))||isNaN(g)||(a+=g,r=Math.min(r,g),n=Math.max(n,g),u.push(g))}var c=u.length;if(c){o=a/c;for(var p=0,f=0,y=u;f<y.length;f++){var g=y[f];p+=Math.pow(g-o,2)}l=c>1?p/(c-1):0,s=Math.sqrt(l)}else r=null,n=null;return{avg:o,count:c,max:n,min:r,stddev:s,sum:a,variance:l}},e.prototype._calculateUniqueValues=function(e,t){for(var i={},r=0,n=this.items;r<n.length;r++){var a=n[r],o=e.getFieldValue(a,t);(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==i[o]?i[o]={count:1,data:o,items:[a]}:(i[o].count++,i[o].items.push(a))}return i},e}();t.default=f}.apply(null,r))||(e.exports=n)},1679:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(546),i(1554)],void 0===(n=function(e,t,i,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this._fieldDataCache=new i.default,this._returnDistinctMap=new i.default,this.returnDistinctValues=e.returnDistinctValues,this.fieldsMap=t;var n=e.outFields;if(n&&-1===n.indexOf("*")){this.outFields=n;for(var a=0,o=0,s=n;o<s.length;o++){var l=s[o],u=r.getExpressionFromFieldName(l),d=this.fieldsMap.has(u),h=d?null:r.getWhereClause(u),c=d?this.fieldsMap.get(l).name:r.getAliasFromFieldName(l)||"FIELD_EXP_"+a++;this._fieldDataCache.set(l,{alias:c,clause:h})}}}return e.prototype.getAttributes=function(e){var t=e.attributes;return t=this._processAttributesForOutFields(t),this._processAttributesForDistinctValues(t)},e.prototype.getFieldValue=function(e,t){var i=e.attributes,n=this.fieldsMap.has(t),a=n?this.fieldsMap.get(t).name:t,o=null;return this._fieldDataCache.has(a)?o=this._fieldDataCache.get(a).clause:n||(o=r.getWhereClause(t),this._fieldDataCache.set(a,{alias:a,clause:o})),n?i[a]:o.calculateValue(i)},e.prototype.validateItem=function(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:r.getWhereClause(t)}),this._fieldDataCache.get(t).clause.testFeature(e.attributes)},e.prototype.validateItems=function(e,t){var i=this;this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:r.getWhereClause(t)});var n=e.map(function(e){return i.getAttributes(e)});return this._fieldDataCache.get(t).clause.testSet(n)},e.prototype._processAttributesForOutFields=function(e){var t=this.outFields;if(!e||!t||!t.length)return e;for(var i={},r=0,n=t;r<n.length;r++){var a=n[r],o=this._fieldDataCache.get(a),s=o.alias,l=o.clause;i[s]=l?l.calculateValue(e):e[s]}return i},e.prototype._processAttributesForDistinctValues=function(e){if(!e||!this.returnDistinctValues)return e;var t=this.outFields,i=[];if(t)for(var r=0,n=t;r<n.length;r++){var a=n[r],o=this._fieldDataCache.get(a).alias;i.push(e[o])}else for(var o in e)i.push(e[o]);var s=(t||["*"]).join(",")+"="+i.join(","),l=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++l),l>1?null:e},e}();t.default=n}.apply(null,r))||(e.exports=n)},1696:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(82)],void 0===(n=function(e,t,i){return function(){function e(e){this.sourceSpatialReference=e.sourceSpatialReference,this.destSpatialReference=e.destSpatialReference}return e.prototype.adjust=function(e){var t=this._getVerticalUnitScale();1!==t&&this._scaleVerticalUnits(e,t)},e.prototype._getVerticalUnitScale=function(){return this.sourceSpatialReference&&!this.sourceSpatialReference.equals(this.destSpatialReference)?i.getMetersPerVerticalUnitForSR(this.sourceSpatialReference)/i.getMetersPerVerticalUnitForSR(this.destSpatialReference):1},e.prototype._vertexListsScaleZ=function(e,t){for(var i=0;i<e.length;++i)for(var r=e[i],n=0;n<r.length;++n){r[n][2]*=t}},e.prototype._scaleVerticalUnits=function(e,t){for(var i=0;i<e.length;++i){var r=e[i].geometry;r&&r.hasZ&&(this._geometryIsPoint(r)?null!==r.z&&(r.z*=t):this._geometryIsPolyline(r)?this._vertexListsScaleZ(r.paths,t):this._geometryIsPolygon(r)&&this._vertexListsScaleZ(r.rings,t))}},e.prototype._geometryIsPoint=function(e){return"point"===e.type},e.prototype._geometryIsPolygon=function(e){return"polygon"===e.type},e.prototype._geometryIsPolyline=function(e){return"polyline"===e.type},e}()}.apply(null,r))||(e.exports=n)},1706:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(99),i(6),i(52),i(48),i(17),i(19),i(10),i(88),i(209),i(9),i(21),i(0),i(4),i(3),i(45),i(1591),i(1707),i(1708),i(1709),i(1710),i(1516),i(1711),i(222),i(51)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m,v,b,_,x,w,S,C,I,E,D){function F(e,t){return e.length===t.length&&e.every(function(e){return V(t,e.name)>=0})}function V(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}function O(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var P=d.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),M=function(e){function t(t){var i=e.call(this)||this;return i.screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingPercentage=0,i.leafsReached=!1,i.uncompressedTextureDownsamplingEnabled=!1,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._downloadingNodes=new Set,i._loadingNodes=new Set,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._poi=m.vec3f64.create(),i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i.disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new l,i._idleQueue=new b.PromiseQueue,i._errorCount=0,i}return i(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(E.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return C.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return C.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.getNode(this._rootNodeId);return!e||!this._viewportQueries||(this._updateViewData(),this._viewportQueries.isNodeVisible(e))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new w(this.layerView,function(){return e.updatingChanged()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var i=this._rootNodeUrl.split("/");this._rootNodeId=i[i.length-1],this.disableIDBCache=u("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=p.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var t=e.layerView.view;e.setClippingArea(t.clippingArea),e._centerOnSurface=t.pointsOfInterest.centerOnSurfaceFrequent;var i=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),i.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),f.init(e.layerView,"suspended",function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=i.scheduler.registerIdleStateCallbacks(r,n)}),_.addTask(e.layerView.view.resourceController.scheduler,function(t,i){return e._frame(t,i),e._index?e._index.getPriority():-1/0}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),t.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("requiredFields",function(){return e._requiredFieldsChange()})]),e._viewportQueries=new I(e.crsIndex,t.renderCoordsHelper,t.state.camera,e._clippingArea,t.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(e.layer),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(e.getBaseUrl(),e._rootNodeUrl,e._rootNodeId,e.streamDataSupplier,e._viewportQueries,P,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t)},function(t){return e._needsUpdate(t)})}});this.addResolvingPromise(r),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,G.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.requiredFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.requiredFields.map(function(i){var r=V(e,i),n=V(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null}).filter(function(e){return null!=e&&e.name!==i})},t.prototype._requiredFieldsChange=function(){F(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype.setClippingArea=function(e){var t=v.create();D.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=R.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,i=m.vec3f64.create();g.vec3.subtract(i,t,this.camPos);var r=this.layerView.view.renderCoordsHelper,n=m.vec3f64.create();r.worldUpAtPosition(t,n);var a=g.vec3.angle(n,i)-.5*Math.PI;return g.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,a/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this._cameraDirty=!0,this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this.updatingChanged()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.getNode=function(e){return this._index?this._index.getNode(e):null},t.prototype.updateElevationChanged=function(e,t,i){i.clear();var r=this.getNode(this._rootNodeId);null!=r&&C.findIntersectingNodes(e,t,r,this.crsIndex,this._index,function(e){return i.push(e)});for(var n=0;n<i.length;n++){var a=i.data[n];this._viewportQueries.invalidateCache(a.id),a.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}i.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(){this._viewportQueries.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.updatingChanged()},t.prototype.schedule=function(e,t){var i=this;return this._idleQueue.push(t).then(function(t){if(!i._loadingNodes.has(e)&&!i._updatingNodes.has(e))throw new n;return t})},t.prototype.reschedule=function(e,t){var i=this;return this._idleQueue.unshift(t).then(function(t){if(!i._loadingNodes.has(e)&&!i._updatingNodes.has(e))throw new n;return t})},Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){this.layerView.suspended?this._updateView(e):(this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty),this.layerView.visible&&this._processLogError(e,t))},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?P.error("Error during processing: "+e):50===this._errorCount&&P.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var i=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateView(e),e.run(function(){return i._processIndex(t,e)}),this._updateFeatureLOD(),e.run(function(){return i._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return i._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this.updatingChanged(),this._lodHandling.lodGlobalHandling(e)}},t.prototype._processIndex=function(e,t){var i=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));this._index.update(o.keysOfSet(this._loadingNodes),t);var r=this._index.getFeatureEstimate().leafsReached;return this._index.isLoading()||r===this._get("leafsReached")||this._set("leafsReached",r),this._index.load(i)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0||this._index.updates.add.length>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.getFeatureEstimate();if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processNodes=function(e,t){var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNodeIdLoading,this),r.cancel=[];r.update.length>0&&!e.done;)this._updateLoadedNode(r.update.pop()),e.madeProgress();for(;r.add.length>0&&!e.done&&i>0&&(--i,!r.add.back().notInCache||this._hasNodeLoadToken(t));){var n=r.add.pop();this._loadNode(n),e.madeProgress()}return e.hasProgressed},t.prototype._cancelNodeLoading=function(){var e=this;this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.forEach(function(t,i){return e._updatingNodes.get(i).cancel()}),this._updatingNodes.clear()},t.prototype._cancelNodeIdLoading=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var i=t.numIndexLoading+this._index.getIndexLoading(),r=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*i-2*r)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype.updatingChanged=function(){var e=(this._index?this._index.getIndexMissing():0)+3*(this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size,t=!(!(e>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===e&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(e,this._progressMaxNumNodes),t!==this._get("updating")&&this._set("updating",t);var i=100*e/this._progressMaxNumNodes;i!==this._get("updatingPercentage")&&this._set("updatingPercentage",i)},t.prototype._updateView=function(e){this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1)},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=m.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.progressiveLoadPenalty=R.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){return this.fixedFeatureTarget?1:2*Math.min(this.layerView.view.resourceController.memoryController.memoryFactor,.5)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._viewportQueries.isGeometryVisible(e)},t.prototype.updateVisibility=function(e){return this._viewportQueries.updateNode(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&(!e.obb||this._viewportQueries.isGeometryVisible(e))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return t<1&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.calcCameraDistance(e)>this._viewportQueries.maxDistance*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=S.TextureFormat.Normal;this.layerView.useCompressedTextures?t=S.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=S.TextureFormat.Downsampled);var i=this._defaultGeometrySchema,r={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==i||null==i.ordering};this._nodeLoader=new S(this.streamDataSupplier,P,i,this._requiredAttributes,r);var n=this.layerView.view.renderSpatialReference,a=this.crsIndex.equals(n)||this.crsIndex.isWGS84&&n.equals(D.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!a,this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._viewportQueries.isNodeVisible(t)},function(t){return e._viewportQueries.isGeometryVisible(t)},function(t){return e._index.nodeTraversalState(t)},function(t,i){return e._removeNodes(t,i)},this._index,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel}),this.updatingChanged()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._nodeLoader.cancelAll(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._nodeLoader=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this.updatingChanged())},t.prototype._removeInvisibleNodes=function(e){var t=this.layerView.getLoadedNodeIDs();G.clear();for(var i=0,r=t;i<r.length;i++){var n=r[i],a=this.getNode(n);this._viewportQueries.isGeometryVisible(a)&&!this._shouldDropNode(a)||(this._lodHandling.setLodGlobalDirty(),G.push(a))}return this._removeNodes(G,e),0===G.length||(G.clear(),!1)},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate(),this.layerView.removeNodeData(e,t)},t.prototype._needsUpdate=function(e){if(null==e.featureData||0===e.featureData.length||this._updatingNodes.has(e.id))return!1;var t=this.layerView.getLoadedAttributes(e);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,i=F(this.layerView.getLoadedAttributes(e),this._requiredAttributes)?p.resolve(this.layerView.getAttributeData(e)):this._nodeLoader.loadAttributes(e,this._requiredAttributes);this._updatingNodes.set(e.id,i),i.then(function(i){return t.schedule(e.id).then(function(){return t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:i})})}).catch(function(i){i instanceof n||t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.id),t.updatingChanged()}),this.updatingChanged()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id),this.updatingChanged(),this._loadAndAddBundle(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.id),t.updatingChanged()})},t.prototype._loadAndAddBundle=function(e){var t=this;return 1!==e.featureData.length&&P.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded."),e.notInCache?this._loadUncached(e):this._loadCached(e).then(function(i){i||(e.notInCache=!0,t._index.updates.add.push(e))}).catch(function(t){t instanceof n||(e.notInCache=!0)})},t.prototype._enableFromGPUCache=function(e){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var t=this.layerView.loadCachedGPUData(e);return!!(t&&O(t.attributeInfo)&&F(t.attributeInfo.loadedAttributes,this._requiredAttributes))&&(this.layerView.addCachedGPUData(e,t),this._nodeAdded(e),!0)},t.prototype._nodeAdded=function(e){this._index.requestUpdate(),this._lodHandling.lodSwapBundleLoaded(e)},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e))return p.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule(e.id).then(function(){return i.loadCachedNodeData(e,function(e,i){return t._nodeLoader.loadTextures(e,i)})}).then(function(r){if(null==r)return!1;var n=t._requiredAttributes;return O(r)&&F(r.loadedAttributes,n)?t.reschedule(e.id).then(function(){return i.addCachedNodeData(e,r,r)}).then(function(){return t._nodeAdded(e),!0}):t.reschedule(e.id).then(function(){return t._nodeLoader.loadAttributes(e,n)}).then(function(i){return t.reschedule(e.id,{loadedAttributes:n,attributeData:i})}).then(function(t){return i.addCachedNodeData(e,r,t)}).then(function(){return t._nodeAdded(e),!0})}):p.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.id),this._nodeLoader.loadBundleData(e,0).then(function(i){return t._downloadingNodes.delete(e.id),t.schedule(e.id,i)}).then(function(i){return t.layerView.addNodeData(e,i)}).then(function(){t._nodeAdded(e),e.notInCache=!1}).catch(function(i){i instanceof n||(P.error("Failed to load node '"+e.id+"' bundle 0: "+i),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._viewportQueries&&this._viewportQueries.setCameraIdle(e),this.updatingChanged(),e&&this._index&&this._index.resetFailedNodes())},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),r([y.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r([y.property({readOnly:!0})],t.prototype,"isGraphics3D",null),r([y.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),r([y.property({readOnly:!0})],t.prototype,"crsVertex",null),r([y.property({readOnly:!0})],t.prototype,"crsIndex",null),r([y.property()],t.prototype,"camPos",void 0),r([y.property()],t.prototype,"screenSizeFactor",void 0),r([y.property()],t.prototype,"featureTarget",void 0),r([y.property()],t.prototype,"fixedFeatureTarget",void 0),r([y.property()],t.prototype,"layerView",void 0),r([y.property()],t.prototype,"layer",void 0),r([y.property({readOnly:!0})],t.prototype,"updating",void 0),r([y.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),r([y.property({readOnly:!0})],t.prototype,"leafsReached",void 0),r([y.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),r([y.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),r([y.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(y.declared(a,c,s)),G=new h,R={factorIM:.2,factor3dObject:.05,distancePenalty:10};return M}.apply(null,r))||(e.exports=n)},1707:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(52)],void 0===(n=function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(2,function(e){return t.update(e)},function(){return!0})}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r](e,i),this.runIndex=r},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){i.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),n=new Map;t.addTask=function(e,t){var i=n.get(e);return null==i&&(i=new r(e),n.set(e,i)),i.add(t),{remove:function(){if(null!=i){if(i.remove(t),i.callbacks.length>0)return void(i=null);n.delete(e),i.destroy(),i=null}}}}}.apply(null,r))||(e.exports=n)},1708:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(11),i(99),i(88),i(33),i(1523)],void 0===(n=function(e,t,i,r,n,a,o){Object.defineProperty(t,"__esModule",{value:!0});var s=["version","level","sharedResource","attributeData","geometryData","textureData","lodSelection"],l=function(){function e(e,t,i,r,o,s,l,u,h,c){var p=this;this.rootId=i,this.streamDataSupplier=r,this.viewportQueries=o,this.logger=s,this._isLoaded=l,this._isSelected=u,this._enable=h,this._needsUpdate=c,this._dirty=!0,this.nodeIndex={},this._loadingNodes=new Set,this._failedNodes=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new n,this._prefetch=new n,this._updates=new d,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.rootUrl=a.makeAbsolute(t,e),this.traverseVisible(function(e,t){return p.nodeTraversalState(t)})}return e.prototype.getNode=function(e){return this.nodeIndex[e]},Object.defineProperty(e.prototype,"size",{get:function(){return Object.keys(this.nodeIndex).length},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){u.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e,t){var r=this;if(this._dirty){this._indexMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),u.clear(),this._updates.reset(e);var n=!0,a=new h,o=new h,s=new Map;this.traverseVisible(function(l,d,h){if(r._updateNodeFeatureEstimate(d,o),!d){++r._indexMissing;var c=r.entryPriority(l);return r._loadingNodes.has(l.id)||r._failedNodes.has(l.id)||(r._missing.push(i({},l,{baseUrl:h})),s.set(l.id,c)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,c))}if(0===r._missing.length&&d.children)for(var p=0,f=d.children;p<f.length;p++){var y=f[p];r.nodeIndex[y.id]||r._loadingNodes.has(y.id)||(s.set(y.id,r.entryPriority(y)),r._prefetch.push(i({},y,{baseUrl:d.baseUrl})))}if(!d.failed&&d.featureData&&0!==d.featureData.length)if(r._isLoaded(d)){if(a.known+=d.memory,++a.knownNodes,r._isSelected(d)?d.children&&(n=!1):(a.unremoved+=d.memory,n=!1),r._needsUpdate(d)){var g=r.entryPriority(d);s.set(d.id,g),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,g),r._updates.update.push(d)}}else if(d.memory&&(a.known+=d.memory,++a.knownNodes),r._isSelected(d)){if(d.children&&(n=!1),d.memory?(a.missing+=d.memory,a.known+=d.memory,++a.knownNodes):++a.missingNodes,e.indexOf(d.id)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(d)),void(r._updates.cancel=r._updates.cancel.filter(function(e){return e!==d.id}));if(!t.done&&r._enable(d))return void t.madeProgress();var m=r.entryPriority(d);s.set(d.id,m),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,m),u.push(d)}}),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(o),this._featureEstimate.leafsReached=n,this._missing.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._missing.length>0?(this._maxUnloadedPrio=s.get(this._missing.back().id),this._prefetch.clear()):this._prefetch.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._updates.add=u.filter(function(e){var t=e.id;return s.get(t)>=r._maxUnloadedPrio},this,this._updates.add),this._updates.add.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._updates.update.sort(function(e,t){return s.get(e.id)-s.get(t.id)}),this._dirty=this._indexMissing>0}},e.prototype.checkFeatureTarget=function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,o=10;o--;){var s=new h;if(this._updateFeatureEstimate(r,s),this._computeFeatureEstimate(s)<=e){if(r>=t||s.missingNodes>0||0===o)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)},e.prototype._updateFeatureEstimate=function(e,t){var i=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,r){return i._updateNodeFeatureEstimate(r,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&null!=e.numFeatures)return this._isLoaded(e)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){if(0===this._missing.length)return!1;e=Math.min(e,this._missing.length);for(var t=0;t<e;++t)this._loadNode(this._missing.pop());return!0},e.prototype.prefetch=function(e){if(0===this._prefetch.length)return!1;e=Math.min(e,this._prefetch.length);for(var t=0;t<e;++t)this._loadNode(this._prefetch.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loadingNodes.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.id];if(t&&t.version===this._version)return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r)if(e.parentNode){var a=this.nodeIndex[e.parentNode.id];if(null==a)return null;var o=this._nodeTraversalState[a.id];n=o&&i>o.lodLevel}else n=i>0;return t?(t.lodLevel=i,t.isChosen=n,t.version=this._version,t):(this._nodeTraversalState[e.id]={nodeHasLOD:r,lodLevel:i,isChosen:n,version:this._version},this._nodeTraversalState[e.id])},e.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id);var i=a.makeAbsolute(e.href,e.baseUrl),n=function(e){t._loadingNodes.delete(e),0===t._missing.length&&0===t._loadingNodes.size&&t.requestUpdate()};this.streamDataSupplier.request(i,"json").then(function(e){var r=e.data,a={id:r.id,mbs:r.mbs,parentNode:r.parentNode,children:r.children,featureData:r.featureData};s.forEach(function(e){a[e]=r.hasOwnProperty(e)?r[e]:null}),r.hasOwnProperty("obb")&&!t.ignoreServiceOBB&&(a.obb=o.clone(r.obb),a.hasServiceOBB=!0,t.viewportQueries.updateNode(a.id)),t.nodeIndex[a.id]=a,a.baseUrl=i,a.featureData&&1===a.featureData.length&&a.featureData[0].featureRange&&(a.numFeatures=a.featureData[0].featureRange[1]-a.featureData[0].featureRange[0]+1),t.nodeTraversalState(a),n(a.id)},function(a){a instanceof r||(t.logger.error("Error loading node: "+i),t._failedNodes.add(e.id)),n(e.id)})},e.prototype.resetFailedNodes=function(){this._failedNodes.clear();for(var e=0,t=Object.keys(this.nodeIndex);e<t.length;e++){var i=t[e];this.nodeIndex[i].failed=!1}},e.prototype.entryPriority=function(e){if(null==e.mbs&&e.id===this.rootId)return 1/0;var t=0,i=this.nodeIndex[e.id];if(null!=i&&null!=i.parentNode){var r=this._nodeTraversalState[i.parentNode.id];null!=r&&(t=r.lodLevel)}for(var n=this.progressiveLoadPenalty,a=i;a;a=a.parentNode?this.nodeIndex[a.parentNode.id]:null)if(this._isLoaded(a)){n=0;break}var o=this.viewportQueries.distToPOI(e);return-o-t*(o+this.progressiveLoadPenalty)+n},e.prototype.traverseVisible=function(e){var t=this.nodeIndex[this.rootId];t?this._traverse({id:this.rootId,mbs:t.mbs,href:this.rootUrl},t,e,""):e({id:this.rootId,mbs:null,href:this.rootUrl},null,"")},e.prototype._traverse=function(e,t,i,r){if(t.children&&0!==t.children.length){if(this.viewportQueries.isNodeVisible(t)){i(e,t,r);var n=this.nodeTraversalState(t);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=0,o=t.children;a<o.length;a++){var s=o[a],l=this.nodeIndex[s.id];l?this._traverse(s,l,i,t.baseUrl):this.viewportQueries.isNodeVisible(s)&&i(s,null,t.baseUrl)}}}else this.viewportQueries.isGeometryVisible(t)&&i(e,t,r)},e.prototype.traverse=function(e,t){if(t(e)&&e.children)for(var i=0;i<e.children.length;++i){var r=this.getNode(e.children[i].id);r&&this.traverse(r,t)}},e.prototype.traverseChildren=function(e,t){if(e.children)for(var i=0;i<e.children.length;++i){var r=this.getNode(e.children[i].id);r&&t(r)&&this.traverseChildren(r,t)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e}();t.I3SIndex=l;var u=new n,d=function(){function e(){this.update=new n,this.add=new n,this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}(),h=function(){return function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}()}.apply(null,r))||(e.exports=n)},1709:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(88)],void 0===(n=function(e,t,i){var r=function(){function e(e,t){this.layerView=e,this.lodGlobalDirtyChanged=t}return e.prototype.startNodeLoading=function(e,t,i,r,n,a,o){this._lodGlobalDirty=!1,this._maxLodLevel=o.maxLodLevel,this._index=n,this._rootId=a,this._nodeTraversalState=i,this._isNodeVisible=e,this._isGeometryVisible=t,this._removeNodes=r,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.shouldLoadNode=function(e){var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0,this.lodGlobalDirtyChanged(this._lodGlobalDirty)},e.prototype.lodSwapBundleLoaded=function(e){this.setLodGlobalDirty()},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._rootId&&(!0===this._lodGlobalDirty||this.layerView.view&&this.layerView.view.resourceController.memoryController.usedMemory>1.1)},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(this.requiresLODGlobalHandling){var t=this._rootId,i=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(i-1)));n.clear(),this._lodGlobalHandlingRecursion(t,r),this._removeNodes(n,e),0===n.length&&(this._lodGlobalDirty=!1,this.lodGlobalDirtyChanged(this._lodGlobalDirty)),n.clear()}},e.prototype._lodGlobalHandlingRecursion=function(e,t){var i=this._index.getNode(e);if(null==i)return!1;var r=this._nodeTraversalState(i),a=this.isChosenMaxLOD(r),o=this.layerView.isNodeLoaded(i);if(o&&null!=this.layerView.setPolygonOffset){var s=!a;this.layerView.setPolygonOffset(i,s)}if(a&&o)return this._removeChildrenRecursive(i),!0;var l=!1;if(null!=i.children&&0!==i.children.length){l=!0;for(var u=0,d=i.children;u<d.length;u++){var h=d[u],c=this._index.getNode(h.id);(c?this._isGeometryVisible(c):this._isNodeVisible(h))&&!this._lodGlobalHandlingRecursion(h.id,t)&&(l=!1)}}o&&!a&&(l||n.length<t)&&(n.push(i),o=!1);var p=!i.featureData||0===i.featureData.length;return l||o||p},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,function(e){return n.push(e),!0})},e.prototype.childrenEmpty=function(e){var t=this,i=!0;return this._index.traverseChildren(e,function(e){return!(!i||!t._isNodeVisible(e)||t.layerView.isNodeLoaded(e)&&(i=!1,1))}),i},e.prototype._childrenRequireLoading=function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,function(e){if(!r||!t._isNodeVisible(e))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e)&&(i=!0),!t.layerView.isNodeLoaded(e)||(r=!1,!1)}),r&&i},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),n=new i;return r}.apply(null,r))||(e.exports=n)},1710:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(99),i(7),i(9),i(33),i(1530),i(1516),i(16)],void 0===(n=function(e,t,i,r,n,a,o,s,l){var u=function(){function e(t,i,r,o,s){this.loader=t,this.logger=i,this.defaultGeometrySchema=r,this.requiredAttributes=o,this.options=s,this.cancelled=!1,this.loadShared=function(t){if(null==t.sharedResource)return n.resolve({});var i=a.makeAbsolute(t.sharedResource.href,t.baseUrl);return this.load(i,"json").then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t})}}return e.prototype.cancelAll=function(){this.cancelled=!0},e.prototype.load=function(e,t){var i=this;return n.create(function(r,n){i.loader.request(e,t).then(function(e){return r(e.data)},function(t){return n(t||new Error("Failed to load: "+e))})})},e.prototype.loadAttribute=function(e,t,i){var r=a.makeAbsolute(i,e);return this.load(r,"binary").then(function(e){return o.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t){var i=this,r=t.map(function(t){return null==e.attributeData||null==e.attributeData[t.index]?(i.logger.error("Missing attributeData for '"+t.name+"' on node '"+e.id+"'"),n.resolve(null)):i.loadAttribute(e.baseUrl,t.attributeStorageInfo,e.attributeData[t.index].href).catch(function(r){return i.logger.error("Failed to load attributeData for '"+t.name+"' on node '"+e.id+"'"),null})});return n.all(r).then(function(e){for(var i={},r=0;r<t.length;++r)e[r]&&(i[t[r].name]=e[r]);return i})},e.prototype.prepareBinaryGeometryData=function(e,t,i,n){var a=e.geometries[0];if(r.mixin(a.params,i),n||null!=i.vertexAttributes.region||delete i.vertexAttributes.region,null!=i.featureAttributes){var l=i.featureAttributes;if(l.faceRange){var u=o.createTypedView(t,l.faceRange),d=l.faceRange.valuesPerElement,h=i.header.fields.featureCount;e.componentOffsets=s.convertFlatRangesToOffsets(u,h,d)}if(l.id){e.featureIds=[];var c=1,p=o.valueType2TypedArrayClassMap[l.id.valueType];"UInt64"===l.id.valueType&&(p=Uint32Array,c=2);for(var f=new p(t,l.id.byteOffset,l.id.count*l.id.valuesPerElement*c),y=0;y<i.header.fields.featureCount;y++)if(e.featureIds[y]=f[y*l.id.valuesPerElement*c],2===c){var g=f[y*l.id.valuesPerElement*c+1];if(g>=2097150)throw new Error("ID exceeded maximum range supported by javascript (max = 53bit-1 = 9007199254740991)");e.featureIds[y]+=4294967296*g}}}},e.prototype.loadBundleData=function(e,t){var i=this,r=null,s=this.loadShared(e),l=null;null!=this.requiredAttributes&&(l=this.loadAttributes(e,this.requiredAttributes));var u=null;if(null!=e.geometryData){var d=e.geometryData[t],h=a.makeAbsolute(d.href,e.baseUrl);u=this.load(h,"binary")}return s.then(function(a){return i.handleCancelled(),(i.options.loadFeatureData?i.loadFeatureData(e,t):n.resolve(null)).then(function(t){i.handleCancelled();var s,d=i.options.loadFeatureData?i.collectGeometries(e,t,a):i.meshPyramidGeometryData(e,a);s=null!=u?u.then(function(e){r=e;var t=Object.keys(a.materialDefinitions)[0],n=a.materialDefinitions[t].params.vertexRegions,s=o.createGeometryDataIndex(e,i.defaultGeometrySchema,n);return i.prepareBinaryGeometryData(d[0],e,s,n),d}):n.resolve(d);var h=i.loadTextures(d,a);return n.all([h,s,l])}).then(function(e){var t=e[0],n=e[1],o=e[2];i.handleCancelled();var s=null;return o&&(s={attributeData:o,loadedAttributes:i.requiredAttributes}),{allGeometryData:n,attributeDataInfo:s,geometryBuffer:r,sharedResource:a,textureData:t}})})},e.addAbsoluteHrefTexture=function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++)for(var o=0,s=i[n[r]].images;o<s.length;o++){var l=s[o];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return a.makeAbsolute(e,t)}):l.hrefConcat=a.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a;"data:"===(a=r.encoding[n]).substring(0,5)&&(r.encoding[n]=a.substring(5))}else"data:"===(a=r.encoding).substring(0,5)&&(r.encoding=a.substring(5))}},e.prototype.loadTexture=function(e,t,i,r){var n=this;return r===s.DDS_ENCODING_STRING?this.load(e,"binary").then(function(e){return n.handleCancelled(),{i3sTexId:t,data:e,encoding:r}}):this.load(e,"image").then(function(e){var a=e;if(n.handleCancelled(),i&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),s=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=o,l.height=s,l.getContext("2d").drawImage(e,0,0,o,s),a=l}return{i3sTexId:t,data:a,encoding:r}})},e.prototype.loadTextures=function(t,i){for(var r=[],a=0;a<t.length;a++){var o=t[a].geometries;if(null!=o)for(var u=0,d=o;u<d.length;u++){var h=d[u].params.textureID||"none";if("none"!==h){null!=i.textureDefinitions&&null!=i.textureDefinitions[h]||this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+h);var c=i.textureDefinitions[h];if(l.assert(void 0!==c,"geometry wants unknown texture "+h),0===c.images.length)continue;var p=c.images.length-1,f=c.images[p],y=this.options.textureFormat===e.TextureFormat.Compressed,g=this.options.textureFormat===e.TextureFormat.Downsampled,m=s.getAppropriateTextureEncoding(c.encoding,y),v=m>-1?c.encoding[m]:c.encoding,b=m>-1?f.hrefConcat[m]:f.hrefConcat;this.options.loadTextureData?r.push(this.loadTexture(b,h,g,v)):r.push({i3sTexId:h,encoding:v,data:null})}}}return n.all(r)},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,textureID:t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e,t,i){for(var r=[],n=0,a=t.featureData;n<a.length;n++){var o=a[n],s=o.geometries;if(null!=s)for(var l=0;l<s.length;l++){var u=o.geometries[l];r.push({featureIds:[o.id],featureDataPosition:o.position,geometries:[u]})}else null!=o.position&&r.push({featureIds:[o.id],featureDataPosition:o.position,geometries:null})}return r},e.prototype.loadFeatureData=function(e,t){var i=a.makeAbsolute(e.featureData[t].href,e.baseUrl);return this.load(i,"json")},e.prototype.handleCancelled=function(){if(this.cancelled)throw new i},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(u||(u={})),u}.apply(null,r))||(e.exports=n)},1711:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(4),i(3),i(54),i(36),i(31),i(383),i(178),i(102),i(1516),i(29),i(1523),i(51)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p){return function(){function e(e,t,i,n,a,s,l){void 0===l&&(l={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=n,this.elevationProvider=a,this.options=l,this._computedOBBs={},this._computedMBSs={},this._isNodeVisibleCached={},this.fp=h.frustum.create(),this._poi=r.vec3f64.create(),this._idleCamera=!0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=r.vec3f64.create(),this._tmp2=r.vec3f64.create(),this._tmp3=r.vec3f64.create(),this._tmp0=r.vec3f64.create(),this.supportedMetrics=["maxScreenThreshold","screenSpaceRelative","removedFeatureDiameter","distanceRangeFromDefaultCamera"],this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s),this.tmpPoint=new o({x:0,y:0,z:0,spatialReference:e})}return e.prototype.updateElevationInfo=function(e){this.invalidateCache(),null!=e?(this._elevationContext=new s,this._elevationContext.featureExpressionInfoContext=l.createContext(l.extractExpressionInfo(e,!1)),this._elevationContext.mixinApi(e)):this._elevationContext=null},e.prototype.updateCamera=function(e){h.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this._isNodeVisibleCached={},this.maxDistance=0},e.prototype.updateNode=function(e){delete this._isNodeVisibleCached[e]},e.prototype.setPointOfInterest=function(e){i.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.setCameraIdle=function(e){this._idleCamera!==e&&(this._idleCamera=e,this._isNodeVisibleCached={})},e.prototype.updateExtent=function(e){this.extent=e,this._isNodeVisibleCached={}},e.prototype.computeMbs=function(e){var t=this._computedMBSs[e.id];return t||(t=a.vec4f64.fromValues(e.mbs[0],e.mbs[1],e.mbs[2],-1),this._computedMBSs[e.id]=t),t[3]<0&&(n.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=u.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.computeObb=function(e){if(e.obb&&!(e.obb.halfSize[0]<0)){var t=this._computedOBBs[e.id];return t||((t=c.clone(e.obb)).halfSize[0]=-1,this._computedOBBs[e.id]=t),t.halfSize[0]<0&&(t.halfSize[0]=e.obb.halfSize[0],i.vec3.copy(t.center,e.obb.center),this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=e.obb.center[0],this.tmpPoint.y=e.obb.center[1],this.tmpPoint.z=e.obb.center[2],t.center[2]=u.computeElevation(this.elevationProvider,this.tmpPoint,this._elevationContext,this._renderCoordsHelper,null)),p.bufferToBuffer(t.center,this.indexSR,0,t.center,this.engineSR,0,1)),t}},e.prototype._isNodeVisible=function(e){var t=this.computeMbs(e);if(!this.isMBSinExtent(t))return!1;if(e.hasServiceOBB&&e.obb){var i=this.computeObb(e);return c.isVisible(i,this.fp)}return this.isMBSVisible(t)},e.prototype.isNodeVisible=function(e){return this._idleCamera?null!=this._isNodeVisibleCached[e.id]?this._isNodeVisibleCached[e.id]:(this._isNodeVisibleCached[e.id]=this._isNodeVisible(e),this._isNodeVisibleCached[e.id]):this._isNodeVisible(e)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;if(e.hasServiceOBB)return!0;var t=this.computeObb(e);return!t||c.isVisible(t,this.fp)},e.prototype.invalidateCache=function(e){if(null==e){for(var t=0,i=Object.keys(this._computedMBSs);t<i.length;t++){var r=i[t];this._computedMBSs[r][3]=-1}for(var n=0,a=Object.keys(this._computedOBBs);n<a.length;n++){r=a[n];this._computedOBBs[r].halfSize[0]=-1}}else this._computedMBSs[e]&&(this._computedMBSs[e][3]=-1),this._computedOBBs[e]&&(this._computedOBBs[e].halfSize[0]=-1)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==d.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return h.frustum.intersectsSphere(this.fp.planes,h.sphere.wrap(e[3],e))},e.prototype.calcScreenSpaceSize=function(e,t){var r=this.computeMbs(e),n=i.vec3.squaredDistance(r,this._camPos),a=r[3];this.maxDistance=Math.max(this.maxDistance,Math.sqrt(n)-a);var o=n-a*a;return o<0?.5*Number.MAX_VALUE:t/Math.sqrt(o)*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){var t=this.computeMbs(e),r=i.vec3.distance(t,this._camPos)-t[3];return this.maxDistance=Math.max(this.maxDistance,r),r},e.prototype.calcAngleDependentLoD=function(e){var t=this.computeMbs(e),r=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/i.vec3.length(t)+r)/i.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return null!=e.lodSelection},e.prototype.hasFeatures=function(e){return null!=e.featureData},e.prototype.getDistancePlanarMode=function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,o=t[3];if(a<=o*o)return Math.abs(n);var s=Math.sqrt(a)-o;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var r=i.vec3.length(t),n=i.vec3.length(e)-r;i.vec3.scale(this._tmp0,e,i.vec3.dot(e,t)/i.vec3.squaredLength(e));var a=i.vec3.squaredDistance(t,this._tmp0),o=t[3];if(a<=o*o)return Math.abs(n);var s=i.vec3.scale(this._tmp0,t,1/r),l=r,u=o*o/2/l,d=i.vec3.scale(this._tmp1,s,l-u),h=e,c=i.vec3.subtract(this._tmp2,h,d),p=i.vec3.subtract(this._tmp2,c,i.vec3.scale(this._tmp3,s,i.vec3.dot(s,c))),f=i.vec3.add(this._tmp2,d,i.vec3.scale(this._tmp2,p,o/i.vec3.length(p))),y=i.vec3.distance(h,f);if(n>=2e5){var g=i.vec3.subtract(this._tmp1,h,f),m=i.vec3.dot(g,s)/i.vec3.length(g);m<.08&&(m=1e-4),y/=m}return y},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._selectErrorMetric=function(e){for(var t=0;t<e.length;t++)if(this.supportedMetrics.indexOf(e[t].metricType)>=0)return e[t];return null},e.prototype.getLodLevel=function(e){if(!e.lodSelection||e.lodSelection.length<=0||!1===this.hasFeatures(e))return 0;if(null==e.children||0===e.children.length)return this.maxLodLevel;var t=this._selectErrorMetric(e.lodSelection);if(null==t)return 0;if(this.progressiveLoadFactor<1){var i=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,i,t)?this.evaluateLODmetric(e,r,t)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias,t)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t,i){switch(i.metricType){case"screenSpaceRelative":var r=this.computeMbs(e),n=this.getDistance(this._camPos,r),a=2*n/this._screenSizeFactor;return this.maxDistance=Math.max(this.maxDistance,n),i.maxError*t<=a;case"maxScreenThreshold":var o=this.calcScreenSpaceSize(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(o*=this.calcAngleDependentLoD(e)),o<i.maxError;case"removedFeatureDiameter":return this.calcScreenSpaceSize(e,i.maxError)*t<10;case"distanceRangeFromDefaultCamera":return this.calcCameraDistance(e)>i.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.computeMbs(e);return i.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return i.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,r))||(e.exports=n)},1712:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(13),i(9),i(128),i(1464)],void 0===(n=function(e,t,i,r,n,a){return function(){function e(e,t,i){this._layer=e,this._support=t,this._options=i}return e.prototype.queryExtent=function(e){var t=this;return this._rejectUnsupported(e).then(function(){var i=0,r=t._support.createExtentBuilder();return t._forAllQueried(e,function(e){i++,r.add(e)}),{count:i,extent:0===i?null:r.getExtent()}})},e.prototype.queryFeatureCount=function(e){var t=this;return this._rejectUnsupported(e).then(function(){var i=0;return t._forAllQueried(e,function(){return i++}),i})},e.prototype.queryFeatures=function(e){var t=this;return this._rejectUnsupported(e).then(function(){var n=[],a=e&&e.outFields,o=[];return t._forAllQueried(e,function(e){return o.push(t._support.createGraphic(e))},function(e){a&&(n.push(t._support.requestFields(e,o,a)),o=[])})>0&&!e.num?r.reject(new i("Unsupported Query","Large feature query, use Query.num and Query.start to batch")):(a||n.push(r.resolve(o)),r.all(n))}).then(function(e){for(var i=[],r=0;r<e.length;++r)for(var o=e[r],s=0;s<o.length;++s)i.push(n.hydrateGraphic(o[s],t._layer));var l=new a;return l.features=i,l})},e.prototype.queryObjectIds=function(e){var t=this;return this._rejectUnsupported(e).then(function(){var i=[];return t._forAllQueried(e,function(e){return i.push(e.id)}),i})},e.defaultExtentBuilder=function(e){var t=null;return{add:function(i){var r=e(i);r&&(t=null!=t?t.union(r):r.clone())},getExtent:function(){return t}}},e.prototype._forAllQueried=function(e,t,i){var r=[];if(e&&e.objectIds){var n=e.objectIds;r.push(function(e){return n.indexOf(e.id)>=0})}var a=e&&e.start||0,o=e&&e.num||1e4;return r.push(function(){return o<=0?(--o,!1):a>0?(--a,!1):(--o,!0)}),this._support.forAll(function(e){for(var i=0,n=r;i<n.length;i++)if(!(0,n[i])(e))return;t(e)},i),Math.max(0,-o)},e.prototype._rejectUnsupported=function(e){if(null==e)return r.resolve();var t=function(e){return r.reject(new i("Unsupported Query","Unsupported property '"+e+"'"))};return null!=e.distance?t("distance"):null!=e.geometryPrecision?t("geometryPrecision"):e.groupByFieldsForStatistics&&e.groupByFieldsForStatistics.length?t("groupByFieldsForStatistics"):null!=e.maxAllowableOffset?t("maxAllowableOffset"):e.multipatchOption?t("multipatchOption"):e.orderByFields&&e.orderByFields.length?t("orderByFields"):e.outSpatialReference?t("outSpatialReference"):e.outStatistics&&e.outStatistics.length?t("outStatistics"):e.pixelSize?t("pixelSize"):e.quantizationParameters?t("quantizationParameters"):e.relationParameter?t("relationParameter"):e.returnDistinctValues?t("returnDistinctValues"):e.text?t("text"):e.timeExtent?t("timeExtent"):e.where?t("where"):e.geometry?t("geometry"):!this._options.enableOutFields&&e.outFields&&e.outFields.length?t("outFields"):!this._options.enableObjectId&&e.objectIds&&e.objectIds.length?t("objectIds"):r.resolve()},e}()}.apply(null,r))||(e.exports=n)},1713:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(22),i(25),i(13),i(32),i(9),i(0),i(127),i(1507),i(1526)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c){Object.defineProperty(t,"__esModule",{value:!0});var p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype._validateFetchPopupFeatures=function(e){var t=this.layer;return t.popupEnabled?c.getFetchPopupTemplate(t,e)?void 0:new o("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new o("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})},t.prototype.fetchPopupFeatures=function(e,t){return a(this,void 0,void 0,function(){var e,i,r,a,o,u,h,p,f,y;return n(this,function(n){switch(n.label){case 0:return(e=this._validateFetchPopupFeatures(t))?[2,l.reject(e)]:(i=s.isSome(t)?t.clientGraphics:null)&&0!==i.length?(r=[],a=[],u=d.unpackFieldNames,h=[this.layer.fields],[4,c.getRequiredFields(this.layer,c.getFetchPopupTemplate(this.layer,t))]):[2,l.resolve([])];case 1:for(o=u.apply(void 0,h.concat([n.sent()])),p=0,f=i;p<f.length;p++)y=f[p],d.featureHasFields(o,y)?r.push(y):a.push(y);return 0===a.length?[2,l.resolve(r)]:[2,this.whenGraphicAttributes(a,o).catch(function(){return a}).then(function(e){return r.concat(e)})]}})})},r([u.subclass("esri.views.3d.layers.support.PopupSceneLayerView")],t)}(u.declared(h));t.PopupSceneLayerView=p,t.default=p}.apply(null,r))||(e.exports=n)},2250:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(2),i(1),i(22),i(25),i(154),i(170),i(79),i(52),i(19),i(10),i(88),i(9),i(21),i(0),i(3),i(1558),i(45),i(37),i(158),i(128),i(1706),i(127),i(1636),i(1507),i(1637),i(1696),i(1712),i(1516),i(1643),i(1514),i(1713),i(2251),i(1523),i(51),i(556)],void 0===(n=function(e,t,i,r,n,a,o,s,l,u,d,h,c,p,f,y,g,m,v,b,_,x,w,S,C,I,E,D,F,V,O,P,M,G,R,N,A){function T(e,t){for(var i=0;i<e.length;i++)for(var r=0,n=e[i].graphics;r<n.length;r++){var a=n[r];if(a.attributes||(a.attributes={}),t.loadedAttributes)for(var o=0,s=t.loadedAttributes;o<s.length;o++){var l=s[o].name;t.attributeData[l]&&(a.attributes[l]=V.getCachedAttributeValue(t.attributeData[l],i))}}}var L=h.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),j=function(e){function t(t){var i=e.call(this)||this;return i._nodesAddedToStage=new Map,i.overlayUpdating=!1,i.supportsDraping=!0,i._queryEngine=null,i._memCache=null,i.loadedGraphics=new G.GraphicsMap,i.progressiveLoadFactor=1,i.supportsHeightUnitConversion=!0,i._coordinatesOutsideExtentErrors=0,i._maxCoordinatesOutsideExtentErrors=20,i}return i(t,e),t.prototype.initialize=function(){var e=this;V.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this.handles.add([f.init(this,["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields"],function(){return e._updateRequiredFields()}),f.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),this.layer.watch("renderer",function(t,i){return e._rendererChange(t,i)}),this.watch(["layer.objectIdFilter","parsedDefinitionExpression"],function(){return e._filterChange()})]),this._set("graphics3d",new E({owner:this,layer:this.layer,asyncGraphicsUpdates:!0,scaleVisibilityEnabled:!1,filterVisibilityEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(t){return e._updateClippingExtent(t)},queryGraphicUIDsInExtent:function(t,i,r){return e._queryGraphicUIDsInExtent(t,i,r)}})),this.supportsHeightUnitConversion&&(this._verticalScale=new D({sourceSpatialReference:this.layer.spatialReference,destSpatialReference:this.view.spatialReference})),this.addResolvingPromise(this.graphics3d.setup()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid),this._controller=new w({layerView:this}),this.when(function(){e.handles.add([f.init(e,"maximumNumberOfFeatures",function(t){return e._controller.featureTarget=t}),f.whenTrue(e,"suspended",function(){return e._removeAllNodeData()})])})},t.prototype.destroy=function(){this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null)),this._controller&&(this._controller.destroy(),this._controller=null),this._memCache.destroy(),this._memCache=null,this._elevationUpdateNodes=null,this._nodesAddedToStage=null},Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!this.suspended&&!!this._controller&&!this._controller.leafsReached},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var i=this;return V.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,function(e){for(var t=new Map,r=[],n=0,a=e;n<a.length;n++){var o=a[n],s=i._findGraphicNodeAndIndex(o),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},r.push(l)),l.indices.push(s.index),l.graphics.push(o)}return r},{ignoreUnavailableFields:!0,populateObjectId:!0})},t.prototype.getGraphicFromGraphicUid=function(e){if(!this.loadedGraphics)return null;var t=x.hydrateGraphic(this.loadedGraphics.find(function(t){return t.uid===e}),this.layer),i=this._getObjectIdField();return t&&t.attributes&&t.attributes[i]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null},t.prototype.whenGraphicBounds=function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this.overlayUpdating||this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating},t.prototype.getRenderingInfo=function(e,t){var i=C.getRenderingInfo(e,{renderer:t});if(i&&i.color){var r=i.color;r[0]=r[0]/255,r[1]=r[1]/255,r[2]=r[2]/255}return i},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0}),t.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],i=0,r=u.keysOfMap(this._nodesAddedToStage);i<r.length;i++){var n=r[i],a=this._nodesAddedToStage.get(n),o=this._findGraphicIndex(a.bundle,t);if(o>=0)return{node:this._controller.getNode(n),index:o}}return null},t.prototype._forAllFeatures=function(e,t){this._nodesAddedToStage.forEach(function(i,r){for(var n=i.bundle,a=0;a<n.length;a++)for(var o=n[a].graphics,s=0;s<o.length;s++){var l=o[s],u=n[a].featureIds[s];l.visible&&e(u,a,l)}null!=t&&t({nodeId:r})})},t.prototype._getGraphicIndices=function(e,t){for(var i=this._nodesAddedToStage.get(e),r=this._getObjectIdField(),n=[],a=0,o=t;a<o.length;a++){var s=o[a].attributes[r],l=this._findGraphicIndex(i.bundle,s);l>=0&&n.push(l)}return n},t.prototype._findGraphicIndex=function(e,t){for(var i=0;i<e.length;i++)for(var r=0,n=e[i].featureIds;r<n.length;r++){if(n[r]===t)return i}return-1},t.prototype._queryGraphicUIDsInExtent=function(e,t,i){if(this._controller){var r=this._controller.crsIndex;N.boundingRectToBoundingRect(e,t,q,r);var n=z;v.fromRect(n,q),n[2]=-1/0,n[5]=1/0,null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new c);var a=this._elevationUpdateNodes;this._controller.updateElevationChanged(n,r,a);for(var o=0;o<a.length;o++){var s=a.data[o],l=this._nodesAddedToStage.get(s.id);if(null!=l){if(!l.spatialIndex&&l.bundle.length>=B){var u=new m.PooledRBush(9,d("csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]);H.length=0;for(var h=0,p=l.bundle;h<p.length;h++){for(var f=p[h],y=b.empty(),g=0,_=f.graphics;g<_.length;g++){var w=_[g];x.expandAABR(w.geometry,y)}f.extent=y,H.push(f)}u.load(H),l.spatialIndex=u}if(l.spatialIndex){var S=q;N.boundingRectToBoundingRect(e,t,q,this.view.spatialReference),Q.minX=S[0],Q.minY=S[1],Q.maxX=S[2],Q.maxY=S[3],l.spatialIndex.search(Q,function(e){for(var t=0,r=e.graphics;t<r.length;t++){var n=r[t];i(n.uid)}})}else for(var C=0,I=l.bundle;C<I.length;C++)for(var E=0,D=(f=I[C]).graphics;E<D.length;E++){w=D[E];i(w.uid)}}}}},t.prototype.highlight=function(e,t){return void 0===t&&(t={}),this.graphics3d.highlight(e,t,this.layer.objectIdField)},t.prototype.addNodeData=function(e,t){if(!this._nodesAddedToStage.has(e.id)){for(var i=t.allGeometryData,r=t.attributeDataInfo,n=this._controller.crsIndex,a=this.view.spatialReference,o=[0,0,0],s=this._getObjectIdField(),u=[],d=this.layer.fullExtent&&function(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}(this.layer.fullExtent.clone(),.5),h=[],c=[],f=0;f<i.length;f++){var y=i[f],g=y.featureDataPosition,m=g.length,v=y.geometries||[U[m]],b=y.featureIds;d&&!_.extentContainsCoords3D(d,g)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&L.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&L.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var w=0;w<v.length;w++){var S=v[w];if("points"===S.params.type){var C=[],I=b[w<b.length?w:0],E={};null!=I&&(E[s]=I);var D=null==I?l.generateUID():I,F=void 0;"Embedded"===S.type&&(F=S.params.vertexAttributes.position);for(var V=0;V<F.length;V+=m){for(var O=0;O<m;O++)o[O]=g[O]+F[V+O];N.bufferToBuffer(o,n,0,k,a,0,1);var P=x.makeDehydratedPoint(k[0],k[1],k[2],a);m<3&&(P.z=void 0),C.push({uid:D,geometry:P,attributes:E,visible:!0}),e.obb||c.push(P.x,P.y,P.z?P.z:0)}h.push.apply(h,C),u.push({featureIds:y.featureIds,graphics:C})}}}e.numFeatures=h.length,this._updateNodeMemory(e);var M={bundle:u,attributeInfo:r};if(T(M.bundle,M.attributeInfo),c.length>0){var G=this.view.renderSpatialReference,A=this._controller.crsVertex;N.bufferToBuffer(c,a,0,c,G,0,c.length/3);var j={data:c,size:3,offsetIdx:0,strideIdx:3};e.obb=R.compute(j),N.vectorToVector(e.obb.center,G,e.obb.center,A),this._controller.updateVisibility(e.id)}return this._controller.isGeometryVisible(e)?(this._verticalScale&&this._verticalScale.adjust(h),this._nodesAddedToStage.set(e.id,M),this.loadedGraphics.addMany(h),this._filterNode(M),p.resolve()):(this._cacheNodeData(e.id,M),p.resolve())}L.error("I3S node "+e.id+" already added")},t.prototype.isNodeLoaded=function(e){return this._nodesAddedToStage.has(e.id)},t.prototype._updateNodeMemory=function(e){e.memory=4096+e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic},t.prototype._cacheNodeData=function(e,t){var i=t.bundle.reduce(function(e,t){return t.graphics.reduce(function(e,t){return x.estimateSize(t)+e},512+8*t.featureIds.length+e)},1024);this._memCache.put(e,t,i)},t.prototype._removeAllNodeData=function(){var e=this;this._nodesAddedToStage.forEach(function(t,i){if(t){var r=e._controller.getNode(i);e._updateNodeMemory(r),e._cacheNodeData(i,t)}}),this._nodesAddedToStage.clear(),this.loadedGraphics.clear()},t.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var i=e.pop(),r=this._removeNodeStageData(i);r&&(this._updateNodeMemory(i),this._cacheNodeData(i.id,r)),t.madeProgress()}},t.prototype._removeNodeStageData=function(e){var t=this._nodesAddedToStage.get(e.id);if(!t)return null;for(var i=0,r=t.bundle;i<r.length;i++){var n=r[i];this.loadedGraphics.removeMany(n.graphics)}return this._nodesAddedToStage.delete(e.id),t},t.prototype.loadCachedNodeData=function(e,t){return p.resolve(this._memCache.pop(e.id))},t.prototype.addCachedNodeData=function(e,t,i){if(!this._nodesAddedToStage.has(e.id)){for(var r=0,n=t.bundle;r<n.length;r++){var a=n[r];this.loadedGraphics.addMany(a.graphics)}return this._nodesAddedToStage.set(e.id,t),this._updateNodeMemory(e),this.setAttributeData(e,i),this._filterNode(t),p.resolve()}L.error("I3S node "+e.id+" already added")},t.prototype.getLoadedNodeIDs=function(){return u.keysOfMap(this._nodesAddedToStage)},t.prototype.getLoadedAttributes=function(e){var t=this._nodesAddedToStage.get(e.id);if(t)return t.attributeInfo.loadedAttributes},t.prototype.getAttributeData=function(e){var t=this._nodesAddedToStage.get(e.id);if(t)return t.attributeInfo.attributeData},t.prototype.setAttributeData=function(e,t){var i=this._nodesAddedToStage.get(e.id);if(i&&(i.attributeInfo=t,T(i.bundle,t),this._filterNode(i),this.graphics3d.graphicsCore.labelsEnabled)){var r=i.bundle.map(function(e){return e.graphics.length&&e.graphics[0].uid});this.graphics3d.graphicsCore.updateLabelingInfo(r)}},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){return a(this,void 0,void 0,function(){var i,r,a,l;return n(this,function(n){switch(n.label){case 0:return i=this.layer.fields,r=new s.default,e?[4,e.collectRequiredFields(r,i)]:[3,2];case 1:return n.sent(),a=o.from(r).sort(),[3,3];case 2:a=[],n.label=3;case 3:return r.clear(),t?[4,t.collectRequiredFields(r,i)]:[3,5];case 4:return n.sent(),l=o.from(r).sort(),[3,6];case 5:l=[],n.label=6;case 6:return a.length===l.length&&a.every(function(e,t){return a[t]===l[t]})?[2]:(this._reloadAllNodes(),[2])}})})},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&L.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype._filterChange=function(){var e=this;this._nodesAddedToStage.forEach(function(t){return e._filterNode(t)})},t.prototype._reloadAllNodes=function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()},t.prototype._filterNode=function(e){var t=this._getObjectIdField(),i=null;if(this.layer.objectIdFilter){var r=this.layer.objectIdFilter.ids,n="include"===this.layer.objectIdFilter.method;i=function(e){return r.indexOf(e)>=0===n}}for(var a=this.parsedDefinitionExpression,o=0,s=e.bundle;o<s.length;o++)for(var l=0,u=s[o].graphics;l<u.length;l++){var d=u[l],h=d.visible;i&&!i(d.attributes[t])?d.visible=!1:d.visible=!a||this._evaluateClause(a,d),h!==d.visible&&(Y.graphic=d,Y.property="visible",Y.oldValue=h,Y.newValue=d.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(Y))}},t.prototype._updateRequiredFields=function(){return a(this,void 0,void 0,function(){var e,t,i,r,a,l,u,d;return n(this,function(n){switch(n.label){case 0:return t=(e=this).layer,i=e.layer,r=i.fields,a=i.renderer,l=i.labelsVisible,u=e.definitionExpressionFields,d=new s.default,a?[4,a.collectRequiredFields(d,r)]:[3,2];case 1:n.sent(),n.label=2;case 2:return l?[4,S.collectLabelingFields(d,t)]:[3,4];case 3:n.sent(),n.label=4;case 4:return S.collectFields(d,r,u),this._set("requiredFields",o.from(d).sort()),[2]}})})},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,graphic:null},i=this;return new F(this.layer,{forAll:function(i,r){e._forAllFeatures(function(e,r,n){t.id=e,t.index=r,t.graphic=n,i(t)},r)},createGraphic:function(e){return x.hydrateGraphic(e.graphic,i.layer)},requestFields:function(t,i,r){return V.whenGraphicAttributes(e.layer,i,e._getObjectIdField(),r,function(i){var r=e._getGraphicIndices(t.nodeId,i);return[{node:e._controller.getNode(t.nodeId),indices:r,graphics:i}]},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var t=v.empty(),i=e.layer.spatialReference;return{add:function(e){return x.expandAABB(e.graphic.geometry,t)},getExtent:function(){return v.toExtent(t,i)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0},t.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))},t.prototype.ignoresMemoryFactor=function(){return this._controller&&this._controller.fixedFeatureTarget},t.prototype.getNumberOfNodes=function(){return this._nodesAddedToStage.size},t.prototype.getNumberOfFeatures=function(){return this.loadedGraphics.length},t.prototype.getStats=function(){var e=this.graphics3d.graphicsCore.getStats();return e.nodes=this.getNumberOfNodes(),e.features=this.loadedGraphics.length,this._controller&&this._controller.updateStats(e),e},r([y.property()],t.prototype,"graphics3d",void 0),r([y.property()],t.prototype,"drawingOrder",void 0),r([y.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],t.prototype,"hasDraped",void 0),r([y.property({type:Boolean})],t.prototype,"overlayUpdating",void 0),r([y.property({type:Boolean})],t.prototype,"supportsDraping",void 0),r([y.property({type:A})],t.prototype,"filter",void 0),r([y.property()],t.prototype,"loadedGraphics",void 0),r([y.property()],t.prototype,"layer",void 0),r([y.property()],t.prototype,"_controller",void 0),r([y.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],t.prototype,"updating",void 0),r([y.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),r([y.property(P.updatingPercentage)],t.prototype,"updatingPercentage",void 0),r([y.property({aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),r([y.property({readOnly:!0})],t.prototype,"requiredFields",void 0),r([y.property({type:Number,dependsOn:["graphics3d.graphicsCore.displayFeatureLimit"]})],t.prototype,"maximumNumberOfFeatures",null),r([y.property({readOnly:!0,dependsOn:["suspended","_controller.leafsReached"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),r([y.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],t.prototype,"lodFactor",void 0),r([y.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(y.declared(I,M.PopupSceneLayerView,O.DefinitionExpressionSceneLayerView)),U={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},B=100,q=b.create(),z=v.create(v.POSITIVE_INFINITY),Q={minX:0,minY:0,maxX:0,maxY:0},k=g.vec3f64.create(),H=[],Y={graphic:null,property:null,oldValue:null,newValue:null};return j}.apply(null,r))||(e.exports=n)},2251:function(e,t,i){var r,n;r=[i.dj.c(e.i),t,i(5),i(546),i(138)],void 0===(n=function(e,t,i,r,n){Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._map=new r.default,t}return i(t,e),t.prototype.clear=function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}},Object.defineProperty(t.prototype,"length",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.addMany=function(e){if(0!==e.length){for(var t=new Set,i=0,r=e;i<r.length;i++){var n=r[i],a=n.uid;this._map.has(a)?(t.add(a),++this._map.get(a).refCount):(n.refCount=1,this._map.set(a,n))}var o=t.size>0?e.filter(function(e){return!t.has(e.uid)}):e;this.emit("change",{added:o,removed:[]})}},t.prototype.removeMany=function(e){for(var t=[],i=0,r=e;i<r.length;i++){var n=r[i],a=n.uid,o=this._map.get(a);null!=o&&--o.refCount<=0&&this._map.delete(a)&&t.push(n)}t.length>0&&this.emit("change",{added:[],removed:t})},t.prototype.toArray=function(){var e=new Array(this._map.size),t=0;return this._map.forEach(function(i){return e[t++]=i}),e},t.prototype.find=function(e){for(var t=this._map.entries(),i=t.next();!i.done;i=t.next())if(e(i.value[1]))return i.value[1]},t.prototype.forEach=function(e){this._map.forEach(function(t){return e(t)})},t}(n.Evented);t.GraphicsMap=a}.apply(null,r))||(e.exports=n)}}]);